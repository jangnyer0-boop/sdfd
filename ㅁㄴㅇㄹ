# -*- coding: utf-8 -*-
"""
ë¸”ë¡œê·¸ ë°œí–‰ í´ë”ë§ (Tkinter GUI)
ìš”êµ¬ì‚¬í•­ ë°˜ì˜:
- ë²„íŠ¼ ì¬ë°°ì¹˜: [ì œëª©+ê°ìƒ‰], [ëŒ€í‘œì‚¬ì§„/ì œí’ˆì‚¬ì§„ í´ë”ë§] ì¢Œì¸¡ / [ì„ì‹œ] ë¸”ë¡œê·¸ ê¸€ í¬ë¡¤ë§, [ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt ì‚­ì œ] ìš°ì¸¡
- [ì œëª©+ê°ìƒ‰] : ì—‘ì…€ â†’ í´ë” ìƒì„± â†’ ë¸”ë¡œê·¸ ë³¸ë¬¸ í¬ë¡¤ë§ â†’ GPT ê°ìƒ‰ â†’ 'ë°œí–‰.txt' ìƒì„±(ì œëª© 3ì¤„ + ë¹ˆì¤„ + ê°ìƒ‰ë¬¸)
  Â· í´ë”ì— 'ë°œí–‰.txt' ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µí•˜ê³  ì•Œë ¤ì¤Œ
  Â· API Key/ì§€ì¹¨ì„ GUIì—ì„œ ì…ë ¥ë°›ì•„ gpt_config.jsonì— ì €ì¥/ë¡œë“œ
- ê¸°ì¡´ ê¸°ëŠ¥(ëŒ€í‘œ/ì œí’ˆ í´ë”ë§, ì„ì‹œ í¬ë¡¤ë§, ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt ì‚­ì œ)ì€ ìœ ì§€

ì—‘ì…€(A:ë‚ ì§œ, B:í‚¤ì›Œë“œ, H:ë¸”ë¡œê·¸ëª…(ì•„ì´ë””), J:ì œí’ˆìˆ˜ëŸ‰, K:ì œëª©, L:URL)
ëŒ€ìƒí´ë”: Z:\ë¯¸ë“œë¸Œë¡œ\â¤ ë§ˆì¼€íŒ…\ë¸”ë¡œê·¸ ê°ìƒ‰ ë° ì—…ë¡œë“œ\ê°ˆë¼431\YY.MM.DD\<ë¸”ë¡œê·¸ë³„í´ë”>\Bì—´í‚¤ì›Œë“œ
"""

import os
import io
import re
import sys
import json
import random
import shutil
import datetime
import traceback

# GUI/Tk
import tkinter as tk
from tkinter import ttk, filedialog, scrolledtext, messagebox

# Excel
from openpyxl import load_workbook

# Web crawling
import requests
from bs4 import BeautifulSoup

# OpenAI (ì‹  SDK)
from openai import OpenAI

# ============ ê³ ì • ê²½ë¡œ ============ #
BASE_ROOT = r"Z:\ë¯¸ë“œë¸Œë¡œ\â¤ ë§ˆì¼€íŒ…\ë¸”ë¡œê·¸ ê°ìƒ‰ ë° ì—…ë¡œë“œ\ê°ˆë¼431"
PRODUCT_SRC = os.path.join(BASE_ROOT, "ê°ˆë¼431 (ë¯¸ì‚¬ìš©)")
REP_SRC = os.path.join(BASE_ROOT, "ëŒ€í‘œì´ë¯¸ì§€(ë¯¸ì‚¬ìš©)")

# ============ ë¸”ë¡œê·¸ í´ë”ëª… ë§¤í•‘============ #
BLOG_FOLDER_NAME_BY_ID = {
    "wet4448":   "0 ë·°í‹°ìµœê³  wet4448",
    "disappear13006":    "1 ì´‰ì´‰ì¼ê¸° disappear13006",
    "scold10151":  "2 ê³„ë‹¨íƒ€ê¸° scold10151",
    "affair5459":  "3 ì¼ë‹¨ì‹œì‘ affair5459",
    "reserve1047": "5 ë…¸ë ¥ì²œì¬ reserve1047",
    "scarce8501":  "6 ê¸€ë¡œìš°í• scarce8501",
    "withpiano001":"7 ìŠ¬ë¦¼ì¡°ì´ withpiano001",
    "pepper634":   "8 ë·°í‹°ë…¸íŠ¸ pepper634",
    "kbshb72":     "9 ì‚´ì½¤ë‹¬ì½¤ kbshb72",
    "beauty13365": "10 ë·°í‹°ìš”ì • beauty13365",
    "heoangel731": "11 ê±´ê°•ìš”ì • heoangel731",
}

# ============ ìœ í‹¸ ============ #
IMG_EXTS = {".jpg", ".jpeg", ".png", ".webp", ".bmp", ".tif", ".tiff"}
TS_NAME_RE = re.compile(
    r"^\d{4}-\d{2}-\d{2} \d{2};\d{2};\d{2}\.(jpg|jpeg|png|webp|bmp|tif|tiff)$",
    re.IGNORECASE,
)

INVALID_FN_CHARS = r'\/:*?"<>|\n\r\t'
INVALID_FN_RE = re.compile(f"[{re.escape(INVALID_FN_CHARS)}]")

def is_image_file(path: str) -> bool:
    return os.path.splitext(path)[1].lower() in IMG_EXTS

def list_images(dirpath: str):
    try:
        return [os.path.join(dirpath, f) for f in os.listdir(dirpath)
                if is_image_file(os.path.join(dirpath, f))]
    except Exception:
        return []

def ensure_folder(path: str):
    os.makedirs(path, exist_ok=True)

def parse_blog_cell(cell_text: str):
    """
    'ê±´ê°•ìš”ì •(heoangel731)' â†’ ('ê±´ê°•ìš”ì •', 'heoangel731')
    """
    s = str(cell_text or "").strip()
    m = re.match(r"^(.*)\(([^)]+)\)\s*$", s)
    if m:
        name = m.group(1).strip()
        bid = m.group(2).strip()
    else:
        name, bid = s, ""
    return name, bid

def to_date_folder(v, fallback_year=None):
    """
    Aì—´ ì˜ˆì‹œ '10/28' â†’ '25.10.28' (ì˜¬í•´ ê¸°ì¤€)
    """
    now = datetime.datetime.now()
    y = fallback_year or now.year
    try:
        if isinstance(v, datetime.datetime):
            d = v
        else:
            s = str(v).strip()
            d = datetime.datetime.strptime(s, "%m/%d").replace(year=y)
        return d.strftime("%y.%m.%d")
    except Exception:
        s = str(v or "").strip().replace("/", ".").replace("-", ".")
        if len(s) == 5:  # '10/28'
            try:
                d = datetime.datetime.strptime(s, "%m.%d").replace(year=y)
                return d.strftime("%y.%m.%d")
            except Exception:
                pass
        return s or now.strftime("%y.%m.%d")

def choose_blog_folder_name(blog_name: str, blog_id: str):
    if blog_id and blog_id in BLOG_FOLDER_NAME_BY_ID:
        return BLOG_FOLDER_NAME_BY_ID[blog_id]
    return f"{blog_name} {blog_id}".strip()

def count_rep_in_folder(dirpath: str) -> int:
    cnt = 0
    try:
        for f in os.listdir(dirpath):
            if TS_NAME_RE.match(f):
                cnt += 1
    except Exception:
        pass
    return cnt

def count_product_in_folder(dirpath: str) -> int:
    cnt = 0
    try:
        for f in os.listdir(dirpath):
            fp = os.path.join(dirpath, f)
            if not is_image_file(fp):
                continue
            if TS_NAME_RE.match(f):  # ëŒ€í‘œì‚¬ì§„ì€ ì œì™¸
                continue
            cnt += 1
    except Exception:
        pass
    return cnt

def unique_target_path(dst_dir: str, base_name: str, ext: str) -> str:
    ensure_folder(dst_dir)
    target = os.path.join(dst_dir, base_name + ext)
    i = 1
    while os.path.exists(target):
        target = os.path.join(dst_dir, f"{base_name}_{i}{ext}")
        i += 1
    return target

def move_with_rename(src: str, dst_dir: str):
    name, ext = os.path.splitext(os.path.basename(src))
    dst = unique_target_path(dst_dir, name, ext)
    shutil.move(src, dst)
    return dst

def generate_timestamp_name(ext: str = ".jpg"):
    now = datetime.datetime.now()
    return now.strftime("%Y-%m-%d %H;%M;%S") + ext

def safe_filename_from_title(title: str, default_name: str = "ì œëª©ì—†ìŒ", max_len: int = 120) -> str:
    t = (title or "").strip()
    t = re.sub(r"\s+", " ", t)
    t = INVALID_FN_RE.sub("", t)
    t = t.strip(" .")
    if not t:
        t = default_name
    if len(t) > max_len:
        t = t[:max_len].rstrip()
    return t

# ============ ì—‘ì…€/ë¡œìš° ë¡œë”© ============ #
def read_rows_from_excel(xlsx_path: str, logger):
    wb = load_workbook(xlsx_path, data_only=True)
    ws = wb.active
    rows = []
    for r in ws.iter_rows(min_row=1, values_only=True):
        if r is None or len(r) < 12:  # Lê¹Œì§€ ì½ìŒ -> ìµœì†Œ 12ê°œ
            continue
        A, B = r[0], r[1]
        H, J, K, L = r[7], r[9], r[10], r[11]
        if (A is None and B is None and H is None and J is None and K is None and L is None):
            continue

        blog_name, blog_id = parse_blog_cell(H)
        try:
            need_products = int(J) if J is not None else 0
        except Exception:
            need_products = 0

        rows.append({
            "date_folder": to_date_folder(A),
            "keyword_folder": str(B or "").strip(),
            "blog_name": blog_name,
            "blog_id": blog_id,
            "need_products": max(0, need_products),
            "title": str(K or "").strip(),
            "url": str(L or "").strip(),
        })
    logger(f"â„¹ï¸ [ì—‘ì…€] ì´ {len(rows)}í–‰ ë¡œë“œ")
    return rows

# ============ PLAN (ì‚¬ì§„ ë°°ë¶„ ê³„íš) ============ #
def plan_allocation(rows, logger):
    missing = [i+1 for i, r in enumerate(rows) if not r["title"]]
    if missing:
        msg = f"ì œëª©(Kì—´) ëˆ„ë½ í–‰: {missing[:10]}{'...' if len(missing) > 10 else ''}"
        return False, msg

    details = []
    total_add_prod = 0
    total_add_rep = 0
    for r in rows:
        blog_folder = choose_blog_folder_name(r["blog_name"], r["blog_id"])
        dest_dir = os.path.join(BASE_ROOT, r["date_folder"], blog_folder, r["keyword_folder"])
        ensure_folder(dest_dir)
        cur_prod = count_product_in_folder(dest_dir)
        cur_rep = count_rep_in_folder(dest_dir)
        need_prod = max(0, r["need_products"] - cur_prod)
        need_rep = 0 if cur_rep >= 1 else 1

        total_add_prod += need_prod
        total_add_rep += need_rep
        details.append({**r, "dest_dir": dest_dir, "cur_prod": cur_prod,
                        "cur_rep": cur_rep, "need_prod": need_prod, "need_rep": need_rep})

    prod_pool = list_images(PRODUCT_SRC)
    rep_pool = list_images(REP_SRC)

    if total_add_prod > len(prod_pool):
        lack = total_add_prod - len(prod_pool)
        return False, f"ì œí’ˆì‚¬ì§„ ë¶€ì¡±: í•„ìš” {total_add_prod}ì¥ / ì†ŒìŠ¤ {len(prod_pool)}ì¥ (ë¶€ì¡± {lack}ì¥)"
    if total_add_rep > len(rep_pool):
        lack = total_add_rep - len(rep_pool)
        return False, f"ëŒ€í‘œì‚¬ì§„ ë¶€ì¡±: í•„ìš” {total_add_rep}ì¥ / ì†ŒìŠ¤ {len(rep_pool)}ì¥ (ë¶€ì¡± {lack}ì¥)"

    random.shuffle(prod_pool)
    random.shuffle(rep_pool)
    plan = []
    for d in details:
        alloc = {"dest_dir": d["dest_dir"], "title": d["title"], "products": [], "rep": None}
        if d["need_prod"] > 0:
            alloc["products"] = [prod_pool.pop() for _ in range(d["need_prod"])]
        if d["need_rep"] == 1:
            if rep_pool:
                alloc["rep"] = rep_pool.pop()
            else:
                return False, f"ëŒ€í‘œì‚¬ì§„ ì†ŒìŠ¤ ë¶€ì¡±(ê³„íš ë‹¨ê³„) â†’ {d['dest_dir']}"
        plan.append(alloc)

    logger(f"âœ… [PLAN] ì „ëŸ‰ ë°°ë¶„ ê°€ëŠ¥ | ì œí’ˆ ì†ŒìŠ¤:{len(list_images(PRODUCT_SRC))} "
           f"â†’ ë°°ë¶„:{total_add_prod}, ëŒ€í‘œ ì†ŒìŠ¤:{len(list_images(REP_SRC))} â†’ ë°°ë¶„:{total_add_rep}")
    return True, {"rows": details, "plan": plan}

# ============ EXECUTE (ì‚¬ì§„ ì´ë™/ì œëª© íŒŒì¼ ìƒì„±) ============ #
def write_title_file(dest_dir: str, title: str, logger):
    ensure_folder(dest_dir)
    safe_name = safe_filename_from_title(title)
    target = unique_target_path(dest_dir, safe_name, ".txt")
    try:
        with io.open(target, "w", encoding="utf-8") as f:
            f.write(f"{title}\n{title}\n{title}\n")
        logger(f"ğŸ“ [ì œëª©íŒŒì¼] {target}")
    except Exception as e:
        logger(f"âŒ [ì œëª©íŒŒì¼] ìƒì„± ì‹¤íŒ¨: {target} | {e}")

def execute_plan(plan_obj, logger, progress_cb):
    plan = plan_obj["plan"]
    total = len(plan)

    for i, alloc in enumerate(plan, start=1):
        dest_dir = alloc["dest_dir"]
        ensure_folder(dest_dir)

        if alloc["products"]:
            for src in alloc["products"]:
                try:
                    dst = move_with_rename(src, dest_dir)
                    logger(f"âœ… [ì œí’ˆ] MOVE {os.path.basename(src)} â†’ {dst}")
                except Exception as e:
                    logger(f"âŒ [ì œí’ˆ] MOVE ì‹¤íŒ¨: {src} â†’ {dest_dir} | {e}")
        else:
            logger(f"â­ï¸ [ì œí’ˆ] ìŠ¤í‚µ: ìš”êµ¬ëŸ‰ ì¶©ì¡± â†’ {dest_dir}")

        if count_rep_in_folder(dest_dir) >= 1:
            logger(f"â­ï¸ [ëŒ€í‘œ] ìŠ¤í‚µ(ì´ë¯¸ TSí˜• ì¡´ì¬) â†’ {dest_dir}")
        else:
            if alloc["rep"]:
                try:
                    _, ext = os.path.splitext(alloc["rep"])
                    rep_name = generate_timestamp_name(ext)
                    tmp_dst = unique_target_path(dest_dir, os.path.splitext(rep_name)[0], ext)
                    shutil.move(alloc["rep"], tmp_dst)
                    logger(f"â­ [ëŒ€í‘œ] MOVE {os.path.basename(alloc['rep'])} â†’ {tmp_dst}")
                except Exception as e:
                    logger(f"âŒ [ëŒ€í‘œ] MOVE ì‹¤íŒ¨: {alloc['rep']} â†’ {dest_dir} | {e}")
            else:
                logger(f"â­ï¸ [ëŒ€í‘œ] ìŠ¤í‚µ(ê³„íšç„¡ ë˜ëŠ” í•„ìš”ç„¡) â†’ {dest_dir}")

        progress_cb(int(i * 100 / max(1, total)))

# ============ í¬ë¡¤ë§ ìœ í‹¸ ============ #
HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 "
                  "(KHTML, like Gecko) Chrome/126.0 Safari/537.36"
}
REMOVE_LINE_PATTERNS = [
    r"^ì´\s*í¬ìŠ¤íŒ…ì€\s*ë„¤ì´ë²„\s*ì‡¼í•‘\s*ì»¤ë„¥íŠ¸\s*í™œë™ì˜\s*ì¼í™˜ìœ¼ë¡œ,\s*íŒë§¤\s*ë°œìƒ\s*ì‹œ\s*ìˆ˜ìˆ˜ë£Œë¥¼\s*ì œê³µë°›ìŠµë‹ˆë‹¤\.?$",
    r"^ê´‘ê³ \s*í¬í•¨\s*ì½˜í…ì¸ ì…ë‹ˆë‹¤\.?$",
]

def normalize_spaces(s: str) -> str:
    return re.sub(r"\s+", " ", s or "").strip()

def should_remove_line(line: str) -> bool:
    t = normalize_spaces(line)
    if not t:
        return True
    for pat in REMOVE_LINE_PATTERNS:
        if re.match(pat, t):
            return True
    return False

def to_mobile_url(url: str) -> str:
    m = re.match(r"^https?://blog\.naver\.com/([^/]+)/(\d+)", url)
    if m:
        return f"https://m.blog.naver.com/{m.group(1)}/{m.group(2)}"
    return url.replace("://blog.naver.com/", "://m.blog.naver.com/")

def extract_body_mobile(html: str):
    try:
        soup = BeautifulSoup(html, "lxml")
    except Exception:
        soup = BeautifulSoup(html, "html.parser")

    lines = []
    main = soup.select_one("div.se-main-container")
    if main:
        for p in main.select("p.se-text-paragraph"):
            txt = normalize_spaces(p.get_text(" ", strip=True))
            if txt and not should_remove_line(txt):
                lines.append(txt)
    else:
        legacy = soup.select_one("#postViewArea, div#viewTypeSelector")
        if legacy:
            raw = legacy.get_text("\n", strip=True)
            for part in re.split(r"\n{1,}", raw):
                txt = normalize_spaces(part)
                if txt and not should_remove_line(txt):
                    lines.append(txt)

    cleaned = []
    last = None
    for ln in lines:
        if last is None or ln != last:
            cleaned.append(ln)
            last = ln
    return cleaned

def fetch_html(url: str) -> str:
    r = requests.get(url, headers=HEADERS, timeout=20)
    r.raise_for_status()
    return r.text

def save_blog_txt(dest_dir: str, paragraphs: list[str]):
    ensure_folder(dest_dir)
    path = os.path.join(dest_dir, "ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt")
    body = "\n\n".join(paragraphs).strip()
    with open(path, "w", encoding="utf-8") as f:
        f.write(body + ("\n" if body else ""))
    return path

# ============ GUI ============ #
UI_BG = "#F5F7FA"; UI_FG = "#1F2937"; UI_ACCENT = "#2563EB"
UI_FONT = ("ë§‘ì€ ê³ ë”•", 10); UI_FONT_TITLE = ("ë§‘ì€ ê³ ë”•", 12, "bold")
UI_PINK_BG = "#FFE4F2"; UI_PINK_FG = "#9D174D"
UI_RED = "#DC2626"; UI_RED_FG = "#FFFFFF"

HELP_TEXT = (
    "â‘  [ì œëª©+ê°ìƒ‰] : í´ë”ë¥¼ ë§Œë“¤ê³  ê° í–‰ë§ˆë‹¤ í¬ë¡¤ë§â†’GPT ê°ìƒ‰â†’'ë°œí–‰.txt' ìƒì„±(ì œëª© 3ì¤„ + ë¹ˆì¤„ + ê°ìƒ‰ë¬¸). ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µí•©ë‹ˆë‹¤.\n"
    "â‘¡ [ì„ì‹œ] ë¸”ë¡œê·¸ ê¸€ í¬ë¡¤ë§ : ë³¸ë¬¸ì„ ì¶”ì¶œí•˜ì—¬ 'ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt' ì €ì¥(ì ê²€ìš©).\n"
    "â‘¢ [ëŒ€í‘œì‚¬ì§„/ì œí’ˆì‚¬ì§„ í´ë”ë§] : ëŒ€í‘œì‚¬ì§„/ì œí’ˆì‚¬ì§„ MOVE í´ë”ë§.\n"
    "â‘£ [ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt ì‚­ì œ] : ëª©ë¡ìƒì˜ ëª¨ë“  í´ë”ì—ì„œ 'ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt' ì¼ê´„ ì‚­ì œ.\n"
    "Â· ì œí’ˆì‚¬ì§„ ì†ŒìŠ¤: 'ê°ˆë¼431 (ë¯¸ì‚¬ìš©)'\n"
    "Â· ëŒ€í‘œì‚¬ì§„ ì†ŒìŠ¤: 'ëŒ€í‘œì´ë¯¸ì§€(ë¯¸ì‚¬ìš©)'\n"
)

class App:
    def __init__(self, root):
        self.root = root
        root.title("ë¸”ë¡œê·¸ ë°œí–‰ í´ë”ë§")
        root.geometry("1080x900")
        root.configure(bg=UI_BG)

        style = ttk.Style()
        try: style.theme_use('clam')
        except: pass
        style.configure("TLabel", background=UI_BG, foreground=UI_FG, font=UI_FONT)
        style.configure("TFrame", background=UI_BG)
        style.configure("TButton", font=UI_FONT, padding=6)
        style.configure("Accent.Horizontal.TProgressbar", troughcolor="#EEF2FF", background=UI_ACCENT)

        # ì œëª©/ì„¤ëª…
        frm_top = ttk.Frame(root); frm_top.pack(fill="x", padx=16, pady=12)
        tk.Label(frm_top, text="ë¸”ë¡œê·¸ ë°œí–‰ í´ë”ë§", font=UI_FONT_TITLE, bg=UI_BG, fg=UI_FG).pack(anchor="w")
        tk.Label(frm_top, text=HELP_TEXT, font=UI_FONT, bg=UI_BG, fg=UI_FG, justify="left", anchor="w").pack(fill="x", pady=(4,0))

        # ì—‘ì…€ ì…ë ¥
        frm_x = ttk.Frame(root); frm_x.pack(fill="x", padx=16, pady=(6,6))
        title = tk.Label(frm_x, text="ë¸”ë¡œê·¸ ë°œí–‰ í‚¤ì›Œë“œ ì‹œíŠ¸.xlsx", bg=UI_PINK_BG, fg=UI_PINK_FG, font=("ë§‘ì€ ê³ ë”•", 10, "bold"), padx=8, pady=2)
        lf = ttk.LabelFrame(frm_x, labelwidget=title, padding=0); lf.pack(fill="x")
        inner = ttk.Frame(lf, padding=8); inner.pack(fill="x")
        self.xlsx_var = tk.StringVar()
        ttk.Entry(inner, textvariable=self.xlsx_var).pack(side="left", fill="x", expand=True, padx=(0,6))
        ttk.Button(inner, text="ì°¾ê¸°", command=self.pick_excel).pack(side="left")

        # GPT ì„¤ì •
        frm_gpt = ttk.Frame(root); frm_gpt.pack(fill="x", padx=16, pady=(0,12))
        gpt_title = tk.Label(frm_gpt, text="GPT ê°ìƒ‰ ì„¤ì •", bg=UI_PINK_BG, fg=UI_PINK_FG, font=("ë§‘ì€ ê³ ë”•",10,"bold"), padx=8, pady=2)
        gpt_lf = ttk.LabelFrame(frm_gpt, labelwidget=gpt_title, padding=0); gpt_lf.pack(fill="x")
        gpt_inner = ttk.Frame(gpt_lf, padding=8); gpt_inner.pack(fill="x")

        ttk.Label(gpt_inner, text="API Key:", width=10).grid(row=0, column=0, sticky="w")
        self.api_key_var = tk.StringVar()
        self.api_key_entry = ttk.Entry(gpt_inner, textvariable=self.api_key_var, show="*")
        self.api_key_entry.grid(row=0, column=1, sticky="ew", padx=(0,6))

        ttk.Label(gpt_inner, text="ì§€ì¹¨:", width=10).grid(row=1, column=0, sticky="nw", pady=(6,0))
        self.instruction_txt = scrolledtext.ScrolledText(gpt_inner, height=5, wrap="word")
        self.instruction_txt.grid(row=1, column=1, sticky="ew", pady=(6,0))
        gpt_inner.columnconfigure(1, weight=1)

        self.config_path = os.path.join(os.getcwd(), "gpt_config.json")
        self.load_config()

        # ì‹¤í–‰ ë²„íŠ¼ (ì¢Œ/ìš° ì •ë ¬)
        frm_act = ttk.Frame(root); frm_act.pack(fill="x", padx=16, pady=8)

        frm_act_left = ttk.Frame(frm_act); frm_act_left.pack(side="left")
        ttk.Button(frm_act_left, text="ì œëª©+ê°ìƒ‰", command=self.run_title_and_paraphrase).pack(side="left", padx=6)
        ttk.Button(frm_act_left, text="ëŒ€í‘œì‚¬ì§„/ì œí’ˆì‚¬ì§„ í´ë”ë§", command=self.run_foldering).pack(side="left", padx=6)

        frm_act_right = ttk.Frame(frm_act); frm_act_right.pack(side="right")
        ttk.Button(frm_act_right, text="[ì„ì‹œ] ë¸”ë¡œê·¸ ê¸€ í¬ë¡¤ë§", command=self.run_crawling).pack(side="left", padx=6)
        self.btn_delete = tk.Button(frm_act_right, text="ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt ì‚­ì œ", command=self.run_delete_draft_txt,
                                    bg=UI_RED, fg=UI_RED_FG, activebackground="#B91C1C", activeforeground="#FFFFFF",
                                    padx=10, pady=6)
        self.btn_delete.pack(side="left", padx=6)

        # ì§„í–‰ë¥ /ë¡œê·¸
        frm_prog = ttk.Frame(root); frm_prog.pack(fill="x", padx=16, pady=(0,6))
        ttk.Label(frm_prog, text="ì§„í–‰ë¥ ").pack(anchor="w")
        self.prog = ttk.Progressbar(frm_prog, style="Accent.Horizontal.TProgressbar", maximum=100, mode="determinate")
        self.prog.pack(fill="x")
        self.prog_pct = tk.StringVar(value="0%")
        tk.Label(frm_prog, textvariable=self.prog_pct, font=("ë§‘ì€ ê³ ë”•", 9), bg=UI_BG, fg="#374151").pack(anchor="e")

        self.log = scrolledtext.ScrolledText(root, height=20, bg="#FFFFFF", fg="#111827", font=("Consolas", 10))
        self.log.pack(fill="both", expand=True, padx=16, pady=6)

        # ë¡œê·¸íŒŒì¼
        self.logs_dir = os.path.join(os.getcwd(), "logs")
        os.makedirs(self.logs_dir, exist_ok=True)
        self.log_file = os.path.join(self.logs_dir, datetime.datetime.now().strftime("%Y%m%d_%H%M%S") + ".txt")

    # ê³µí†µ
    def logger(self, msg: str):
        ts = datetime.datetime.now().strftime("%H:%M:%S")
        self.log.config(state="normal")
        self.log.insert("end", f"[{ts}] {msg}\n")
        self.log.see("end")
        self.log.config(state="disabled")
        self.root.update_idletasks()

    def prog_set(self, p: int):
        p = max(0, min(100, int(p)))
        self.prog["value"] = p
        self.prog_pct.set(f"{p}%")
        self.root.update_idletasks()

    def pick_excel(self):
        path = filedialog.askopenfilename(title="ì—‘ì…€ íŒŒì¼ ì„ íƒ",
                                          filetypes=[("Excel", "*.xlsx *.xlsm *.xltx *.xltm")])
        if path:
            self.xlsx_var.set(path)

    # config load/save
    def load_config(self):
        try:
            if os.path.isfile(self.config_path):
                with open(self.config_path, "r", encoding="utf-8") as f:
                    data = json.load(f)
                self.api_key_var.set(data.get("api_key",""))
                self.instruction_txt.delete("1.0","end")
                self.instruction_txt.insert("1.0", data.get("instruction",""))
            else:
                self.api_key_var.set("")
                self.instruction_txt.delete("1.0","end")
        except Exception:
            self.api_key_var.set("")
            self.instruction_txt.delete("1.0","end")

    def save_config(self):
        try:
            data = {
                "api_key": self.api_key_var.get().strip(),
                "instruction": self.instruction_txt.get("1.0","end").strip()
            }
            with open(self.config_path, "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            self.logger(f"âš ï¸ [config ì €ì¥ ì‹¤íŒ¨] {e}")

    # GPT ê°ìƒ‰
    def paraphrase_text_gui(self, original_text: str) -> str:
        api_key = self.api_key_var.get().strip()
        instruction = self.instruction_txt.get("1.0","end").strip()
        if not api_key:
            return "[GPT ì˜¤ë¥˜] API Keyê°€ ì—†ìŠµë‹ˆë‹¤."
        if not instruction:
            return "[GPT ì˜¤ë¥˜] ì§€ì¹¨(Instruction)ì´ ì—†ìŠµë‹ˆë‹¤."

        prompt = f"{instruction}\n\n---\nì›ë¬¸:\n{original_text}\n---\nê°ìƒ‰ ê²°ê³¼:"

        try:
            client = OpenAI(api_key=api_key)  # timeoutì€ ìš”ì²­ì—ì„œ ì§€ì •
            resp = client.chat.completions.create(
                model="gpt-5",
                messages=[
                    {"role": "system", "content": "ë„ˆëŠ” ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œìš© ì›ê³  ê°ìƒ‰ ì „ë¬¸ê°€ì•¼."},
                    {"role": "user", "content": prompt}
                ],
                timeout=120
            )
            return resp.choices[0].message.content.strip()
        except Exception as e:
            return f"[GPT ì˜¤ë¥˜] {e}"

    # ë²„íŠ¼ â‘ : ì œëª©+ê°ìƒ‰
    def run_title_and_paraphrase(self):
        xlsx = self.xlsx_var.get().strip()
        if not xlsx:
            messagebox.showwarning("ì•ˆë‚´", "ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.")
            return

        self.save_config()

        self.log.config(state="normal"); self.log.delete("1.0", "end"); self.log.config(state="disabled")
        self.prog_set(0)

        try:
            rows = read_rows_from_excel(xlsx, self.logger)
            if not rows:
                messagebox.showerror("ì˜¤ë¥˜", "ì—‘ì…€ì—ì„œ ìœ íš¨í•œ í–‰ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                return

            total = len(rows)
            for idx, r in enumerate(rows, start=1):
                blog_folder = choose_blog_folder_name(r["blog_name"], r["blog_id"])
                dest_dir = os.path.join(BASE_ROOT, r["date_folder"], blog_folder, r["keyword_folder"])
                ensure_folder(dest_dir)

                publish_path = os.path.join(dest_dir, "ë°œí–‰.txt")
                if os.path.exists(publish_path):
                    self.logger(f"â­ï¸ [ìŠ¤í‚µ] ì´ë¯¸ ë°œí–‰.txt ì¡´ì¬ â†’ {publish_path}")
                    self.prog_set(int(idx * 100 / max(1, total)))
                    continue

                title = r["title"].strip()
                url = (r.get("url") or "").strip()

                if not title:
                    self.logger(f"âŒ [ì œëª© ì—†ìŒ] {dest_dir}")
                    self.prog_set(int(idx * 100 / max(1, total)))
                    continue
                if not url:
                    self.logger(f"âŒ [URL ì—†ìŒ] {dest_dir}")
                    self.prog_set(int(idx * 100 / max(1, total)))
                    continue

                try:
                    murl = to_mobile_url(url)
                    html = fetch_html(murl)
                    paragraphs = extract_body_mobile(html)
                    if not paragraphs:
                        self.logger(f"âš ï¸ [ë³¸ë¬¸ì—†ìŒ] src:{url} | mobile:{murl}")
                        self.prog_set(int(idx * 100 / max(1, total)))
                        continue

                    original_text = "\n\n".join(paragraphs).strip()

                    self.logger(f"ğŸ§  [GPT ê°ìƒ‰] {dest_dir}")
                    paraphrased = self.paraphrase_text_gui(original_text)

                    # GPT ì‹¤íŒ¨ ì‹œ ë°œí–‰ íŒŒì¼ ìƒì„± ê¸ˆì§€
                    if paraphrased.strip().startswith("[GPT ì˜¤ë¥˜]"):
                        self.logger(f"âŒ [GPT ì‹¤íŒ¨] {dest_dir} | {paraphrased}")
                        self.prog_set(int(idx * 100 / max(1, total)))
                        continue

                    body_lines = [title, title, title, "", paraphrased]
                    out_txt = "\n".join(body_lines).rstrip() + "\n"
                    with io.open(publish_path, "w", encoding="utf-8") as f:
                        f.write(out_txt)

                    self.logger(f"âœ¨ [ë°œí–‰.txt ìƒì„±] {publish_path}")

                except Exception as e:
                    self.logger(f"âŒ [ì‹¤íŒ¨] {dest_dir} | {e}")

                self.prog_set(int(idx * 100 / max(1, total)))

            self.logger("âœ… [ì™„ë£Œ] ì œëª©+ê°ìƒ‰ ì „ì²´ ì™„ë£Œ")

        except Exception as e:
            self.logger(f"âŒ [ì˜¤ë¥˜] ì‹¤í–‰ ì¤‘ ì˜ˆì™¸: {e}\n{traceback.format_exc()}")
        finally:
            try:
                content = self.log.get("1.0", "end")
                with io.open(self.log_file, "w", encoding="utf-8") as f:
                    f.write(content)
            except Exception:
                pass

    # ë²„íŠ¼ â‘¡: [ì„ì‹œ] ë¸”ë¡œê·¸ ê¸€ í¬ë¡¤ë§
    def run_crawling(self):
        xlsx = self.xlsx_var.get().strip()
        if not xlsx:
            messagebox.showwarning("ì•ˆë‚´", "ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.")
            return

        self.log.config(state="normal"); self.log.delete("1.0", "end"); self.log.config(state="disabled")
        self.prog_set(0)

        try:
            rows = read_rows_from_excel(xlsx, self.logger)
            if not rows:
                messagebox.showerror("ì˜¤ë¥˜", "ì—‘ì…€ì—ì„œ ìœ íš¨í•œ í–‰ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                return

            total = len(rows)
            for idx, r in enumerate(rows, start=1):
                url = (r.get("url") or "").strip()
                blog_folder = choose_blog_folder_name(r["blog_name"], r["blog_id"])
                dest_dir = os.path.join(BASE_ROOT, r["date_folder"], blog_folder, r["keyword_folder"])
                ensure_folder(dest_dir)

                if not url:
                    self.logger(f"â­ï¸ [ìŠ¤í‚µ] URL ì—†ìŒ â†’ {dest_dir}")
                    self.prog_set(int(idx * 100 / max(1, total)))
                    continue

                try:
                    murl = to_mobile_url(url)
                    html = fetch_html(murl)
                    paragraphs = extract_body_mobile(html)
                    if not paragraphs:
                        self.logger(f"âš ï¸ [ë³¸ë¬¸ì—†ìŒ] src:{url} | mobile:{murl}")
                    else:
                        out_path = save_blog_txt(dest_dir, paragraphs)
                        self.logger(f"âœ… [í¬ë¡¤ë§ ì™„ë£Œ] {url} â†’ {out_path}")
                except Exception as e:
                    self.logger(f"âŒ [í¬ë¡¤ë§ ì‹¤íŒ¨] {url} | {e}")

                self.prog_set(int(idx * 100 / max(1, total)))

            self.logger("âœ… [ì™„ë£Œ] ë¸”ë¡œê·¸ ë³¸ë¬¸ í¬ë¡¤ë§ ì™„ë£Œ")

        except Exception as e:
            self.logger(f"âŒ [ì˜¤ë¥˜] ì‹¤í–‰ ì¤‘ ì˜ˆì™¸: {e}\n{traceback.format_exc()}")
        finally:
            try:
                content = self.log.get("1.0", "end")
                with io.open(self.log_file, "w", encoding="utf-8") as f:
                    f.write(content)
            except Exception:
                pass

    # ë²„íŠ¼ â‘¢: ëŒ€í‘œ/ì œí’ˆ í´ë”ë§(MOVE)
    def run_foldering(self):
        xlsx = self.xlsx_var.get().strip()
        if not xlsx:
            messagebox.showwarning("ì•ˆë‚´", "ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.")
            return

        self.log.config(state="normal"); self.log.delete("1.0", "end"); self.log.config(state="disabled")
        self.prog_set(0)

        try:
            rows = read_rows_from_excel(xlsx, self.logger)
            if not rows:
                messagebox.showerror("ì˜¤ë¥˜", "ì—‘ì…€ì—ì„œ ìœ íš¨í•œ í–‰ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                return

            ok, info = plan_allocation(rows, self.logger)
            if not ok:
                self.logger("âŒ [PLAN] ë°°ë¶„ ë¶ˆê°€ â†’ ì‹¤í–‰ ì¤‘ë‹¨")
                messagebox.showerror("ì‚¬ì „ì ê²€ ì‹¤íŒ¨", str(info))
                return

            self.logger("â–¶ï¸ [EXECUTE] ê³„íšëŒ€ë¡œ ì´ë™(MOVE) ë° ì œëª© íŒŒì¼ ë³´ì¥ ìƒì„± ì‹œì‘")
            execute_plan(info, self.logger, self.prog_set)
            self.logger("âœ… [ì™„ë£Œ] ëŒ€í‘œ/ì œí’ˆ ì‚¬ì§„ í´ë”ë§ ë")

        except Exception as e:
            self.logger(f"âŒ [ì˜¤ë¥˜] ì‹¤í–‰ ì¤‘ ì˜ˆì™¸: {e}\n{traceback.format_exc()}")
        finally:
            try:
                content = self.log.get("1.0", "end")
                with io.open(self.log_file, "w", encoding="utf-8") as f:
                    f.write(content)
            except Exception:
                pass

    # ë²„íŠ¼ â‘£: 'ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt' ì¼ê´„ ì‚­ì œ
    def run_delete_draft_txt(self):
        xlsx = self.xlsx_var.get().strip()
        if not xlsx:
            messagebox.showwarning("ì•ˆë‚´", "ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.")
            return

        if not messagebox.askyesno("í™•ì¸", "ì—‘ì…€ì— ìˆëŠ” ëª¨ë“  ëŒ€ìƒ í´ë”ì—ì„œ\n'ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
            return

        self.log.config(state="normal"); self.log.delete("1.0", "end"); self.log.config(state="disabled")
        self.prog_set(0)

        try:
            rows = read_rows_from_excel(xlsx, self.logger)
            if not rows:
                messagebox.showerror("ì˜¤ë¥˜", "ì—‘ì…€ì—ì„œ ìœ íš¨í•œ í–‰ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                return

            total = len(rows)
            deleted = 0
            skipped = 0

            for idx, r in enumerate(rows, start=1):
                blog_folder = choose_blog_folder_name(r["blog_name"], r["blog_id"])
                dest_dir = os.path.join(BASE_ROOT, r["date_folder"], blog_folder, r["keyword_folder"])
                target = os.path.join(dest_dir, "ê°ìƒ‰í•  ë¸”ë¡œê·¸.txt")
                try:
                    if os.path.isfile(target):
                        os.remove(target)
                        deleted += 1
                        self.logger(f"ğŸ—‘ï¸ [ì‚­ì œ] {target}")
                    else:
                        skipped += 1
                        self.logger(f"â­ï¸ [ì—†ìŒ] {target}")
                except Exception as e:
                    self.logger(f"âŒ [ì‚­ì œ ì‹¤íŒ¨] {target} | {e}")
                self.prog_set(int(idx * 100 / max(1, total)))

            self.logger(f"âœ… [ì™„ë£Œ] ì‚­ì œ:{deleted} / ì—†ìŒ:{skipped}")

        except Exception as e:
            self.logger(f"âŒ [ì˜¤ë¥˜] ì‹¤í–‰ ì¤‘ ì˜ˆì™¸: {e}\n{traceback.format_exc()}")
        finally:
            try:
                content = self.log.get("1.0", "end")
                with io.open(self.log_file, "w", encoding="utf-8") as f:
                    f.write(content)
            except Exception:
                pass

def main():
    root = tk.Tk()
    App(root)
    root.mainloop()

if __name__ == "__main__":
    main()
#
import os
import shutil
import time
import random
import re

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait, Select
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import TimeoutException
from webdriver_manager.chrome import ChromeDriverManager

# Excel
from openpyxl import load_workbook


def human_delay(a=0.6, b=1.8):
    time.sleep(random.uniform(a, b))


# === ê³µí†µ ê²½ë¡œ: ì´ë¯¸ì§€ + ë°œí–‰.txt ===
#  ğŸ‘‰ ê¸°ë³¸ê°’(ë‹¨ì¼ ì‹¤í–‰ìš©). ì—‘ì…€ ê¸°ë°˜ ë°˜ë³µ ë°œí–‰ì—ì„œëŠ” rowë§ˆë‹¤ BASE_DIRì´ ë°”ë€œ.
BASE_ROOT = r"Z:\ë¯¸ë“œë¸Œë¡œ\â¤ ë§ˆì¼€íŒ…\ë¸”ë¡œê·¸ ê°ìƒ‰ ë° ì—…ë¡œë“œ\ê°ˆë¼431"
BASE_DIR = (
    r"Z:\ë¯¸ë“œë¸Œë¡œ\â¤ ë§ˆì¼€íŒ…\ë¸”ë¡œê·¸ ê°ìƒ‰ ë° ì—…ë¡œë“œ\ê°ˆë¼431\25.11.20"
    r"\8 ë·°í‹°ë…¸íŠ¸ pepper634\ë¦¬ì…‹ë¸Œì´ìº”ë””"
)
PUBLISH_TXT = os.path.join(BASE_DIR, "ë°œí–‰.txt")

# ì œëª©/ë³¸ë¬¸ ê¸°ë³¸ê°’ (ë°œí–‰.txt ì½ê¸° ì‹¤íŒ¨ ì‹œ ëŒ€ë¹„)
DEFAULT_TITLE_TEXT = "ìë™í™” í…ŒìŠ¤íŠ¸ ì œëª©ì…ë‹ˆë‹¤."
DEFAULT_BODY_TEXT = "ë³¸ë¬¸ë„ ì‚¬ëŒì²˜ëŸ¼ ëœë¤ ì‹œê°„ì°¨ë¥¼ ë‘ë©° ì…ë ¥ë©ë‹ˆë‹¤.\nì´ë¯¸ì§€ ì•„ë˜ì— ë“¤ì–´ê°ˆ í…ŒìŠ¤íŠ¸ ë¬¸ì¥ì…ë‹ˆë‹¤."

# === ì—‘ì…€ ê²½ë¡œ (ì—¬ê¸°ë¥¼ ì‹¤ì œ íŒŒì¼ ê²½ë¡œë¡œ ìˆ˜ì •í•´ì„œ ì‚¬ìš©) ===
EXCEL_PATH = r"Z:\ë¯¸ë“œë¸Œë¡œ\â¤ ë§ˆì¼€íŒ…\ì§€í˜œ_í”„ë¡œê·¸ë¨\1.ë¸”ë¡œê·¸ ë°œí–‰ í‚¤ì›Œë“œ ì‹œíŠ¸.xlsx"

# === ë¸”ë¡œê·¸ í´ë”ëª… ë§¤í•‘ (í´ë”ë§ í”„ë¡œê·¸ë¨ê³¼ ë™ì¼) ============ #
BLOG_FOLDER_NAME_BY_ID = {
    "wet4448":   "0 ë·°í‹°ìµœê³  wet4448",
    "prevail9850":    "1 ì†Œì†Œí•œí–‰ë³µ prevail9850",
    "elegant10872":  "2 í•˜ë©´ëœë‹¤ elegant10872",
    "dkdlwjd1q":  "3 ìŠ¬ë¦¼ì¼ê¸° dkdlwjd1q",
    "thejrdks9o":  "4 í•ëª¨ë¨¼íŠ¸ thejrdks9o",
    "reserve1047": "5 ë…¸ë ¥ì²œì¬ reserve1047",
    "scarce8501":  "6 ê¸€ë¡œìš°í• scarce8501",
    "withpiano001":"7 ìŠ¬ë¦¼ì¡°ì´ withpiano001",
    "pepper634":   "8 ë·°í‹°ë…¸íŠ¸ pepper634",
    "happy24632":     "9 ê°ëŸ‰ë©ìŠ¤ happy24632",
    "heoangel731": "10 ê±´ê°•ìš”ì • heoangel731",
}

INVALID_FN_CHARS = r'\/:*?"<>|\n\r\t'
INVALID_FN_RE = re.compile(f"[{re.escape(INVALID_FN_CHARS)}]")

IMG_EXTS = {".jpg", ".jpeg", ".png", ".webp", ".bmp", ".tif", ".tiff"}


def is_image_file(path: str) -> bool:
    return os.path.splitext(path)[1].lower() in IMG_EXTS


def parse_blog_cell(cell_text: str):
    """
    'ê±´ê°•ìš”ì •(heoangel731)' â†’ ('ê±´ê°•ìš”ì •', 'heoangel731')
    """
    s = str(cell_text or "").strip()
    m = re.match(r"^(.*)\(([^)]+)\)\s*$", s)
    if m:
        name = m.group(1).strip()
        bid = m.group(2).strip()
    else:
        name, bid = s, ""
    return name, bid


def choose_blog_folder_name(blog_name: str, blog_id: str):
    if blog_id and blog_id in BLOG_FOLDER_NAME_BY_ID:
        return BLOG_FOLDER_NAME_BY_ID[blog_id]
    return f"{blog_name} {blog_id}".strip()


def parse_excel_date(v, fallback_year=None):
    """
    Aì—´ ê°’ â†’ datetime (ì˜ˆì•½ ë‚ ì§œ + í´ë”ëª… ìƒì„± ë‘˜ ë‹¤ì— ì‚¬ìš©)
    ì˜ˆì‹œ: '10/28' â†’ ì˜¬í•´ 10ì›” 28ì¼
    """
    from datetime import datetime

    now = datetime.now()
    y = fallback_year or now.year
    if isinstance(v, datetime):
        return v

    s = str(v or "").strip()
    # ì—¬ëŸ¬ í¬ë§· ì‹œë„
    for fmt in ("%Y-%m-%d", "%Y.%m.%d", "%m/%d", "%m.%d"):
        try:
            d = datetime.strptime(s, fmt)
            if fmt in ("%m/%d", "%m.%d"):
                d = d.replace(year=y)
            return d
        except ValueError:
            continue
    # ì‹¤íŒ¨ ì‹œ í˜„ì¬ ë‚ ì§œ
    return now


def parse_excel_time(v):
    """
    Iì—´ ê°’ â†’ (hour, minute)
    ì˜ˆì‹œ: '10' â†’ (10, 0), '9' â†’ (9, 0), '10:30' â†’ (10, 30)
    """
    if v is None:
        return 10, 0  # ê¸°ë³¸ê°’: 10ì‹œ ì •ê°

    s = str(v).strip()
    if ":" in s:
        try:
            h, m = s.split(":", 1)
            h = int(h)
            m = int(m)
            h = max(0, min(23, h))
            m = max(0, min(59, m))
            return h, m
        except Exception:
            pass

    try:
        h = int(float(s))
        h = max(0, min(23, h))
        return h, 0
    except Exception:
        return 10, 0


def load_tasks_from_excel(xlsx_path: str):
    """
    Aì—´: ë‚ ì§œ
    Bì—´: í‚¤ì›Œë“œ í´ë”ëª…
    Hì—´: ë¸”ë¡œê·¸ ì´ë¦„(ì•„ì´ë””)
    Iì—´: ì˜ˆì•½ ì‹œê°„(ì •ìˆ˜ ë˜ëŠ” '10:30' í˜•íƒœ)
    Kì—´: ì œëª© (í•„ìš”í•˜ë©´ ì‚¬ìš©, ì§€ê¸ˆì€ ë°œí–‰.txt ê¸°ì¤€)
    """
    tasks = []
    wb = load_workbook(xlsx_path, data_only=True)
    ws = wb.active

    for row_idx, row in enumerate(ws.iter_rows(min_row=2, values_only=True), start=2):
        A = row[0]  # ë‚ ì§œ
        B = row[1]  # í‚¤ì›Œë“œ í´ë”ëª…
        H = row[7]  # ë¸”ë¡œê·¸ ì´ë¦„(ì•„ì´ë””)
        I = row[8]  # ì˜ˆì•½ ì‹œê°„
        K = row[10]  # ì œëª© (ì˜µì…˜)

        if A is None and B is None and H is None and K is None:
            continue

        dt = parse_excel_date(A)
        date_folder = dt.strftime("%y.%m.%d")

        blog_name, blog_id = parse_blog_cell(H)
        blog_folder = choose_blog_folder_name(blog_name, blog_id)

        keyword_folder = str(B or "").strip()
        base_dir = os.path.join(BASE_ROOT, date_folder, blog_folder, keyword_folder)

        hour, minute = parse_excel_time(I)

        tasks.append(
            {
                "row_index": row_idx,
                "base_dir": base_dir,
                "reserve_date": dt,
                "reserve_hour": hour,
                "reserve_minute": minute,
                "excel_title": str(K or "").strip(),
            }
        )

    print(f"â„¹ï¸ [ì—‘ì…€] ì´ {len(tasks)}í–‰(ë°œí–‰ ëŒ€ìƒ) ë¡œë“œ")
    return tasks


def read_publish_txt_from_dir(base_dir: str):
    """
    === ë°œí–‰.txt ì½ê¸°: 1ì¤„ = ì œëª©, ë‚˜ë¨¸ì§€ = ë³¸ë¬¸ ===
    (ê¸°ì¡´ ë¡œì§ ìœ ì§€, base_dirë§Œ íŒŒë¼ë¯¸í„°ë¡œ)
    """
    publish_txt = os.path.join(base_dir, "ë°œí–‰.txt")
    title_text = DEFAULT_TITLE_TEXT
    body_text = DEFAULT_BODY_TEXT

    try:
        with open(publish_txt, "r", encoding="utf-8") as f:
            lines = f.read().splitlines()
        if lines:
            title_text = lines[0].strip()
            if len(lines) > 1:
                body_text = "\n".join(lines[1:])
            else:
                body_text = ""
        print(f"ğŸ“ ë°œí–‰.txt ë¡œë“œ ì™„ë£Œ: {publish_txt}")
    except Exception as e:
        print("âš ï¸ ë°œí–‰.txt ì½ê¸° ì‹¤íŒ¨, ê¸°ë³¸ ì œëª©/ë³¸ë¬¸ ì‚¬ìš©:", e)

    return title_text, body_text


def set_reserve_datetime(driver, wait, reserve_date, reserve_hour, reserve_minute):
    """
    === ì˜ˆì•½ ë‚ ì§œ/ì‹œê°„ ì„¤ì • ===
    - ë‚ ì§œ: ë‹¬ë ¥ì—ì„œ í´ë¦­
    - ì‹œê°„: select.hour_option__J_heO, select.minute_option__Vb3xB
    """
    from datetime import datetime

    try:
        # === ì˜ˆì•½ ë‚ ì§œ ì„¤ì • ===
        try:
            date_input = wait.until(
                EC.element_to_be_clickable(
                    (By.CSS_SELECTOR, "input.input_date__QmA0s")
                )
            )
            date_input.click()
            print("ğŸ“… ë‚ ì§œ ì…ë ¥ì°½ í´ë¦­ â†’ ë‹¬ë ¥ ì˜¤í”ˆ")
            human_delay(0.5, 1.0)

            calendar = wait.until(
                EC.visibility_of_element_located(
                    (By.CSS_SELECTOR, "div.ui-datepicker")
                )
            )

            target_year = reserve_date.year
            target_month = reserve_date.month
            target_day = reserve_date.day

            # ì›”/ì—°ë„ ë§ì¶œ ìˆ˜ ìˆìœ¼ë©´ ë§ì¶°ì£¼ê¸° (ìµœëŒ€ 12ë²ˆ ë°˜ë³µ)
            for _ in range(12):
                year_el = calendar.find_element(By.CLASS_NAME, "ui-datepicker-year")
                month_el = calendar.find_element(By.CLASS_NAME, "ui-datepicker-month")
                year_text = year_el.text
                month_text = month_el.text

                try:
                    curr_year = int(re.sub(r"\D", "", year_text))
                except Exception:
                    curr_year = target_year

                try:
                    curr_month = int(re.sub(r"\D", "", month_text))
                except Exception:
                    curr_month = target_month

                if curr_year == target_year and curr_month == target_month:
                    break

                if (curr_year, curr_month) < (target_year, target_month):
                    next_btn = calendar.find_element(By.CSS_SELECTOR, "a.ui-datepicker-next")
                    driver.execute_script("arguments[0].click();", next_btn)
                else:
                    prev_btn = calendar.find_element(By.CSS_SELECTOR, "a.ui-datepicker-prev")
                    driver.execute_script("arguments[0].click();", prev_btn)

                time.sleep(0.5)
                calendar = wait.until(
                    EC.visibility_of_element_located(
                        (By.CSS_SELECTOR, "div.ui-datepicker")
                    )
                )

            # ì›í•˜ëŠ” ì¼(day) í´ë¦­
            target_day_btn = calendar.find_element(
                By.XPATH,
                ".//td[not(contains(@class,'ui-state-disabled'))]"
                f"/button[normalize-space()='{target_day}']"
            )
            driver.execute_script("arguments[0].click();", target_day_btn)
            print(f"ğŸ“… ë‹¬ë ¥ì—ì„œ {target_year}-{target_month:02d}-{target_day:02d} í´ë¦­ ì™„ë£Œ")
            human_delay(0.5, 1.0)

        except Exception as e:
            print("âš ï¸ ì˜ˆì•½ ë‚ ì§œ ì„¤ì • ì‹¤íŒ¨:", e)

        # === ì˜ˆì•½ ì‹œê° ì„¤ì • ===
        try:
            hour_select = Select(
                wait.until(
                    EC.presence_of_element_located(
                        (By.CSS_SELECTOR, "select.hour_option__J_heO")
                    )
                )
            )
            minute_select = Select(
                wait.until(
                    EC.presence_of_element_located(
                        (By.CSS_SELECTOR, "select.minute_option__Vb3xB")
                    )
                )
            )

            # valueê°€ '10' / '00' / '30' ë“±ì¼ ìˆ˜ ìˆì–´ì„œ ë‘ ë²ˆ ì‹œë„
            hour_val_candidates = [str(reserve_hour), f"{reserve_hour:02d}"]
            minute_val_candidates = [str(reserve_minute), f"{reserve_minute:02d}"]

            for hv in hour_val_candidates:
                try:
                    hour_select.select_by_value(hv)
                    break
                except Exception:
                    continue

            for mv in minute_val_candidates:
                try:
                    minute_select.select_by_value(mv)
                    break
                except Exception:
                    continue

            print(f"â° ì˜ˆì•½ ì‹œê° ì„¤ì •: {reserve_hour:02d}:{reserve_minute:02d}")
            human_delay(0.5, 1.0)
        except Exception as e:
            print("âš ï¸ ì˜ˆì•½ ì‹œê° ì„¤ì • ì‹¤íŒ¨:", e)

    except Exception as e:
        print("âš ï¸ ì˜ˆì•½ ë‚ ì§œ/ì‹œê°„ ì „ì²´ ì„¤ì • ì‹¤íŒ¨:", e)


def upload_images(driver, wait, base_dir: str):
    """
    # ======================================================
    # 3) ì´ë¯¸ì§€ ì—…ë¡œë“œ
    #    - ì²« ë²ˆì§¸ ë°°ì¹˜: 1ì¥
    #    - ì´í›„: ë‚¨ì€ ì´ë¯¸ì§€ë“¤ì„ 10ì¥ì”© ëŠì–´ì„œ ëë‚  ë•Œê¹Œì§€ ì—…ë¡œë“œ
    # ======================================================
    (ê¸°ì¡´ ì£¼ì„/ë¡œì§ ê·¸ëŒ€ë¡œ, BASE_DIRë§Œ íŒŒë¼ë¯¸í„°ë¡œ ë³€ê²½ + ì£¼ì„ í•´ì œ)
    """
    try:
        image_dir = base_dir
        temp_dir = r"C:\temp_blog_img"
        os.makedirs(temp_dir, exist_ok=True)

        all_files = [
            f for f in os.listdir(image_dir)
            if f.lower().endswith((".jpg", ".jpeg", ".png", ".gif", ".webp"))
        ]

        if not all_files:
            print("âš ï¸ ì´ë¯¸ì§€ í´ë”ì— ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
            raise Exception("No image files in directory")

        # ì •ë ¬(ê¸°ë³¸: ì´ë¦„ìˆœ) + í•„ìš”í•˜ë©´ ì—¬ê¸°ì—ì„œ ë„¤ê°€ ì›í•˜ëŠ” ì •ë ¬ ê·œì¹™ ì¶”ê°€ ê°€ëŠ¥
        all_files.sort()

        print("ğŸ“‚ ì „ì²´ ì´ë¯¸ì§€ íŒŒì¼ ëª©ë¡:")
        for f in all_files:
            print(" -", f)

        # ì„ì‹œ í´ë”ë¡œ ë³µì‚¬
        copied_paths = []
        for f in all_files:
            src = os.path.join(image_dir, f)
            dst = os.path.join(temp_dir, f)
            shutil.copy2(src, dst)
            copied_paths.append(dst)

        print("ğŸ“ ì´ë¯¸ì§€ ë³µì‚¬ ì™„ë£Œ:")
        for cp in copied_paths:
            print("  ->", cp)

        # --- ë°°ì¹˜ êµ¬ì„± ---
        # ì²« ë²ˆì§¸ ë°°ì¹˜: 1ì¥
        # ë‘ ë²ˆì§¸ë¶€í„°: ë‚¨ì€ ì´ë¯¸ì§€ë“¤ì„ 10ì¥ì”© ëŠê¸°
        batches = []
        if copied_paths:
            batches.append([copied_paths[0]])          # 1ì¥
            remaining = copied_paths[1:]
            for i in range(0, len(remaining), 10):
                batches.append(remaining[i:i+10])      # ìµœëŒ€ 10ì¥ì”©

        print("ğŸ§® ë°°ì¹˜ êµ¬ì„± ê²°ê³¼:")
        for idx, b in enumerate(batches, start=1):
            print(f" - ë°°ì¹˜ {idx}: {len(b)}ì¥")

        # --- ë°°ì¹˜ ì—…ë¡œë“œ ---
        for idx, batch in enumerate(batches, start=1):
            try:
                # ë°°ì¹˜ ì‚¬ì´ ê°„ê²© (í•„ìš”ì‹œ 20 â†’ 60 ë“±ìœ¼ë¡œ ì¡°ì • ê°€ëŠ¥)
                time.sleep(20)

                img_btn = wait.until(
                    EC.element_to_be_clickable((By.CSS_SELECTOR, "button[data-name='image']"))
                )
                img_btn.click()
                print(f"ğŸ–¼ï¸ ì´ë¯¸ì§€ ë²„íŠ¼ í´ë¦­ (ë°°ì¹˜ {idx}) ì™„ë£Œ")
                human_delay(0.8, 1.3)

                file_input = wait.until(
                    EC.presence_of_element_located((By.CSS_SELECTOR, "input[type='file']"))
                )

                batch_paths_str = "\n".join(batch)
                file_input.send_keys(batch_paths_str)
                print(f"âœ… ì´ë¯¸ì§€ ë°°ì¹˜ {idx} ({len(batch)}ì¥) ì—…ë¡œë“œ ì „ì†¡ ì™„ë£Œ")

                # 2Â·3ë²ˆì§¸ ë°°ì¹˜ì—ì„œ ìŠ¬ë¼ì´ë“œ ì˜µì…˜ í´ë¦­ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                if idx in (2, 3, 4):
                    try:
                        slide_label = WebDriverWait(driver, 30).until(
                            EC.element_to_be_clickable(
                                (By.CSS_SELECTOR, "label.se-image-type-label[for='image-type-slide']")
                            )
                        )
                        driver.execute_script("arguments[0].click();", slide_label)
                        print(f"ğŸ ìŠ¬ë¼ì´ë“œ ì˜µì…˜ í´ë¦­ ì™„ë£Œ (ë°°ì¹˜ {idx})")
                        time.sleep(20)
                        human_delay(1, 2)
                    except Exception as e:
                        print(f"âš ï¸ ìŠ¬ë¼ì´ë“œ ì˜µì…˜ ì„ íƒ ì‹¤íŒ¨ (ë°°ì¹˜ {idx}):", e)

            except Exception as e:
                print(f"âš ï¸ ì´ë¯¸ì§€ ë°°ì¹˜ {idx} ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", e)

        print("âœ… ë³¸ë¬¸ ì´ë¯¸ì§€ ë°°ì¹˜ ì—…ë¡œë“œ ì™„ë£Œ")

    except Exception as e:
        print("âš ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì „ì²´ ì˜¤ë¥˜:", e)

    print("ğŸ‰ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‘ì—… ì™„ë£Œ!")


def publish_one_post(driver, wait, task):
    """
    task: {
      base_dir, reserve_date, reserve_hour, reserve_minute, ...
    }
    í•œ ë²ˆì˜ ê¸€ì“°ê¸° + ì˜ˆì•½ë°œí–‰ ì „ì²´ í”Œë¡œìš°
    """
    base_dir = task["base_dir"]
    reserve_date = task["reserve_date"]
    reserve_hour = task["reserve_hour"]
    reserve_minute = task["reserve_minute"]

    # ê¸€ì“°ê¸° í˜ì´ì§€ ì§„ì…
    WRITE_URL = "https://blog.naver.com/save7777777?Redirect=Write&categoryNo=8"
    driver.get(WRITE_URL)
    print("âœï¸ ìƒˆ ê¸€ì“°ê¸° í˜ì´ì§€ ì§„ì…")
    human_delay(1, 2)

    # --- ì—ë””í„° iframe ---
    iframe = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, "iframe#mainFrame")))
    driver.switch_to.frame(iframe)
    print("âœ… ì—ë””í„° iframe ì§„ì…")
    human_delay(1, 2)

    # ë°œí–‰.txt ì½ê¸°
    title_text, body_text = read_publish_txt_from_dir(base_dir)

    # ======================================================
    # 1) ì œëª© ì…ë ¥ (ë°œí–‰.txt ì²« ì¤„ ì‚¬ìš©)
    # ======================================================
    try:
        title_placeholder = wait.until(
            EC.presence_of_element_located(
                (By.XPATH, "//span[contains(@class,'se-placeholder') and text()='ì œëª©']")
            )
        )

        title_p = title_placeholder.find_element(By.XPATH, "./..")
        title_p.click()
        human_delay(0.5, 1.0)

        active_title = driver.switch_to.active_element

        active_title.send_keys(Keys.CONTROL, "a")
        active_title.send_keys(Keys.DELETE)
        human_delay(0.3, 0.7)

        for ch in title_text:
            active_title.send_keys(ch)
            human_delay(0.03, 0.1)

        driver.execute_script(
            """
            const el = arguments[0];
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('keyup', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            """,
            active_title,
        )

        print("âœ… ì œëª© ì…ë ¥ ì™„ë£Œ")

    except Exception as e:
        print("âŒ ì œëª© ì…ë ¥ ì¤‘ ì˜¤ë¥˜:", e)

    human_delay(1.2, 2.4)

    # ======================================================
    # 2) ë³¸ë¬¸ ì…ë ¥ (ë°œí–‰.txt ë‚˜ë¨¸ì§€ ì¤„ ì „ì²´ ì‚¬ìš©)
    # ======================================================
    try:
        body_placeholder = wait.until(
            EC.presence_of_element_located(
                (
                    By.XPATH,
                    "//span[contains(@class,'se-placeholder') and text()='ê¸€ê°ê³¼ í•¨ê»˜ ë‚˜ì˜ ì¼ìƒì„ ê¸°ë¡í•´ë³´ì„¸ìš”!']",
                )
            )
        )

        body_p = body_placeholder.find_element(By.XPATH, "./..")
        body_p.click()
        human_delay(0.5, 1.0)

        active_body = driver.switch_to.active_element

        active_body.send_keys(Keys.CONTROL, "a")
        active_body.send_keys(Keys.DELETE)
        human_delay(0.3, 0.7)

        for ch in body_text:
            active_body.send_keys(ch)
            human_delay(0.02, 0.08)

        driver.execute_script(
            """
            const el = arguments[0];
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('keyup', { bubbles: true }));
            """,
            active_body,
        )

        print("âœ… ë³¸ë¬¸ ì…ë ¥ ì™„ë£Œ")

    except Exception as e:
        print("âŒ ë³¸ë¬¸ ì…ë ¥ ì¤‘ ì˜¤ë¥˜:", e)

    human_delay(1.5, 2.5)

    # 3) ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì£¼ì„ í•´ì œ ë²„ì „ ì‚¬ìš©)
    upload_images(driver, wait, base_dir)

    # ======================================================
    # 4) ë°œí–‰ + ì˜ˆì•½ë°œí–‰(ì—‘ì…€ Aì—´ ë‚ ì§œ + Iì—´ ì‹œê°„ìœ¼ë¡œ ì„¤ì •)
    # ======================================================
    try:
        human_delay(1, 2)

        # 3) ë°œí–‰ ë²„íŠ¼1 í´ë¦­
        publish_btn = wait.until(
            EC.element_to_be_clickable(
                (By.CSS_SELECTOR, "button.publish_btn__m9KHH")
            )
        )
        publish_btn.click()
        print("ğŸš€ ë°œí–‰ ë²„íŠ¼1 í´ë¦­ ì™„ë£Œ")
        human_delay(2, 3)

        # 4) ì˜ˆì•½ë°œí–‰ ë¼ë””ì˜¤ ì„ íƒ
        try:
            reserve_label = wait.until(
                EC.element_to_be_clickable(
                    (By.CSS_SELECTOR, "label[for='radio_time2']")
                )
            )
            reserve_label.click()
            print("â° ì˜ˆì•½ ë°œí–‰ ë¼ë””ì˜¤ í´ë¦­ ì™„ë£Œ")
            human_delay(1, 2)

            # === ì—‘ì…€ ê¸°ì¤€ìœ¼ë¡œ ì˜ˆì•½ ë‚ ì§œ/ì‹œê°„ ì„¤ì • ===
            set_reserve_datetime(driver, wait, reserve_date, reserve_hour, reserve_minute)

        except TimeoutException:
            print("âš ï¸ ì˜ˆì•½ ë¼ë””ì˜¤(label[for='radio_time2']) ì—†ìŒ â†’ ì¦‰ì‹œë°œí–‰ìœ¼ë¡œ ì§„í–‰")

        # 5) ë°œí–‰ ë²„íŠ¼2(í™•ì¸) í´ë¦­
        confirm_btn = wait.until(
            EC.element_to_be_clickable(
                (By.CSS_SELECTOR, "button.confirm_btn__WEaBq")
            )
        )
        confirm_btn.click()
        print("ğŸš€ ë°œí–‰ ë²„íŠ¼2 í´ë¦­ ì™„ë£Œ")
        human_delay(2, 3)

    except Exception as e:
        print("âŒ ë°œí–‰/ì˜ˆì•½ í´ë¦­ ì˜¤ë¥˜:", e)


def main():
    # 1) ì—‘ì…€ì—ì„œ ì‘ì—… ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    tasks = load_tasks_from_excel(EXCEL_PATH)
    if not tasks:
        print("âš ï¸ ì—‘ì…€ì—ì„œ ë°œí–‰í•  í–‰ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    # 2) ë¸Œë¼ìš°ì €/ë“œë¼ì´ë²„ ì¤€ë¹„
    options = webdriver.ChromeOptions()
    options.add_argument("user-data-dir=C:\\selenium_profile")
    driver = webdriver.Chrome(
        service=Service(ChromeDriverManager().install()),
        options=options
    )
    wait = WebDriverWait(driver, 30)
    driver.maximize_window()

    WRITE_URL = "https://blog.naver.com/save7777777?Redirect=Write&categoryNo=8"
    driver.get(WRITE_URL)
    print("ğŸŸ¢ ë¡œê·¸ì¸ í›„ ì½˜ì†”ì— ok ì…ë ¥")

    # ìµœì´ˆ 1íšŒ ë¡œê·¸ì¸ ëŒ€ê¸°
    while True:
        if input("ë¡œê·¸ì¸ ì™„ë£Œ ì‹œ ok ì…ë ¥: ").strip().lower() == "ok":
            break

    # 3) ì—‘ì…€ í–‰ í•˜ë‚˜ì”© ëŒë©´ì„œ ë°˜ë³µ ë°œí–‰
    try:
        total = len(tasks)
        for idx, task in enumerate(tasks, start=1):
            print("\n" + "=" * 60)
            print(f"â–¶ {idx}/{total}ë²ˆì§¸ ê¸€ ë°œí–‰ ì‹œì‘ (row {task['row_index']}, í´ë”: {task['base_dir']})")

            if not os.path.isdir(task["base_dir"]):
                print(f"âš ï¸ í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ê±´ë„ˆëœ€: {task['base_dir']}")
                continue

            try:
                publish_one_post(driver, wait, task)
            except Exception as e:
                print(f"âŒ {idx}ë²ˆì§¸ ê¸€ ë°œí–‰ ì¤‘ ì˜ˆì™¸:", e)

            # ë°œí–‰ í›„ 30ì´ˆ ëŒ€ê¸°í•œ ë’¤ ë‹¤ìŒ ê¸€ë¡œ
            print("â± ë‹¤ìŒ ê¸€ë¡œ ë„˜ì–´ê°€ê¸° ì „ 30ì´ˆ ëŒ€ê¸°...")
            time.sleep(30)

    finally:
        human_delay(3, 4)
        driver.quit()
        print("ğŸ‰ ëª¨ë“  ì‘ì—… ì™„ë£Œ!")


if __name__ == "__main__":
    main()
import tkinter as tk
from tkinter import filedialog, messagebox
import pandas as pd
import numpy as np
import io

APP_TITLE = "ìƒìœ„ë…¸ì¶œ í•„í„°"

# --------- ìœ í‹¸ ---------
def _read_raw_noheader(in_path: str) -> pd.DataFrame:
    try:
        return pd.read_excel(in_path, header=None)
    except Exception as e:
        raise RuntimeError(f"ì—‘ì…€ ì½ê¸° ì˜¤ë¥˜: {e}")

def _filter_rows_by_F_rank(df: pd.DataFrame) -> pd.DataFrame:
    """Fì—´(ì¸ë±ìŠ¤ 5)ì´ 'ìˆ«ì+ìœ„'ë¡œ ëë‚˜ëŠ” í–‰ë§Œ."""
    if df.shape[1] <= 10:
        raise RuntimeError("ì—´ ìˆ˜ ë¶€ì¡±: ìµœì†Œ 11ì—´ í•„ìš”(ì œëª©ì€ ì›ë³¸ 10ë²ˆ ì¸ë±ìŠ¤).")
    f_series = df.iloc[:, 5].astype(str)
    mask = f_series.str.contains(r"\d+\s*ìœ„\s*$", regex=True, na=False)
    return df[mask].reset_index(drop=True)

def _to_md_string(x) -> str:
    """Aì—´ ë‚ ì§œë¥¼ 'M/D' ë¬¸ìì—´(ì• 0 ì—†ìŒ)ë¡œ. ë³€í™˜ ë¶ˆê°€/ë¹ˆì¹¸ì€ ''."""
    dt = pd.to_datetime(x, errors='coerce')
    if pd.isna(dt):
        s = "" if (x is None or str(x).strip().lower() in {"nan", "none"}) else str(x)
        return s
    return f"{dt.month}/{dt.day}"

def _clean_text_col(col: pd.Series) -> pd.Series:
    """NaNâ†’'' í›„ str. 'nan'/'none'(ëŒ€ì†Œë¬¸ì ë¬´ê´€) ë‹¨ë… ê°’ë„ ''ë¡œ."""
    col = col.fillna("")
    col = col.astype(str).str.strip()
    col = col.replace(r"(?i)^nan$", "", regex=True)
    col = col.replace(r"(?i)^none$", "", regex=True)
    return col

def build_df_for_paste(df_in: pd.DataFrame) -> pd.DataFrame:
    """
    êµ¬ê¸€ì‹œíŠ¸ ë¶™ì—¬ë„£ê¸°ìš© 16ì—´:
    A:M/D, B..I=ì›ë³¸, J=ì œëª©(ì›ë³¸ 10ì—´), K='O', L/M='FALSE', N/O/P=''
    (ëª¨ë“  nan ì œê±°)
    """
    out = _filter_rows_by_F_rank(df_in)
    cols = [
        out.iloc[:, 0].apply(_to_md_string),  # A (ë‚ ì§œ)
        _clean_text_col(out.iloc[:, 1]),      # B
        _clean_text_col(out.iloc[:, 2]),      # C
        _clean_text_col(out.iloc[:, 3]),      # D
        _clean_text_col(out.iloc[:, 4]),      # E
        _clean_text_col(out.iloc[:, 5]),      # F (~ìœ„)
        _clean_text_col(out.iloc[:, 6]),      # G
        _clean_text_col(out.iloc[:, 7]),      # H
        _clean_text_col(out.iloc[:, 8]),      # I
        _clean_text_col(out.iloc[:,10]),      # J (ì œëª©)
        pd.Series(['O'] * len(out), index=out.index),      # K
        pd.Series(['FALSE'] * len(out), index=out.index),  # L
        pd.Series(['FALSE'] * len(out), index=out.index),  # M
        pd.Series([''] * len(out), index=out.index),       # N
        pd.Series([''] * len(out), index=out.index),       # O
        pd.Series([''] * len(out), index=out.index),       # P
    ]
    df = pd.concat(cols, axis=1).replace({np.nan: ""})
    df = df.replace(r"(?i)^nan$", "", regex=True).replace(r"(?i)^none$", "", regex=True)
    return df

def copy_df_to_clipboard_as_tsv(root: tk.Tk, df_out: pd.DataFrame):
    """íƒ­êµ¬ë¶„ í…ìŠ¤íŠ¸ë¡œ í´ë¦½ë³´ë“œ ë³µì‚¬ â†’ êµ¬ê¸€ì‹œíŠ¸ì—ì„œ Ctrl+V."""
    buf = io.StringIO()
    df_out.to_csv(buf, sep="\t", index=False, header=False, lineterminator="\n")
    txt = buf.getvalue()
    root.clipboard_clear()
    root.clipboard_append(txt)
    root.update()

# --------- GUI ---------
class App:
    def __init__(self, root):
        self.root = root
        self.root.title(APP_TITLE)
        self.root.geometry("520x160")

        self.path = None
        self.df_out = None

        # ìƒë‹¨: ìƒíƒœ/ì•ˆë‚´
        self.status_var = tk.StringVar(value="ì—‘ì…€ì„ ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.")
        tk.Label(root, textvariable=self.status_var, fg="#333").pack(pady=(12,4))

        # ë²„íŠ¼ 2ê°œ
        btns = tk.Frame(root)
        btns.pack(pady=8)
        tk.Button(btns, text="ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°", width=18, command=self.load_excel).grid(row=0, column=0, padx=8)
        self.btn_paste = tk.Button(btns, text="êµ¬ê¸€ì‹œíŠ¸ ë¶™ì—¬ë„£ê¸°", width=18, command=self.paste_to_sheet, state=tk.DISABLED)
        self.btn_paste.grid(row=0, column=1, padx=8)

        # íŒŒì¼ëª… í‘œì‹œ
        self.file_var = tk.StringVar(value="")
        tk.Label(root, textvariable=self.file_var, fg="#666", wraplength=480).pack(pady=(6,0))

    def load_excel(self):
        path = filedialog.askopenfilename(
            title="ì—‘ì…€ ì„ íƒ",
            filetypes=[("Excel Files", "*.xlsx;*.xls")]
        )
        if not path:
            return
        try:
            raw = _read_raw_noheader(path)
            self.df_out = build_df_for_paste(raw)
            self.path = path
            self.file_var.set(f"ë¶ˆëŸ¬ì˜´: {os.path.basename(path)}")
            self.status_var.set(f"ì¤€ë¹„ ì™„ë£Œ: {len(self.df_out)}í–‰ 'êµ¬ê¸€ì‹œíŠ¸ ë¶™ì—¬ë„£ê¸°' ë²„íŠ¼ í´ë¦­ í›„ êµ¬ê¸€ì‹œíŠ¸ì— ctrl+ví•˜ê¸°")
            self.btn_paste.config(state=tk.NORMAL)
        except Exception as e:
            self.df_out = None
            self.btn_paste.config(state=tk.DISABLED)
            messagebox.showerror("ì˜¤ë¥˜", str(e))
            self.status_var.set("ì—‘ì…€ì„ ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.")

    def paste_to_sheet(self):
        if self.df_out is None or self.df_out.empty:
            messagebox.showinfo("ì•Œë¦¼", "ë¨¼ì € ì—‘ì…€ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.")
            return
        try:
            copy_df_to_clipboard_as_tsv(self.root, self.df_out)
            messagebox.showinfo("ì™„ë£Œ", f"í´ë¦½ë³´ë“œë¡œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.\nêµ¬ê¸€ ì‹œíŠ¸ì—ì„œ Ctrl+V í•˜ì„¸ìš”. (í–‰ ìˆ˜: {len(self.df_out)})")
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", str(e))

if __name__ == "__main__":
    import os
    root = tk.Tk()
    App(root)
    root.mainloop()
import time
import random
import pandas as pd
import os
import time
import tkinter as tk
import threading
from tkinter import ttk,messagebox
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from datetime import datetime
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from urllib.parse import urljoin  
from urllib.parse import urlparse  
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException
from selenium import webdriver
from selenium.webdriver.common.by import By
from openai import OpenAI
from selenium.common.exceptions import WebDriverException
from tkinter import filedialog


from captcha import (
    get_captcha_image_base64,
    solve_captcha,
    try_captcha,
    is_captcha_page,
    handle_captcha_if_needed,
)



# ì´ë¯¸ BESTë¥¼ ìˆ˜ì§‘í•´ì„œ ë°©ë¬¸í•œ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´/ë¸Œëœë“œìŠ¤í† ì–´ í‚¤
VISITED_STORE_KEYS = set()
FORBIDDEN_KEYWORDS = set()
START_URL = "https://search.shopping.naver.com/search/category/100000005"
SCROLL_COUNT = 5                    # ê° í˜ì´ì§€ë§ˆë‹¤ ìŠ¤í¬ë¡¤ 5ë²ˆ
SCROLL_DELAY_RANGE = (1.0, 2.0)     # ìŠ¤í¬ë¡¤ ì‚¬ì´ ëœë¤ ëŒ€ê¸° (ì´ˆ)

# ğŸ‘‡ í´ë¦­ í›„ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„ ë²”ìœ„(ì´ˆ) â€“ í•„ìš”í•˜ë©´ ìˆ«ìë§Œ ë°”ê¿”ì„œ íŠœë‹
CLICK_DELAY_RANGE = (1.5, 3.0)

SKIP_MALL_ALTS = {
    "Gë§ˆì¼“", "ì˜¥ì…˜", "ì¿ íŒ¡", "CJì˜¨ìŠ¤íƒ€ì¼", "SSGë‹·ì»´", "ë¡¯ë°í™ˆì‡¼í•‘",
    "11ë²ˆê°€", "í˜„ëŒ€Hmall", "GSSHOP", "ì‹ ì„¸ê³„ëª°", "ì»¬ë¦¬", "í™ˆì•¤ì‡¼í•‘","ë¡¯ë°ON","ì˜¤ëŠ˜ì˜ì§‘","ì‚¼ì„±ë‹·ì»´","ì§€ê·¸ì¬ê·¸",
    "ì‚¼ì„±ë‹·ì»´", "AKëª°", "LFëª°", "íƒ‘í…ëª°", "ë¬´ì‹ ì‚¬", "ìŠ¤íƒ€ì¼ë‚œë‹¤", "Wì»¨ì…‰", "29CM", "ë¸Œëœë””",
    "SKìŠ¤í† ì•„","í•˜ì´ë§ˆíŠ¸ì‡¼í•‘ëª°","ë¡¯ë°ON"

}

client = None
MAX_RETRY = 10  # ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜

API_KEY_FILE = "openai_api_key.txt"  # ê°™ì€ í´ë”ì— ì €ì¥ë  íŒŒì¼ ì´ë¦„


# ---- í¬ë¡¤ëŸ¬/GUI ê³µìœ  ìƒíƒœ ----
driver = None          # í¬ë¡¬ ë“œë¼ì´ë²„ ì¸ìŠ¤í„´ìŠ¤
crawl_thread = None    # ë°±ê·¸ë¼ìš´ë“œ ìˆ˜ì§‘ ì“°ë ˆë“œ
STOP_REQUESTED = False # ì¤‘ë‹¨ ìš”ì²­ í”Œë˜ê·¸
forbidden_path_var = None  # ê¸ˆì¹™ì–´ íŒŒì¼ ê²½ë¡œ (ë‚˜ì¤‘ì— ì´ˆê¸°í™”)
client = None   # â† ì—¬ê¸°ê¹Œì§€ë§Œ



def start_collect():
    global STOP_REQUESTED, crawl_thread, CLICK_DELAY_RANGE

    if driver is None:
        messagebox.showerror("ì—ëŸ¬", "ë¨¼ì € [ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ]ìœ¼ë¡œ í¬ë¡¬ì„ ì—´ì–´ì£¼ì„¸ìš”.")
        return

    # âœ… 0) API Key ì½ì–´ì„œ client ìƒì„±
    api_key = key_entry.get().strip()
    if not api_key:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ë¨¼ì € API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return

    try:
        client = OpenAI(api_key=api_key)
        gui_log("[INFO] OpenAI API Key ì„¤ì • ì™„ë£Œ")
    except Exception as e:
        messagebox.showerror("API ì—ëŸ¬", f"API Key ì„¤ì • ì¤‘ ì˜¤ë¥˜: {e}")
        return
    # 1) í˜ì´ì§€ ë²”ìœ„
    try:
        start_page = int(start_page_var.get())
        end_page   = int(end_page_var.get())
    except Exception:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ì‹œì‘/ë í˜ì´ì§€ëŠ” ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return

    if start_page <= 0 or end_page < start_page:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "í˜ì´ì§€ ë²”ìœ„ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return

    # 2) ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ í¬í•¨ ì—¬ë¶€
    include_brand_catalog = (link_option_var.get() == "include")
     # â­ 2-1) ê´‘ê³  í¬í•¨ ì—¬ë¶€ 
    include_ads = (ad_option_var.get() == "include")

    # 3) í´ë¦­ ê°„ê²©
    try:
        min_click = float(min_click_sec_var.get())
        max_click = float(max_click_sec_var.get())
        if min_click < 0 or max_click < min_click:
            raise ValueError
    except Exception:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "í´ë¦­ ê°„ê²©(ìµœì†Œ/ìµœëŒ€)ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return

    CLICK_DELAY_RANGE = (min_click, max_click)

    # 4) ê¸ˆì¹™ì–´ íŒŒì¼ ê²½ë¡œ
    forbidden_file_path = forbidden_path_var.get().strip() or None

    # 5) ì´ë¯¸ ëŒê³  ìˆëŠ”ì§€ ì²´í¬
    if crawl_thread is not None and crawl_thread.is_alive():
        messagebox.showwarning("ì•Œë¦¼", "ì´ë¯¸ ìˆ˜ì§‘ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.")
        return

    STOP_REQUESTED = False
    start_button.config(state="disabled")
    stop_button.config(state="normal")

    gui_log(f"[INFO] ìˆ˜ì§‘ ì‹œì‘: {start_page}~{end_page}í˜ì´ì§€ / ë¸Œëœë“œì¹´íƒˆë¡œê·¸={'í¬í•¨' if include_brand_catalog else 'ì œì™¸'}")

    def worker():
        try:
            run_crawler(start_page, end_page, include_brand_catalog, forbidden_file_path,include_ads=include_ads)
        finally:
            root.after(0, lambda: start_button.config(state="normal"))
            root.after(0, lambda: stop_button.config(state="disabled"))

    crawl_thread = threading.Thread(target=worker, daemon=True)
    crawl_thread.start()

def stop_collect():
    global STOP_REQUESTED, crawl_thread

    if crawl_thread is None or not crawl_thread.is_alive():
        messagebox.showinfo("ì¤‘ë‹¨", "í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ìˆ˜ì§‘ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    STOP_REQUESTED = True
    gui_log("[INFO] ì¤‘ë‹¨ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. í˜„ì¬ í˜ì´ì§€ ì‘ì—…ì´ ëë‚˜ë©´ ë©ˆì¶œ ê±°ì˜ˆìš”.")


def get_mall_name_for_link(link_element):
    """
    ìƒí’ˆ ì œëª©/ì´ë¯¸ì§€ <a> ìš”ì†Œì—ì„œ ê°™ì€ ì¹´ë“œ ì•ˆì˜
    ëŒ€í‘œ ëª° ì´ë¦„(ì´ë¯¸ì§€ alt ë˜ëŠ” í…ìŠ¤íŠ¸)ì„ ì¶”ì¶œ.
    ëª» ì°¾ìœ¼ë©´ "" ë°˜í™˜.
    """
    try:
        # ìƒí’ˆ ì¹´ë“œ(div.product_item__... í˜¹ì€ ê´‘ê³  ì¹´ë“œ)ê¹Œì§€ ì˜¬ë¼ê°€ê¸°
        card = link_element.find_element(
            By.XPATH,
            './ancestor::div[contains(@class, "product_item__") or contains(@class, "adProduct_item__")][1]'
        )
    except Exception:
        return ""

    try:
        # ì¹´ë“œ ì•ˆì—ì„œ ëª° ì˜ì—­ ì°¾ê¸°
        mall_title_div = card.find_element(
            By.CSS_SELECTOR,
            'div[class^="product_mall_title__"]'
        )
    except Exception:
        return ""

    # 1ìˆœìœ„: ì´ë¯¸ì§€ alt (ì¿ íŒ¡, Gë§ˆì¼“ ë“±)
    try:
        img = mall_title_div.find_element(By.TAG_NAME, "img")
        mall_name = (img.get_attribute("alt") or "").strip()
        if mall_name:
            return mall_name
    except Exception:
        pass

    # 2ìˆœìœ„: í…ìŠ¤íŠ¸
    try:
        text = mall_title_div.text.strip()
        return text
    except Exception:
        return ""

def is_preorder_product_link(link_element):
    """
    ì¹´í…Œê³ ë¦¬(ê²€ìƒ‰) í˜ì´ì§€ì—ì„œ:
    - ìƒí’ˆ ì œëª© ì˜ì—­(div.product_title__ ë˜ëŠ” div.adProduct_title__) ì•ˆì—
    - 'ì˜ˆì•½êµ¬ë§¤'ë¼ê³  ì íŒ buttonì´ ìˆìœ¼ë©´ True ë°˜í™˜ (ìˆ˜ì§‘ì—ì„œ ì œì™¸)

    link_element: ê²€ìƒ‰ê²°ê³¼ì˜ <a> íƒœê·¸ (product_link__*, adProduct_link__* ë“±)
    """
    try:
        # ì´ ë§í¬ê°€ ì†í•œ ì œëª© ì˜ì—­ div (ìƒí’ˆ/ê´‘ê³  ë‘˜ ë‹¤ ëŒ€ì‘)
        title_div = link_element.find_element(
            By.XPATH,
            './ancestor::div[contains(@class, "product_title__") or contains(@class, "adProduct_title__")][1]'
        )
    except Exception:
        # ì œëª© ì˜ì—­ì„ ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ ì˜ˆì•½êµ¬ë§¤ë¡œ ë³´ì§€ ì•ŠìŒ
        return False

    try:
        # ì œëª© ì˜ì—­ ì•ˆì˜ ëª¨ë“  ë²„íŠ¼ í…ìŠ¤íŠ¸ í™•ì¸
        buttons = title_div.find_elements(By.TAG_NAME, "button")
        for btn in buttons:
            text = (btn.text or "").strip()
            if "ì˜ˆì•½êµ¬ë§¤" in text:
                try:
                    name = (link_element.get_attribute("title") or link_element.text or "").strip()
                except Exception:
                    name = ""
                print(f"[SKIP] ì˜ˆì•½êµ¬ë§¤ ìƒí’ˆì´ë¼ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŒ: {name}")
                return True
    except Exception:
        pass

    return False

def is_skip_mall_for_link(link_element):
    """
    ë§í¬ê°€ ì†í•œ ìƒí’ˆ ì¹´ë“œì˜ ëª° ì´ë¦„ì´ SKIP_MALL_ALTSì— í•´ë‹¹í•˜ë©´ True.
    (Gë§ˆì¼“, ì¿ íŒ¡, 11ë²ˆê°€, ë¬´ì‹ ì‚¬ ë“± ì˜¤í”ˆë§ˆì¼“/ì œì™¸ëª° ìŠ¤í‚µìš©)
    """
    mall_name = get_mall_name_for_link(link_element)
    if not mall_name:
        return False

    for skip in SKIP_MALL_ALTS:
        if skip and skip in mall_name:
            print(f"[SKIP] ì œì™¸ ëª°({mall_name}) ìƒí’ˆì´ë¼ í´ë¦­í•˜ì§€ ì•ŠìŒ")
            return True

    return False


def gui_log(msg: str):
    print(msg)
    try:
        log_text.insert("end", msg + "\n")
        log_text.see("end")
    except Exception:
        pass




def get_store_key(url: str) -> str:
    """
    smartstore / brandstore URLì—ì„œ
    'ë„ë©”ì¸/ì²«ë²ˆì§¸ path ì¡°ê°'ë§Œ ë–¼ì–´ì„œ ìŠ¤í† ì–´ë¥¼ ëŒ€í‘œí•˜ëŠ” í‚¤ë¡œ ì‚¬ìš©
    """
    try:
        parsed = urlparse(url)
        path = (parsed.path or "").strip("/")
        first = path.split("/", 1)[0] if path else ""
        return f"{parsed.netloc}/{first}"
    except Exception:
        return url


def append_to_csv_incremental(records, filename):
    """
    í”„ë¡œê·¸ë¨ ë„ì¤‘ êº¼ì ¸ë„ ë‚¨ë„ë¡,
    ìƒˆë¡œ ìˆ˜ì§‘ëœ ë ˆì½”ë“œë¥¼ ë°”ë¡œë°”ë¡œ CSVì— ì¶”ê°€ ì €ì¥í•˜ëŠ” í•¨ìˆ˜.
    - records: [{...}, {...}] í˜•íƒœ
    - filename: ì €ì¥í•  CSV íŒŒì¼ ì´ë¦„
    """
    if not records:
        return

    df = pd.DataFrame(records)

    # íŒŒì¼ì´ ì—†ìœ¼ë©´ header í¬í•¨, ìˆìœ¼ë©´ header ì—†ì´ ì´ì–´ì“°ê¸°
    header = not os.path.exists(filename)

    df.to_csv(
        filename,
        mode="a",              # ì´ì–´ì“°ê¸°
        header=header,
        index=False,
        encoding="utf-8-sig"
    )

def is_adult_product_element(link_element):
    """
    ê²€ìƒ‰ê²°ê³¼ì˜ ì œëª©/ì´ë¯¸ì§€ <a> ìš”ì†Œì—ì„œ
    ê°™ì€ ìƒí’ˆ ì¹´ë“œ ì•ˆì— 'ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ' ë°°ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì„œ
    19ê¸ˆì´ë©´ True, ì•„ë‹ˆë©´ False ë¦¬í„´
    """
    try:
        # ì´ a íƒœê·¸ê°€ ì†í•œ ìƒí’ˆ ì¹´ë“œ(div.product_item__...)ê¹Œì§€ ìœ„ë¡œ ì˜¬ë¼ê°€ê¸°
        card = link_element.find_element(
            By.XPATH,
            './ancestor::div[contains(@class, "product_item__")][1]'
        )
    except Exception:
        # ìƒí’ˆ ì¹´ë“œ êµ¬ì¡° ì•„ë‹ˆë©´ ê·¸ëƒ¥ ì„±ì¸ìƒí’ˆ ì•„ë‹˜ ì²˜ë¦¬
        return False

    # 1) class ì´ë¦„ìœ¼ë¡œ ì„±ì¸ ë°°ì§€ ì°¾ê¸°
    try:
        card.find_element(By.CSS_SELECTOR, 'span[class^="adultBlock_teenager__"]')
        return True
    except Exception:
        pass

    # 2) ì‹œê°ì¥ì• ì¸ìš© í…ìŠ¤íŠ¸ 'ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ' ì°¾ê¸° (ì•ˆì „ë§)
    try:
        blind_spans = card.find_elements(By.CSS_SELECTOR, 'span.blind')
        for sp in blind_spans:
            if "ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ" in (sp.text or ""):
                return True
    except Exception:
        pass

    return False

def load_forbidden_keywords_from_path(path: str):
    """
    GUIì—ì„œ ì „ë‹¬ë°›ì€ ê¸ˆì¹™ì–´ íŒŒì¼ ê²½ë¡œë¥¼ ì´ìš©í•´
    FORBIDDEN_KEYWORDS ì„¸íŠ¸ë¥¼ ê°±ì‹ í•œë‹¤.
    (pathê°€ None/ë¹ˆë¬¸ìì—´ì´ë©´ ê¸ˆì¹™ì–´ ê¸°ëŠ¥ ë¯¸ì‚¬ìš©)
    """
    global FORBIDDEN_KEYWORDS

    if not path:
        gui_log("[INFO] ê¸ˆì§€ì–´ íŒŒì¼ ë¯¸ì‚¬ìš©")
        FORBIDDEN_KEYWORDS = set()
        return

    try:
        with open(path, "r", encoding="utf-8") as f:
            text = f.read()
    except Exception as e:
        gui_log(f"[WARN] ê¸ˆì§€ì–´ íŒŒì¼ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: {e}")
        FORBIDDEN_KEYWORDS = set()
        return

    raw_parts = []
    for line in text.splitlines():
        raw_parts.extend(line.split(";"))

    words = {p.strip() for p in raw_parts if p.strip()}
    FORBIDDEN_KEYWORDS = words
    gui_log(f"[INFO] ê¸ˆì§€ì–´ {len(words)}ê°œ ë¡œë“œ ì™„ë£Œ")

def load_forbidden_keywords():
    """
    ê¸ˆì§€ì–´ íŒŒì¼ì—ì„œ 'ê¸ˆì§€ì–´1;ê¸ˆì§€ì–´2;ê¸ˆì§€ì–´3;' í˜•ì‹ìœ¼ë¡œ ë‹¨ì–´ë¥¼ ì½ì–´ì„œ
    FORBIDDEN_KEYWORDS ì„¸íŠ¸ë¡œ ì €ì¥.
    - ì¤„ë°”ê¿ˆ ìƒê´€ ì—†ìŒ
    - ê³µë°±/ë¹ˆ í•­ëª©ì€ ìë™ ì œê±°
    """
    path = input("ê¸ˆì§€ì–´ íŒŒì¼ ê²½ë¡œ (ì—”í„° ì‹œ ì‚¬ìš© ì•ˆ í•¨) â†’ ").strip().strip('"')

    if not path:
        print("ê¸ˆì§€ì–´ íŒŒì¼ì´ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸ˆì§€ì–´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return set()

    try:
        with open(path, "r", encoding="utf-8") as f:
            text = f.read()
    except Exception as e:
        print(f"[ê²½ê³ ] ê¸ˆì§€ì–´ íŒŒì¼ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: {e}")
        return set()

    raw_parts = []
    for line in text.splitlines():
        raw_parts.extend(line.split(";"))

    words = {p.strip() for p in raw_parts if p.strip()}
    print(f"[INFO] ê¸ˆì§€ì–´ {len(words)}ê°œ ë¡œë“œ ì™„ë£Œ: {', '.join(list(words)[:10])} ...")
    return words


def is_forbidden_name(name: str) -> bool:
    """
    ìƒí’ˆëª…ì— ê¸ˆì§€ì–´ê°€ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ True.
    (ë¶€ë¶„ ë¬¸ìì—´ ê¸°ì¤€, ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ â€“ í•œê¸€ì€ ê·¸ëŒ€ë¡œ ë¹„êµ)
    """
    if not FORBIDDEN_KEYWORDS:
        return False
    if not name:
        return False

    name_norm = name.lower()
    for kw in FORBIDDEN_KEYWORDS:
        if not kw:
            continue
        if kw.lower() in name_norm:
            return True
    return False

def collect_best_products_on_all_products_page(driver):
    """
    í˜„ì¬ í˜ì´ì§€(ì „ì²´ìƒí’ˆ í˜ì´ì§€)ì—ì„œ BEST ë±ƒì§€ê°€ ë¶™ì€ ìƒí’ˆë“¤ì„ ìˆ˜ì§‘.
    ë¸Œëœë“œìŠ¤í† ì–´/ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ì˜ ë¦¬ìŠ¤íŠ¸í˜•, ê·¸ë¦¬ë“œí˜• êµ¬ì¡°ë¥¼ ëª¨ë‘ ëŒ€ì‘í•˜ë„ë¡ ê°œì„ í•¨.
    """
    best_items = []
    seen_hrefs = set()
    
    # 1. BEST ë±ƒì§€ê°€ í¬í•¨ëœ ëª¨ë“  'ìƒí’ˆ ì¹´ë“œ(li)'ë¥¼ ë¨¼ì € ì°¾ìŠµë‹ˆë‹¤.
    # (BEST ë±ƒì§€ê°€ ìˆëŠ” emì˜ ì¡°ìƒ ì¤‘ li íƒœê·¸ë¥¼ ì°¾ìŒ)
    product_cards = driver.find_elements(
        By.XPATH,
        '//li[descendant::em[contains(normalize-space(.), "BEST")]]'
    )

    print(f"[DEBUG] BEST ë±ƒì§€ê°€ ìˆëŠ” ìƒí’ˆ ì¹´ë“œ {len(product_cards)}ê°œ ë°œê²¬")

    for card in product_cards:
        # --- 0. ğŸ” ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ ë§ˆí¬ í™•ì¸ ë° ê±´ë„ˆë›°ê¸° ---
        try:
            # 'adultBlock_teenager__iVi6S' í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            # ìš”ì†Œê°€ ë°œê²¬ë˜ë©´ 19ê¸ˆ ìƒí’ˆì…ë‹ˆë‹¤.
            card.find_element(By.CLASS_NAME, "adultBlock_teenager__iVi6S")
            
            # 19ê¸ˆ ë§ˆí¬ê°€ ë°œê²¬ëœ ê²½ìš°, ìƒí’ˆëª…ì„ ì¶”ì¶œí•˜ì—¬ ì¶œë ¥í•˜ê³  ê±´ë„ˆëœë‹ˆë‹¤.
            try:
                # ìƒí’ˆëª…ì€ ì¶œë ¥ìš©ìœ¼ë¡œë§Œ ì‚¬ìš© (ì¶”ì¶œ ì‹¤íŒ¨í•´ë„ ìƒê´€ì—†ìŒ)
                product_name = card.find_element(By.XPATH, './/a[contains(@href, "/products/")]').get_attribute("title")
            except NoSuchElementException:
                product_name = "ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ìƒí’ˆ"
                
            print(f"[SKIP] ëª©ë¡ì—ì„œ 19ê¸ˆ ìƒí’ˆ ë§ˆí¬ í™•ì¸: {product_name}")
            continue # 19ê¸ˆ ìƒí’ˆì´ë¯€ë¡œ ë‹¤ìŒ ìƒí’ˆìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
            
        except NoSuchElementException:
            # 'adultBlock_teenager__iVi6S' ìš”ì†Œê°€ ì—†ìœ¼ë©´, 19ê¸ˆ ìƒí’ˆì´ ì•„ë‹ˆë¯€ë¡œ í†µê³¼
            pass
        # -------------------------------------------------------------------

        try:
            # 2. ë§í¬(href) ì¶”ì¶œ
            # ì¹´ë“œ ë‚´ë¶€ì—ì„œ /products/ê°€ í¬í•¨ëœ a íƒœê·¸ë¥¼ ì°¾ìŒ
            try:
                link_element = card.find_element(By.XPATH, './/a[contains(@href, "/products/")]')
                raw_href = link_element.get_attribute("href")
            except Exception:
                continue # ë§í¬ ì—†ìœ¼ë©´ ìŠ¤í‚µ

            if not raw_href:
                continue
                
            # ìƒëŒ€ ê²½ë¡œì¼ ê²½ìš° ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
            href = urljoin(driver.current_url, raw_href)

            if href in seen_hrefs:
                continue
            seen_hrefs.add(href)

            # 3. ìƒí’ˆëª…(Title) ì¶”ì¶œ
            title = ""
            try:
                # strong íƒœê·¸ ìš°ì„  ê²€ìƒ‰
                title_el = card.find_element(By.TAG_NAME, "strong")
                title = title_el.text.strip()
            except Exception:
                # ì‹¤íŒ¨ ì‹œ ì´ë¯¸ì§€ì˜ alt ì†ì„± ì‹œë„
                try:
                    img = card.find_element(By.TAG_NAME, "img")
                    title = img.get_attribute("alt").strip()
                except:
                    title = "ì œëª© ì—†ìŒ"

            # ê¸ˆì§€ì–´ ì²´í¬ (ê¸°ì¡´ ë¡œì§)
            if is_forbidden_name(title):
                print(f"[SKIP] ê¸ˆì§€ì–´ í¬í•¨ ìƒí’ˆ ìŠ¤í‚µ: {title}")
                continue

            best_items.append({
                "href": href,
                "text": title,
            })
            
        except Exception as e:
            # BEST ë±ƒì§€ ì™¸ì— ë‹¤ë¥¸ ì´ìœ ë¡œ íŒŒì‹± ì‹¤íŒ¨ ì‹œ
            print(f"[ERROR] ìƒí’ˆ íŒŒì‹± ì¤‘ ì˜¤ë¥˜: {e}")
            continue

    print(f"[INFO] ì „ì²´ìƒí’ˆ í˜ì´ì§€ì—ì„œ BEST {len(best_items)}ê°œ ìˆ˜ì§‘ ì™„ë£Œ")
    return best_items

def collect_best_from_current_store(driver, base_kind: str, is_brand_catalog: bool):
    """
    í˜„ì¬ íƒ­ì´ smartstore / brandstore ìƒí’ˆ(ë˜ëŠ” ìŠ¤í† ì–´) í˜ì´ì§€ë¼ê³  ê°€ì •í•˜ê³ ,
    - ìŠ¤í† ì–´ í‚¤ë¥¼ ë§Œë“  ë’¤, ì´ë¯¸ ë°©ë¬¸í•œ ìŠ¤í† ì–´ë©´ ìŠ¤í‚µ
    - ì²˜ìŒ ë°©ë¬¸í•˜ëŠ” ìŠ¤í† ì–´ë©´
        1) ì „ì²´ìƒí’ˆìœ¼ë¡œ ì´ë™(go_to_all_products_if_exists)
        2) BEST ìƒí’ˆë“¤ ìˆ˜ì§‘(collect_best_products_on_all_products_page)
    ë°˜í™˜: collect_naver_linksì—ì„œ ê·¸ëŒ€ë¡œ extend í•  ìˆ˜ ìˆëŠ” record ë¦¬ìŠ¤íŠ¸
    """
    final_url = driver.current_url
    store_key = get_store_key(final_url)

    if store_key in VISITED_STORE_KEYS:
        print(f"[SKIP] ì´ë¯¸ BESTë¥¼ ìˆ˜ì§‘í•œ ìŠ¤í† ì–´ì…ë‹ˆë‹¤: {store_key}")
        return []

    VISITED_STORE_KEYS.add(store_key)
    print(f"[STORE] ìƒˆ ìŠ¤í† ì–´ ì§„ì… â†’ {store_key}")

    # ì „ì²´ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¦¬í„´)
    go_to_all_products_if_exists(driver)

    best_items = collect_best_products_on_all_products_page(driver)

    records = []
    for item in best_items:
        records.append({
            "kind": base_kind,            # "ad" ë˜ëŠ” "product"
            "text": item["text"],         # BEST ìƒí’ˆ ì´ë¦„
            "href": item["href"],         # BEST ìƒí’ˆ ë§í¬
            "brand_catalog": is_brand_catalog,
            "store": store_key,           # ì–´ëŠ ìŠ¤í† ì–´ì—ì„œ ë‚˜ì˜¨ BESTì¸ì§€
        })
    return records


def create_driver():
    """í¬ë¡¬ ë“œë¼ì´ë²„ ìƒì„±"""
    options = webdriver.ChromeOptions()
    options.add_argument("--start-maximized")  # ì°½ ìµœëŒ€í™”
    driver = webdriver.Chrome(
        service=Service(ChromeDriverManager().install()),
        options=options
    )
    return driver


def wait_for_ok():
    """
    ë„ˆê°€ í¬ë¡¬ì—ì„œ ì¹´í…Œê³ ë¦¬/í•„í„° ë‹¤ ê³ ë¥¸ ë’¤
    CMDì—ì„œ ok ì¹˜ë©´ ì‹œì‘
    """
    user_input = input("ì¹´í…Œê³ ë¦¬/í•„í„° ì„ íƒ ëë‚˜ë©´ 'ok' ì…ë ¥ í›„ ì—”í„° â†’ ")
    if user_input.strip().lower() != "ok":
        print("okê°€ ì•„ë‹ˆë¼ì„œ ë§í¬ ìˆ˜ì§‘ ì—†ì´ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        return False
    return True


def ask_brand_catalog_option():
    """
    'ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸'ê°€ ë¶™ì€ ìƒí’ˆë„ ì €ì¥í• ì§€ ì—¬ë¶€ë¥¼ y/nìœ¼ë¡œ ì…ë ¥ë°›ê¸°
    """
    while True:
        s = input("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ í‘œì‹œëœ ìƒí’ˆ ë§í¬ë„ ì €ì¥í• ê¹Œìš”? (y/n) â†’ ")
        s = s.strip().lower()

        if s in ("y", "yes", "ë„¤", "ã…‡", "ì‘"):
            print("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ìƒí’ˆë„ í¬í•¨í•´ì„œ ì €ì¥í•©ë‹ˆë‹¤.")
            return True
        if s in ("n", "no", "ì•„ë‹ˆ", "ã„´", "ì•„ë‹ˆì˜¤"):
            print("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ìƒí’ˆì€ ì œì™¸í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.")
            return False

        print("y ë˜ëŠ” nìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.")


def ask_page_range():
    """
    ìˆ˜ì§‘í•  í˜ì´ì§€ ë²”ìœ„ ì…ë ¥ë°›ê¸° (ì˜ˆ: 1 5, 11 15)
    """
    while True:
        s = input("ìˆ˜ì§‘í•  í˜ì´ì§€ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1 5) â†’ ")
        parts = s.strip().split()
        if len(parts) != 2:
            print("ë‘ ê°œì˜ ìˆ«ìë¥¼ ë„ì–´ì“°ê¸°ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. ì˜ˆ: 1 5")
            continue
        try:
            start_page = int(parts[0])
            end_page = int(parts[1])
        except ValueError:
            print("ìˆ«ìë¡œ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”. ì˜ˆ: 1 5")
            continue

        if start_page <= 0 or end_page <= 0:
            print("í˜ì´ì§€ ë²ˆí˜¸ëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.")
            continue
        if end_page < start_page:
            print("ë í˜ì´ì§€ëŠ” ì‹œì‘ í˜ì´ì§€ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.")
            continue

        return start_page, end_page


def scroll_page(driver, scroll_count=10, delay_range=(1.0, 2.0)):
    """í˜ì´ì§€ ì•„ë˜ë¡œ ì—¬ëŸ¬ ë²ˆ ìŠ¤í¬ë¡¤í•´ì„œ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë” ë¶ˆëŸ¬ì˜¤ê¸°"""
    body = driver.find_element(By.TAG_NAME, "body")

    for i in range(scroll_count):
        body.send_keys(Keys.END)
        time.sleep(random.uniform(*delay_range))


# ===================== ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„: smartstore ìµœì¢… URL ì–»ê¸° =====================
def resolve_smartstore_urls_by_click(driver, link_element, base_kind, is_brand_catalog):
    """
    ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ì—ì„œ ìƒí’ˆ <a>ë¥¼ í´ë¦­í•´ì„œ ìƒˆ íƒ­/ì°½ìœ¼ë¡œ ì—° ë‹¤ìŒ,
    - smartstore / brandstore ìƒí’ˆìœ¼ë¡œ ë°”ë¡œ ê°€ëŠ” ê²½ìš°:
        â†’ í•´ë‹¹ ìŠ¤í† ì–´ì˜ 'ì „ì²´ìƒí’ˆ' í˜ì´ì§€ì—ì„œ BEST ìƒí’ˆë“¤ì„ ìˆ˜ì§‘
    - catalog í˜ì´ì§€ë¡œ ê°€ëŠ” ê²½ìš°:
        â†’ catalog ì•ˆì˜ smartstore/brandstore ë“¤ì„ ëŒë©° ë™ì¼í•˜ê²Œ BEST ìˆ˜ì§‘
    ë°˜í™˜: BEST ìƒí’ˆ record ë¦¬ìŠ¤íŠ¸
    """
    # ğŸ”’ 0) 19ê¸ˆ(ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ) ìƒí’ˆì´ë©´ ì•„ì˜ˆ í´ë¦­ ì•ˆ í•¨
    if is_adult_product_element(link_element):
        try:
            title = (link_element.get_attribute("title") or link_element.text or "").strip()
        except Exception:
            title = ""
        print(f"[SKIP] ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ(19ê¸ˆ)ì´ë¼ í´ë¦­í•˜ì§€ ì•ŠìŒ: {title}")
        return []
    
        # ğŸ”’ 0-1) ì œì™¸ ëª°(Gë§ˆì¼“, ì¿ íŒ¡, 11ë²ˆê°€ ë“±)ì´ë©´ ì•„ì˜ˆ í´ë¦­ ì•ˆ í•¨
    if is_skip_mall_for_link(link_element):
        # ë¡œê·¸ëŠ” is_skip_mall_for_link ì•ˆì—ì„œ ì¶œë ¥ë¨
        return []
    
    main_handle = driver.current_window_handle
    handles_before = driver.window_handles

    # ì‹¤ì œ í´ë¦­ìœ¼ë¡œ ìƒˆ íƒ­/ì°½ ì—´ê¸°
    driver.execute_script("arguments[0].click();", link_element)
    time.sleep(random.uniform(*CLICK_DELAY_RANGE))

    handles_after = driver.window_handles
    new_handles = [h for h in handles_after if h not in handles_before]
    if new_handles:
        product_handle = new_handles[0]
    else:
        # ìƒˆ íƒ­ì´ ì•ˆ ëœ¨ê³  í˜„ì¬ íƒ­ì´ ë°”ë€Œì—ˆì„ ê°€ëŠ¥ì„± ë°©ì–´
        product_handle = main_handle

    driver.switch_to.window(product_handle)

        # 2) ğŸ” íƒ­ ì „í™˜ ì§í›„, ìº¡ì±  í˜ì´ì§€ì¸ì§€ ë¨¼ì € í™•ì¸
    if not handle_captcha_if_needed(driver):
        # ìº¡ì± ë¥¼ í•´ê²° ëª» í–ˆê±°ë‚˜ ê³„ì† ë‚¨ì•„ ìˆìœ¼ë©´ ì´ ë§í¬ëŠ” ìŠ¤í‚µ
        if product_handle != main_handle:
            driver.close()
            driver.switch_to.window(main_handle)
        return []

    best_records = []

    try:
        final_url = wait_until_redirect_done(driver)


        # 1) smartstore ë¡œ ë°”ë¡œ ê°„ ê²½ìš° â†’ ê¸°ì¡´ ë¡œì§ (ì „ì²´ìƒí’ˆ + BEST)
        if final_url.startswith("https://smartstore.naver.com"):
            best_records.extend(
                collect_best_from_current_store(driver, base_kind, is_brand_catalog)
            )

        # 2) brandstore ë¡œ ë°”ë¡œ ê°„ ê²½ìš° â†’ ë°©ê¸ˆ ë§Œë“  brandstore ì „ìš© í•¨ìˆ˜ ì‚¬ìš©
        elif final_url.startswith("https://brand.naver.com"):
            best_records.extend(
                collect_best_from_current_store(driver, base_kind, is_brand_catalog)
            )

        # 3) catalog í˜ì´ì§€ì— ë„ì°©í•œ ê²½ìš° â†’ ê¸°ì¡´ ë¡œì§ ìœ ì§€
        elif "search.shopping.naver.com/catalog" in final_url:
            best_records.extend(
                find_smartstores_in_catalog_page(driver, base_kind, is_brand_catalog)
            )

        # 4) ê·¸ ì™¸ ë„ë©”ì¸ì€ ëŒ€ìƒ ì•„ë‹˜
        else:
            print("[INFO] smartstore/brandstore/catalogê°€ ì•„ë‹Œ ë§í¬ë¼ ê±´ë„ˆëœë‹ˆë‹¤.")

    finally:
        if product_handle != main_handle:
            driver.close()
            driver.switch_to.window(main_handle)

    return best_records



# =============================================================================


def go_to_all_products_if_exists(driver):
    """
    í˜„ì¬ íƒ­ì´ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ í˜ì´ì§€ë¼ê³  ê°€ì •í•˜ê³ :
    1) 'ë”ë³´ê¸°' ë²„íŠ¼ì´ ë³´ì´ë©´ ë¨¼ì € í´ë¦­
    2) 'ì „ì²´ìƒí’ˆ' ë©”ë‰´ë¥¼ ì°¾ìœ¼ë©´ í´ë¦­
    3) ì „ì²´ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™í•œ ë’¤, ì‚¬ìš©ìê°€ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´
       BESTê°€ ë¶™ì€ ìƒí’ˆë“¤ì˜ ìƒí’ˆí˜ì´ì§€ URL ëª©ë¡ì„ ë¦¬í„´
    - 'ì „ì²´ìƒí’ˆ'ì´ ì•„ì˜ˆ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë¦¬í„´
    """
    best_urls = []
    try:
        wait = WebDriverWait(driver, 5)

        # 1) 'ë”ë³´ê¸°' ë²„íŠ¼ ìˆìœ¼ë©´ í´ë¦­ (ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë„˜ì–´ê°)
        try:
            more_btn = wait.until(
                EC.visibility_of_element_located(
                    (By.XPATH, '//button[contains(normalize-space(.), "ë”ë³´ê¸°")]')
                )
            )
            try:
                driver.execute_script("arguments[0].click();", more_btn)
            except Exception:
                more_btn.click()
            time.sleep(random.uniform(*CLICK_DELAY_RANGE))
        except Exception:
            # ë”ë³´ê¸°ê°€ ì—†ëŠ” ê²½ìš° / ì•ˆ ë³´ì´ëŠ” ê²½ìš°
            pass

        # 2) 'ì „ì²´ìƒí’ˆ' ë§í¬ ì°¾ê¸° (data-name ë˜ëŠ” í…ìŠ¤íŠ¸ë¡œ ê²€ìƒ‰)
        try:
            all_link = driver.find_element(
                By.XPATH,
                '//a[@data-name="ì „ì²´ìƒí’ˆ" or contains(normalize-space(.), "ì „ì²´ìƒí’ˆ")]'
            )
        except Exception:
            print("[INFO] 'ì „ì²´ìƒí’ˆ' ë©”ë‰´ê°€ ì—†ëŠ” ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ì…ë‹ˆë‹¤. ê·¸ëƒ¥ ë„˜ì–´ê°‘ë‹ˆë‹¤.")
            return []

        # 3) 'ì „ì²´ìƒí’ˆ' í´ë¦­
        try:
            driver.execute_script("arguments[0].click();", all_link)
        except Exception:
            all_link.click()

        print("[INFO] 'ì „ì²´ìƒí’ˆ' ë©”ë‰´ í´ë¦­ ì™„ë£Œ. í˜ì´ì§€ í™•ì¸ í›„ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ BEST ìƒí’ˆì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.")
        time.sleep(random.uniform(*CLICK_DELAY_RANGE))  # í•„ìš”í•˜ë©´ 2~5ì´ˆ ì‚¬ì´ë¡œ ì¡°ì ˆ



    except Exception as e:
        print(f"[ê²½ê³ ] ì „ì²´ìƒí’ˆ / BEST ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return []

    return best_urls

def wait_until_redirect_done(driver, max_wait=10):
    """
    cr.shopping.naver.com/adcr ê°™ì€ ì¤‘ê°„ URLì—ì„œ
    ì‹¤ì œ ëª©ì ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê³  ìµœì¢… URL ë°˜í™˜
    """
    last_url = None
    for _ in range(max_wait * 2):  # 0.5ì´ˆ * 20 = ìµœëŒ€ 10ì´ˆ
        cur = driver.current_url
        # ì•„ì§ adcr / cr.shopping ë‹¨ê³„ë©´ ê³„ì† ëŒ€ê¸°
        if "cr.shopping.naver.com" in cur:
            last_url = cur
        else:
            return cur
        time.sleep(random.uniform(*CLICK_DELAY_RANGE))
    # íƒ€ì„ì•„ì›ƒì´ë©´ í˜„ì¬ ì£¼ì†Œ ë°˜í™˜
    return driver.current_url
def find_smartstores_in_catalog_page(driver, base_kind, is_brand_catalog, max_malls=50):
    """
    ì¹´íƒˆë¡œê·¸ í˜ì´ì§€ì˜ íŒë§¤ì²˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ì²˜ìŒë¶€í„° ëê¹Œì§€ ìˆœíšŒí•˜ë©°,
    ì˜¤í”ˆë§ˆì¼“(Gë§ˆì¼“, ì˜¥ì…˜ ë“±)ì„ ì œì™¸í•œ ëª¨ë“  'ë„¤ì´ë²„ ë§í¬(ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´/ë¸Œëœë“œìŠ¤í† ì–´)'ë¥¼ ë°©ë¬¸í•©ë‹ˆë‹¤.
    StaleElement ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ë§¤ë²ˆ ìš”ì†Œë¥¼ ë‹¤ì‹œ ì°¾ìŠµë‹ˆë‹¤.
    """
    catalog_handle = driver.current_window_handle
    results = []

    # 1. ì „ì²´ í–‰(Row) ê°œìˆ˜ë¥¼ ë¨¼ì € íŒŒì•…
    try:
        initial_rows = driver.find_elements(By.CSS_SELECTOR, 'tbody tr')
        total_count = len(initial_rows)
    except Exception:
        print("[INFO] íŒë§¤ì²˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return []
    
    print(f"[INFO] íŒë§¤ì²˜ ë¦¬ìŠ¤íŠ¸ ì´ {total_count}ê°œ ë°œê²¬. ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.")

    # 2. ì¸ë±ìŠ¤(i)ë¡œ ì ‘ê·¼í•˜ì—¬ í•˜ë‚˜ì”© ì²˜ë¦¬ (ì¤‘ê°„ì— ëŠê¹€ ë°©ì§€)
    for i in range(total_count):
        # ë„ˆë¬´ ë§ì´ ìˆ˜ì§‘í•˜ë©´ ì˜¤ë˜ ê±¸ë¦¬ë¯€ë¡œ ì œí•œ (í•„ìš”ì‹œ max_malls ìˆ«ì ì¡°ì ˆ)
        if i >= max_malls:
            print(f"[INFO] ìµœëŒ€ ë°©ë¬¸ ìˆ˜({max_malls}) ë„ë‹¬ë¡œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
            break

        try:
            # â˜… ì¤‘ìš”: íƒ­ì„ ê°”ë‹¤ì˜¤ë©´ DOMì´ ë¶ˆì•ˆì •í•´ì§€ë¯€ë¡œ ë§¤ë²ˆ ë‹¤ì‹œ ì°¾ìŠµë‹ˆë‹¤.
            current_rows = driver.find_elements(By.CSS_SELECTOR, 'tbody tr')
            if i >= len(current_rows):
                break # ë¦¬ìŠ¤íŠ¸ê°€ ì¤„ì–´ë“¤ì—ˆê±°ë‚˜ ë³€ê²½ëœ ê²½ìš° ì¤‘ë‹¨
            
            row = current_rows[i]

            # --- ì—¬ê¸°ì„œë¶€í„° ê¸°ì¡´ í•„í„°ë§ ë¡œì§ ---
            try:
                # ëª° ë§í¬ ì°¾ê¸°
                mall_link = row.find_element(By.CSS_SELECTOR, 'a[class^="productByMall_mall__"]')
                
                # ëª° ì´ë¦„ í™•ì¸ (ì´ë¯¸ì§€ alt ë˜ëŠ” í…ìŠ¤íŠ¸)
                mall_name = ""
                try:
                    img = mall_link.find_element(By.TAG_NAME, "img")
                    mall_name = img.get_attribute("alt").strip()
                except Exception:
                    mall_name = mall_link.text.strip()

                # ì˜¤í”ˆë§ˆì¼“ í•„í„°ë§ (Gë§ˆì¼“, ì˜¥ì…˜, ì¿ íŒ¡ ë“± ìŠ¤í‚µ)
                if any(skip_mall in mall_name for skip_mall in SKIP_MALL_ALTS):
                    # print(f"   Pass: {mall_name}") # ë„ˆë¬´ ì‹œë„ëŸ¬ìš°ë©´ ì£¼ì„ ì²˜ë¦¬
                    continue
                
                print(f"[{i+1}/{total_count}] ë°©ë¬¸ ì‹œë„: {mall_name}")

                # í´ë¦­í•˜ì—¬ ìƒˆ íƒ­ ì—´ê¸°
                driver.execute_script("arguments[0].click();", mall_link)
                time.sleep(random.uniform(*CLICK_DELAY_RANGE))

                # íƒ­ ì „í™˜
                handles_after = driver.window_handles
                new_handles = [h for h in handles_after if h != catalog_handle]

                if new_handles:
                    mall_handle = new_handles[-1]
                    driver.switch_to.window(mall_handle)

                    try:
                        # URL í™•ì¸
                        final_url = wait_until_redirect_done(driver)
                        
                        if final_url.startswith("https://smartstore.naver.com") or final_url.startswith("https://brand.naver.com"):
                            # print(f"   â†’ ìˆ˜ì§‘ ì‹œì‘ ({mall_name})")
                            store_records = collect_best_from_current_store(driver, base_kind, is_brand_catalog)
                            results.extend(store_records)
                        else:
                            # print(f"   â†’ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì•„ë‹˜ ({final_url})")
                            pass
                    
                    except Exception as e:
                        print(f"[ERROR] íƒ­ ë‚´ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

                    finally:
                        # íƒ­ ë‹«ê³  ì¹´íƒˆë¡œê·¸ í˜ì´ì§€ë¡œ ë³µê·€ (í•„ìˆ˜)
                        if driver.current_window_handle != catalog_handle:
                            driver.close()
                        driver.switch_to.window(catalog_handle)
                        # ë³µê·€ í›„ ì ì‹œ ëŒ€ê¸° (í˜ì´ì§€ ì•ˆì •í™”)
                        time.sleep(random.uniform(*CLICK_DELAY_RANGE))

            except Exception as inner_e:
                # ë§í¬ë¥¼ ëª» ì°¾ê±°ë‚˜ í•˜ëŠ” ì†Œì†Œí•œ ì—ëŸ¬ëŠ” ë¬´ì‹œí•˜ê³  ë‹¤ìŒ ë£¨í”„ë¡œ
                continue

        except Exception as e:
            print(f"[ERROR] íŒë§¤ì²˜ ìˆœíšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            continue

    return results

def collect_naver_links(driver, include_brand_catalog=True,include_ads=True, csv_filename_for_realtime=None):
    records = []

    # 0) ì´ í˜ì´ì§€ì—ì„œ "ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸"ë¼ê³  ì°íŒ ëª¨ë“  ë§í¬ href ë¨¼ì € ëª¨ìœ¼ê¸°
    brand_hrefs = set()
    try:
        # em ì•ˆì— "ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸" í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ëª¨ë“  em ì°¾ê¸°
        em_elems = driver.find_elements(
            By.XPATH,
            '//em[contains(normalize-space(.), "ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸")]'
        )
        for em in em_elems:
            try:
                # ê·¸ emì´ ë“¤ì–´ìˆëŠ” ê°€ì¥ ê°€ê¹Œìš´ a íƒœê·¸ë¡œ ì˜¬ë¼ê°€ê¸°
                a_tag = em.find_element(By.XPATH, './ancestor::a[1]')
                href_bc = a_tag.get_attribute("href")
                if href_bc:
                    brand_hrefs.add(href_bc)
            except Exception:
                continue
    except Exception:
        # ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ì˜ì—­ì„ ëª» ì°¾ë”ë¼ë„ ì „ì²´ í¬ë¡¤ë§ì€ ê³„ì†
        pass

     # 1) ê´‘ê³  ì˜ì—­
    if include_ads:
        ad_elements = driver.find_elements(
            By.CSS_SELECTOR,
            'div[class^="adProduct_title__"] a[class^="adProduct_link__"]'
        )
        for el in ad_elements:
            if is_preorder_product_link(el):
                continue
            href = el.get_attribute("href")
            text = el.text.strip()

            if not href:
                continue
            if "javascript:" in href.lower():
                continue

            # ë¸Œëœë“œ ì—¬ë¶€ íŒì •
            is_brand = ("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸" in text) or (href in brand_hrefs)

            if is_brand and not include_brand_catalog:
                continue

            best_records = resolve_smartstore_urls_by_click(
                driver,
                el,
                base_kind="ad",          # â† ì´ê²Œ ì—‘ì…€ì— 'ad'ë¡œ ì €ì¥ë˜ëŠ” ê´‘ê³  êµ¬ë¶„ì
                is_brand_catalog=is_brand,
            )
            records.extend(best_records)

            if csv_filename_for_realtime and best_records:
                append_to_csv_incremental(best_records, csv_filename_for_realtime)


    # 2) ì¼ë°˜ ìƒí’ˆ ì˜ì—­
    product_elements = driver.find_elements(
        By.CSS_SELECTOR,
        'div[class^="product_title__"] a[class^="product_link__"]'
    )
    for el in product_elements:
        if is_preorder_product_link(el):
            continue
        
        href = el.get_attribute("href")
        text = el.text.strip()

        if not href:
            continue
        if "javascript:" in href.lower():
            continue

        is_brand = ("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸" in text) or (href in brand_hrefs)

        if is_brand and not include_brand_catalog:
            continue

        best_records = resolve_smartstore_urls_by_click(
            driver,
            el,
            base_kind="product",
            is_brand_catalog=is_brand,
        )
        records.extend(best_records)

        # â˜… ì¼ë°˜ ìƒí’ˆë„ ì‹¤ì‹œê°„ CSV ì €ì¥
        if csv_filename_for_realtime and best_records:
            append_to_csv_incremental(best_records, csv_filename_for_realtime)

    # (href + kind) ê¸°ì¤€ ì¤‘ë³µ ì œê±°
    unique = {}
    for r in records:
        key = (r["href"], r["kind"])
        unique[key] = r

    return list(unique.values())

def save_to_excel(records, filename):
    """ìˆ˜ì§‘í•œ ë§í¬ë¥¼ ì—‘ì…€ íŒŒì¼ë¡œ ì €ì¥"""
    if not records:
        print("ìˆ˜ì§‘ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ì„ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    df = pd.DataFrame(records)
    df.to_excel(filename, index=False)
    print(f"ì—‘ì…€ ì €ì¥ ì™„ë£Œ â†’ {filename}")
    print(f"ì´ ë§í¬ ê°œìˆ˜: {len(df)}")


def save_to_csv(records, filename):
    """ìˆ˜ì§‘í•œ ë§í¬ë¥¼ CSV íŒŒì¼ë¡œ ì €ì¥"""
    if not records:
        print("ìˆ˜ì§‘ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. CSVë¥¼ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    df = pd.DataFrame(records)
    df.to_csv(filename, index=False, encoding="utf-8-sig")
    print(f"CSV ì €ì¥ ì™„ë£Œ â†’ {filename}")
    print(f"ì´ ë§í¬ ê°œìˆ˜: {len(df)}")


def wait_for_pagination(driver, timeout=10):
    """í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ì´ DOMì— ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ ëŒ€ê¸°"""
    try:
        WebDriverWait(driver, timeout).until(
            EC.presence_of_element_located(
                (By.CSS_SELECTOR, 'div[class^="pagination_num__"]')
            )
        )
    except Exception:
        print("[ê²½ê³ ] í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")


def go_to_page_smart_from_first(driver, target_page, wait_sec=1.0):
    """
    1í˜ì´ì§€ì—ì„œ ì‹œì‘í•œë‹¤ê³  ê°€ì •í•˜ê³ ,
    ë³´ì´ëŠ” í˜ì´ì§€ ë²ˆí˜¸ë“¤ ì¤‘ 'ê°€ì¥ í° ìˆ«ì' ë²„íŠ¼ì„ ê³„ì† ëˆŒëŸ¬ê°€ë©°
    target_pageì— ë„ë‹¬í•  ë•Œê¹Œì§€ ì í”„í•˜ëŠ” í•¨ìˆ˜.
    ì˜ˆ) 1 -> 10 -> 15 -> 20 -> ... -> 60
    """
    if target_page <= 1:
        return  # ì´ë¯¸ 1í˜ì´ì§€ë©´ ê°ˆ í•„ìš” ì—†ìŒ

    # í˜ì´ì§€ë„¤ì´ì…˜ì´ ë¡œë“œë  ë•Œê¹Œì§€ í•œ ë²ˆ ê¸°ë‹¤ë ¤ì¤Œ
    wait_for_pagination(driver)

    while True:
        cur = get_current_page(driver)
        if cur is None:
            print("[ê²½ê³ ] í˜„ì¬ í˜ì´ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return

        if cur == target_page:
            print(f"{target_page} í˜ì´ì§€ ë„ë‹¬")
            return

        if cur > target_page:
            print(f"[ê²½ê³ ] í˜„ì¬ í˜ì´ì§€({cur})ê°€ íƒ€ê²Ÿ({target_page})ë³´ë‹¤ í½ë‹ˆë‹¤. ì¤‘ë‹¨.")
            return

        # í˜„ì¬ ë³´ì´ëŠ” ìˆ«ì ë²„íŠ¼ë“¤ (pagination_num__ ì•ˆì—ì„œë§Œ ì°¾ê¸°)
        buttons = driver.find_elements(
            By.CSS_SELECTOR,
            'div[class^="pagination_num__"] a[class^="pagination_btn_page__"]'
        )
        nums = []
        for btn in buttons:
            txt = btn.text.strip()
            if txt.isdigit():
                nums.append(int(txt))

        if not nums:
            print("[ê²½ê³ ] í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return

        max_visible = max(nums)

        # 1) target_pageê°€ í˜„ì¬ ë³´ì´ëŠ” ë²ˆí˜¸ë“¤ ì•ˆì— ìˆìœ¼ë©´ â†’ ê·¸ ë²ˆí˜¸ë¥¼ í´ë¦­í•˜ê³  ì¢…ë£Œ
        if target_page in nums:
            target_str = str(target_page)
            for btn in buttons:
                if btn.text.strip() == target_str:
                    print(f"{target_page} í˜ì´ì§€ ë²„íŠ¼ í´ë¦­")
                    driver.execute_script("arguments[0].click();", btn)
                    time.sleep(random.uniform(*CLICK_DELAY_RANGE))
                    return

        # 2) ì•„ì§ í™”ë©´ì— ì•ˆ ë³´ì´ëŠ” ê²½ìš° â†’ ê°€ì¥ í° ë²ˆí˜¸(max_visible)ë¥¼ ëˆŒëŸ¬ì„œ ì•ìœ¼ë¡œ í¬ê²Œ ì í”„
        if max_visible < target_page:
            max_str = str(max_visible)
            print(f"íƒ€ê²Ÿ {target_page}ê°€ ì•„ì§ ì•ˆ ë³´ì„ â†’ {max_visible} í˜ì´ì§€ë¡œ ì í”„")
            for btn in buttons:
                if btn.text.strip() == max_str:
                    driver.execute_script("arguments[0].click();", btn)
                    time.sleep(random.uniform(*CLICK_DELAY_RANGE))
                    break
        else:
            # ì•ˆì „ ëª¨ë“œ (ë…¼ë¦¬ì ìœ¼ë¡œ ê±°ì˜ ì•ˆ ì˜¤ê² ì§€ë§Œ ë°©ì–´ìš©)
            bigger_or_equal = [n for n in nums if n >= target_page]
            if bigger_or_equal:
                click_page = min(bigger_or_equal)
            else:
                click_page = max_visible

            click_str = str(click_page)
            print(f"ì•ˆì „ ëª¨ë“œ: {click_page} í˜ì´ì§€ë¡œ ì´ë™")
            for btn in buttons:
                if btn.text.strip() == click_str:
                    driver.execute_script("arguments[0].click();", btn)
                    time.sleep(random.uniform(*CLICK_DELAY_RANGE))
                    break


def go_to_next_page(driver, wait_sec=1.0):
    """
    í˜„ì¬ í˜ì´ì§€ì—ì„œ 'ë‹¤ìŒ í˜ì´ì§€(ìˆ«ì+1)'ë¡œ ì´ë™.
    ìŠ¬ë¼ì´ë”© í˜ì´ì§€ë„¤ì´ì…˜ì—ì„œë„,
    pagination_num__ ì•ˆì—ì„œ active ê¸°ì¤€ìœ¼ë¡œ +1 ë²„íŠ¼ì„ ì°¾ì•„ì„œ í´ë¦­.
    """
    cur = get_current_page(driver)
    if cur is None:
        print("[ê²½ê³ ] í˜„ì¬ í˜ì´ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
        return

    target = cur + 1
    target_str = str(target)

    buttons = driver.find_elements(
        By.CSS_SELECTOR,
        'div[class^="pagination_num__"] a[class^="pagination_btn_page__"]'
    )
    for btn in buttons:
        if btn.text.strip() == target_str:
            print(f"{cur} -> {target} í˜ì´ì§€ ì´ë™")
            driver.execute_script("arguments[0].click();", btn)
            time.sleep(random.uniform(*CLICK_DELAY_RANGE))
            return

    print(f"[ê²½ê³ ] {target} í˜ì´ì§€ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ë§ˆì§€ë§‰ í˜ì´ì§€ì¼ ìˆ˜ ìˆìŒ)")


def get_current_page(driver):
    """
    í˜„ì¬ í™œì„± í˜ì´ì§€ ë²ˆí˜¸ ì½ê¸°
    - div.pagination_num__ ì•ˆì—ì„œ .active ìš”ì†Œë¥¼ ì°¾ê³ 
    - ê·¸ ì•ˆì˜ í…ìŠ¤íŠ¸ì—ì„œ ìˆ«ìë§Œ ë½‘ì•„ì„œ intë¡œ ë³€í™˜
    """
    try:
        active = driver.find_element(
            By.CSS_SELECTOR,
            'div[class^="pagination_num__"] .active'
        )
        text = active.text.strip()
        # ì˜ˆ: "í˜„ì¬ í˜ì´ì§€\n1" / "í˜„ì¬ í˜ì´ì§€1" â†’ ìˆ«ìë§Œ ì¶”ì¶œ
        digits = ''.join(ch for ch in text if ch.isdigit())
        if digits:
            return int(digits)
        return None
    except Exception:
        return None

def open_category_selector():
    global driver

    # driver ì—†ê±°ë‚˜ ì£½ì—ˆìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    if driver is None:
        driver = create_driver()
    else:
        try:
            _ = driver.current_url
        except WebDriverException:
            driver = create_driver()

    driver.get(START_URL)
    gui_log("[INFO] ë„¤ì´ë²„ ì‡¼í•‘ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤.")

    # í˜¹ì‹œ ìº¡ì±  ëœ¨ë©´ ì²˜ë¦¬
    try:
        handle_captcha_if_needed(driver)
    except Exception as e:
        gui_log(f"[WARN] ìº¡ì±  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    messagebox.showinfo(
        "ì¹´í…Œê³ ë¦¬ ì„ íƒ",
        "í¬ë¡¬ ì°½ì—ì„œ ì›í•˜ëŠ” ì¹´í…Œê³ ë¦¬/í•„í„°ë¥¼ ëª¨ë‘ ê³ ë¥¸ ë’¤,\n"
        "[ìˆ˜ì§‘í•˜ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”."
    )

def run_crawler(start_page, end_page, include_brand_catalog, forbidden_file_path,include_ads=True):
    """
    GUIì—ì„œ ë°›ì€ ì„¤ì •ê°’ìœ¼ë¡œ í¬ë¡¤ë§ ì‹¤í–‰.
    - driver: ì´ë¯¸ open_category_selector ì—ì„œ ì—´ë¦° ìƒíƒœë¼ê³  ê°€ì •.
    """
    global FORBIDDEN_KEYWORDS, VISITED_STORE_KEYS

    if driver is None:
        gui_log("[ERROR] driver ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € [ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")
        return

    # ê¸ˆì¹™ì–´ ë¡œë”©
    load_forbidden_keywords_from_path(forbidden_file_path)

    VISITED_STORE_KEYS = set()

    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    excel_filename = f"naver_links_{timestamp}.xlsx"
    csv_filename   = f"naver_links_{timestamp}.csv"
    all_records = []

    handle_captcha_if_needed(driver)

    gui_log(f">>> {start_page} í˜ì´ì§€ë¶€í„° {end_page} í˜ì´ì§€ê¹Œì§€ ìˆ˜ì§‘ ì‹œì‘")

    for page in range(start_page, end_page + 1):
        if STOP_REQUESTED:
            gui_log(f"[STOP] {page} í˜ì´ì§€ë¶€í„°ëŠ” ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
            break

        gui_log("=" * 60)
        gui_log(f"[{page} í˜ì´ì§€] ìˆ˜ì§‘ ì‹œì‘")

        if page == start_page:
            if page == 1:
                gui_log("1í˜ì´ì§€ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.")
            else:
                gui_log(f"1í˜ì´ì§€ì—ì„œ {page}í˜ì´ì§€ë¡œ ì í”„í•©ë‹ˆë‹¤.")
                go_to_page_smart_from_first(driver, page)
        else:
            go_to_next_page(driver)

        scroll_page(driver, SCROLL_COUNT, SCROLL_DELAY_RANGE)

        new_links = collect_naver_links(
            driver,
            include_brand_catalog,
            include_ads=include_ads,
            csv_filename_for_realtime=csv_filename
        )
        gui_log(f"[{page} í˜ì´ì§€] ìƒˆë¡œ ìˆ˜ì§‘ëœ raw ë§í¬ ê°œìˆ˜: {len(new_links)}")

        merged = {}
        for r in all_records + new_links:
            key = (r["href"], r["kind"])
            merged[key] = r
        all_records = list(merged.values())

        save_to_excel(all_records, excel_filename)
        save_to_csv(all_records, csv_filename)
        gui_log(f"[{page} í˜ì´ì§€]ê¹Œì§€ ëˆ„ì  ë§í¬ ê°œìˆ˜: {len(all_records)}")

    gui_log("=== ìˆ˜ì§‘ ì¢…ë£Œ ===")




################################################################
# gui
################################################################


root = tk.Tk()
root.title("ë„¤ì´ë²„ ë² ìŠ¤íŠ¸ ìƒí’ˆ ë§í¬ ìˆ˜ì§‘ í”„ë¡œê·¸ë¨")

forbidden_path_var = tk.StringVar(value="")

# ì „ì²´ íŒ¨ë”©ìš© í”„ë ˆì„
main_frame = ttk.Frame(root, padding=10)
main_frame.pack(fill="both", expand=True)

# 1. ì‚¬ìš©ë²• ì„¤ëª…
usage_frame = ttk.LabelFrame(main_frame, text="ì‚¬ìš©ë²•")
usage_frame.pack(fill="x", pady=(0, 10))

usage_text = (
    "1. [ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ í¬ë¡¬ì—ì„œ ì›í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì§ì ‘ ê³ ë¦…ë‹ˆë‹¤.\n"
    "2. ìˆ˜ì§‘í•  í˜ì´ì§€ ë²ˆí˜¸ë¥¼ 'ëª‡ í˜ì´ì§€ë¶€í„° ~ ëª‡ í˜ì´ì§€ê¹Œì§€' ìˆ«ìë¡œ ì ìŠµë‹ˆë‹¤.\n"
    "3. í¬í•¨ ì—¬ë¶€ì™€ ì‹œê°„(í´ë¦­ ì†ë„)ì„ ì •í•©ë‹ˆë‹¤.\n"
    "4. ê¸ˆì¹™ì–´ íŒŒì¼ì„ ì„ íƒí•©ë‹ˆë‹¤.\n"
    "5. [ìˆ˜ì§‘í•˜ê¸°] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í”„ë¡œê·¸ë¨ì´ ìë™ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ëª¨ìë‹ˆë‹¤."
)
usage_label = ttk.Label(usage_frame, text=usage_text, justify="left")
usage_label.pack(anchor="w")

# --- â­ 7. API Key ì„¤ì • ì„¹ì…˜ ì¶”ê°€ ---
api_key_frame = ttk.LabelFrame(main_frame, text="API Key ì…ë ¥")
api_key_frame.pack(fill="x", pady=(0, 10))

# Key ì…ë ¥
key_label = ttk.Label(api_key_frame, text="Key ì…ë ¥:")
key_label.grid(row=1, column=0, padx=5, pady=5, sticky="e")

key_entry = ttk.Entry(api_key_frame, width=50)
key_entry.grid(row=1, column=1, padx=5, pady=5, sticky="ew")

# 2. ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ
category_frame = ttk.LabelFrame(main_frame, text="ì¹´í…Œê³ ë¦¬ í•„í„° ì§ì ‘ ì„ íƒ")
category_frame.pack(fill="x", pady=(0, 10))

def select_forbidden_file():
    global forbidden_path_var
    path = filedialog.askopenfilename(
        title="ê¸ˆì¹™ì–´ í…ìŠ¤íŠ¸ íŒŒì¼ ì„ íƒ",
        filetypes=[("Text files", "*.txt"), ("All files", "*.*")]
    )
    if path:
        forbidden_path_var.set(path)
        path_label.config(text=path)
        gui_log(f"[INFO] ê¸ˆì¹™ì–´ íŒŒì¼ ì„ íƒ: {path}")
    else:
        forbidden_path_var.set("")
        path_label.config(text="")
        gui_log("[INFO] ê¸ˆì¹™ì–´ íŒŒì¼ ì„ íƒ ì·¨ì†Œ")

category_button = ttk.Button(
    category_frame,
    text="ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ (í¬ë¡¬ ì—´ê¸°)",
    command=open_category_selector
)
category_button.pack(anchor="w", pady=5)

# 3. ìˆ˜ì§‘í•  í˜ì´ì§€ ë²”ìœ„
page_frame = ttk.LabelFrame(main_frame, text="ìˆ˜ì§‘í•  í˜ì´ì§€ ì„ íƒ")
page_frame.pack(fill="x", pady=(0, 10))

start_page_var = tk.IntVar(value=1)
end_page_var = tk.IntVar(value=5)

start_label = ttk.Label(page_frame, text="ì‹œì‘ í˜ì´ì§€:")
start_label.grid(row=0, column=0, padx=(5, 2), pady=5, sticky="e")
start_entry = ttk.Entry(page_frame, textvariable=start_page_var, width=10)
start_entry.grid(row=0, column=1, padx=(0, 10), pady=5, sticky="w")
start_suffix = ttk.Label(page_frame, text="í˜ì´ì§€ë¶€í„°")
start_suffix.grid(row=0, column=2, padx=(0, 5), pady=5, sticky="w")

end_label = ttk.Label(page_frame, text="ë í˜ì´ì§€:")
end_label.grid(row=1, column=0, padx=(5, 2), pady=5, sticky="e")
end_entry = ttk.Entry(page_frame, textvariable=end_page_var, width=10)
end_entry.grid(row=1, column=1, padx=(0, 10), pady=5, sticky="w")
end_suffix = ttk.Label(page_frame, text="í˜ì´ì§€ê¹Œì§€")
end_suffix.grid(row=1, column=2, padx=(0, 5), pady=5, sticky="w")

# 4. ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ë§í¬ ì˜µì…˜ (ë¼ë””ì˜¤ ë²„íŠ¼)
link_frame = ttk.LabelFrame(main_frame, text="ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ë§í¬ ì˜µì…˜")
link_frame.pack(fill="x", pady=(0, 10))

link_option_var = tk.StringVar(value="include")

include_radio = ttk.Radiobutton(
    link_frame, text="ë§í¬ í¬í•¨",
    variable=link_option_var, value="include"
)
include_radio.pack(anchor="w", padx=5, pady=2)

exclude_radio = ttk.Radiobutton(
    link_frame, text="ë§í¬ ë¶ˆí¬í•¨",
    variable=link_option_var, value="exclude"
)
exclude_radio.pack(anchor="w", padx=5, pady=2)


# 4-1. ê´‘ê³  ë§í¬ ì˜µì…˜ (ë¼ë””ì˜¤ ë²„íŠ¼)
ad_frame = ttk.LabelFrame(main_frame, text="ê´‘ê³  ë§í¬ ì˜µì…˜")
ad_frame.pack(fill="x", pady=(0, 10))

ad_option_var = tk.StringVar(value="include")  # ê¸°ë³¸ê°’: í¬í•¨

ad_include_radio = ttk.Radiobutton(
    ad_frame, text="ê´‘ê³  í¬í•¨",
    variable=ad_option_var, value="include"
)
ad_include_radio.pack(anchor="w", padx=5, pady=2)

ad_exclude_radio = ttk.Radiobutton(
    ad_frame, text="ê´‘ê³  ë¶ˆí¬í•¨",
    variable=ad_option_var, value="exclude"
)
ad_exclude_radio.pack(anchor="w", padx=5, pady=2)
# 5. ì‹œê°„ 
time_frame = ttk.LabelFrame(main_frame, text="í´ë¦­ ì‹œê°„ ì„¤ì •")
time_frame.pack(fill="x", pady=(0, 10))

min_click_sec_var = tk.IntVar(value=2)
max_click_sec_var = tk.IntVar(value=5)
work_min_var = tk.IntVar(value=30)
rest_min_var = tk.IntVar(value=10)

# í´ë¦­ ê°„ê²©
click_label1 = ttk.Label(time_frame, text="í´ë¦­ ê°„ê²©:")
click_label1.grid(row=0, column=0, padx=(5, 2), pady=5, sticky="e")

min_click_entry = ttk.Entry(time_frame, textvariable=min_click_sec_var, width=5)
min_click_entry.grid(row=0, column=1, padx=(0, 2), pady=5, sticky="w")

click_mid_label = ttk.Label(time_frame, text="ì´ˆ ì™€")
click_mid_label.grid(row=0, column=2, padx=(0, 2), pady=5, sticky="w")

max_click_entry = ttk.Entry(time_frame, textvariable=max_click_sec_var, width=5)
max_click_entry.grid(row=0, column=3, padx=(0, 2), pady=5, sticky="w")

click_suffix = ttk.Label(time_frame, text="ì´ˆ ì‚¬ì´ì— í•œ ë²ˆ í´ë¦­")
click_suffix.grid(row=0, column=4, padx=(0, 5), pady=5, sticky="w")

# 6. ê¸ˆì¹™ì–´ íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜
forbidden_frame = ttk.LabelFrame(main_frame, text="ê¸ˆì¹™ì–´ íŒŒì¼ ì„ íƒ (ì„ íƒ ì‚¬í•­, ; ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.)")
forbidden_frame.pack(fill="x", pady=(0, 10))

command=select_forbidden_file 

file_button = ttk.Button(
    forbidden_frame,
    text="ê¸ˆì¹™ì–´ íŒŒì¼ ì„ íƒ (*.txt)",
    command=select_forbidden_file 
)
file_button.pack(anchor="w", padx=5, pady=5)

path_label = ttk.Label(
    forbidden_frame,

    wraplength=400,
    foreground="blue"
)
path_label.pack(anchor="w", padx=5, pady=(0, 5))



def load_saved_api_key():
    """ì´ì „ì— ì €ì¥í•œ API Keyê°€ ìˆìœ¼ë©´ ì½ì–´ì„œ ë¬¸ìì—´ë¡œ ë°˜í™˜"""
    if os.path.exists(API_KEY_FILE):
        try:
            with open(API_KEY_FILE, "r", encoding="utf-8") as f:
                return f.read().strip()
        except Exception:
            return ""
    return ""


# ğŸ”¹ key_entry ë§Œë“  ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€
saved_key = load_saved_api_key()
if saved_key:
    key_entry.insert(0, saved_key)  # ì €ì¥ëœ í‚¤ë¥¼ ìë™ìœ¼ë¡œ ì…ë ¥ì¹¸ì— ë„£ì–´ì¤Œ



# 7. ì‹¤í–‰ / ì¤‘ë‹¨ ë²„íŠ¼
button_frame = ttk.Frame(main_frame)
button_frame.pack(fill="x", pady=(10, 0))

# â­ 'Pink.TButton' ìŠ¤íƒ€ì¼ ì ìš©!
start_button = tk.Button(button_frame, 
                          text="ìˆ˜ì§‘í•˜ê¸°", 
                          command=start_collect,
                          bg='blue',  
                          fg='white')
start_button.pack(side="left", padx=(0, 10))

stop_button = ttk.Button(button_frame, text="ì¤‘ë‹¨í•˜ê¸°", command=stop_collect)
stop_button.pack(side="left")




# --- â­ 8. ë¡œê·¸ ì°½ ì„¹ì…˜ ì¶”ê°€ ---
log_frame = ttk.LabelFrame(main_frame, text="â‘¥ ë¡œê·¸ ì°½")
log_frame.pack(fill="both", expand=True, pady=(10, 0)) # fill="both"ì™€ expand=Trueë¡œ ê³µê°„ì„ ì±„ì›ë‹ˆë‹¤.

# ë¡œê·¸ ì¶œë ¥ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ìœ„ì ¯
log_text = tk.Text(log_frame, wrap=tk.WORD, height=10, state='normal')
log_text.pack(side="left", fill="both", expand=True, padx=5, pady=5)

# ìŠ¤í¬ë¡¤ë°” ì¶”ê°€
log_scrollbar = ttk.Scrollbar(log_frame, command=log_text.yview)
log_scrollbar.pack(side="right", fill="y")
log_text.config(yscrollcommand=log_scrollbar.set)

# --- ë¡œê·¸ ì°½ ì„¹ì…˜ ë ---


if __name__ == "__main__":
    root.mainloop()
# -*- coding: utf-8 -*-
"""
í†µì´ë¯¸ì§€ 4ê°œ ëœë¤ í¬ë¡­ & ìë™ í´ë”ë§ (Simple UI, Tkinter)
- UI í†¤: ì—°í•œ íšŒìƒ‰ ë°°ê²½ + í° ì¹´ë“œ + íŒŒë‘ í¬ì¸íŠ¸ (ê¸°ì¡´ ìœ ì§€)
- GUI ë°°ì¹˜/í¬ê¸°: ê¸°ì¡´ ê·¸ëŒ€ë¡œ (1080x780)
- ê°œì„  ë¡œì§: ë¬´ê²°ì„± ê²€ì‚¬(verify + load) + ìë™ ì¬ì‹œë„ + ì›ìì  ì €ì¥(os.replace)
- ì„ì‹œíŒŒì¼ í™•ì¥ì ì´ìŠˆ í•´ê²°: img.save(..., format="PNG")
- ì¬ì‹œë„ ëŒ€ìƒ/íšŒì°¨/ê²°ê³¼ë¥¼ ëª¨ë‘ ì‹¤ì‹œê°„ ë¡œê·¸ ë° logs/ì— ê¸°ë¡
"""

import os, io, sys, random, datetime, traceback, time
import tkinter as tk
from tkinter import ttk, filedialog, scrolledtext

import numpy as np
from PIL import Image, ImageOps, UnidentifiedImageError
from openpyxl import load_workbook



# ---- UI Palette ----
UI_BG = "#F5F7FA"
UI_FG = "#1F2937"
UI_CARD = "#FFFFFF"
UI_BORDER = "#E5E7EB"
UI_ACCENT = "#2563EB"
UI_FONT = ("ë§‘ì€ ê³ ë”•", 10)
UI_FONT_TITLE = ("ë§‘ì€ ê³ ë”•", 12, "bold")

# í•‘í¬ ë°°ì§€(ì—°í•œ í•‘í¬ + ì§„í•œ ë¡œì¦ˆ í…ìŠ¤íŠ¸)
UI_PINK_BG = "#FFE4F2"
UI_PINK_FG = "#9D174D"

HELP_TEXT = (
    "[ì‚¬ìš© ë°©ë²•]\n"
    "1) ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•©ë‹ˆë‹¤.\n"
    "2) ì›ê³  ìŠ¬ë¡¯ 4ê°œì— ì´ë¯¸ì§€ì™€ ì›ê³ ë²ˆí˜¸(1~4)ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.\n"
    "3) [ì´ë¯¸ì§€ í¬ë¡­Â·ì €ì¥ ì‹¤í–‰]ì„ ëˆ„ë¦…ë‹ˆë‹¤.\n"
    "   - íŒŒì¼ëª…: ì›ê³ ë²ˆí˜¸_ì˜¤ëŠ˜ë‚ ì§œ_ì—°ì†ë²ˆí˜¸.png  (ì˜ˆ: 1_251020_1.png)\n"
    "   - ì—¬ë°±ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µë©ë‹ˆë‹¤.\n"
    "4) [URL ìƒì„±]ì„ ëˆ„ë¥´ë©´ ê° ê²½ë¡œì— URL.txtê°€ ìƒì„±ë©ë‹ˆë‹¤."
)

# ===== VBA ë™ë“± ìœ í‹¸ =====
def clean_seg(s: str) -> str:
    s = (s or "").strip()
    for ch in ['\\','/',':','*','?','"','<','>','|']:
        s = s.replace(ch, ' ')
    while len(s) > 0 and (s.endswith(' ') or s.endswith('.')):
        s = s[:-1]
    return s.strip()

def remove_spaces_tabs(s: str) -> str:
    return (s or "").replace(' ', '').replace('\t', '')

def parse_blog_cell(cell_text: str):
    s = (cell_text or '').strip()
    p_open = s.find('(')
    p_close = s.rfind(')')
    if p_open > -1 and p_close > p_open:
        blog_name = s[:p_open].strip()
        blog_id = s[p_open+1:p_close].strip()
    else:
        blog_name = s
        blog_id = ''
    return blog_name, blog_id

def blog_id_by_name(name: str) -> str:
    mapping = {
        "ë·°í‹°ìµœê³ ": "wet4448",
        "ì†Œì†Œí•œí–‰ë³µ":"prevail9850",
        "í•˜ë©´ëœë‹¤": "elegant10872",
        "ìŠ¬ë¦¼ì¼ê¸°": "dkdlwjd1q",
        "í•ëª¨ë¨¼íŠ¸": "thejrdks9o",
        "ê°ëŸ‰ë©ìŠ¤": "happy24632",
        "ë·°í‹°ë…¸íŠ¸": "pepper634",
        "ê±´ê°•ìš”ì •": "heoangel731",
        "ì˜¤ëŠ˜ê°“ìƒ": "bride11231",
        "ê³„ë‹¨íƒ€ê¸°": "scold10151",
        "ì¼ë‹¨ì‹œì‘": "affair5459",
        "ì˜ˆì¨ì£¼ì˜": "cap2417",
        "ë…¸ë ¥ì²œì¬": "reserve1047",
        "ê¸€ë¡œìš°í•": "scarce8501",
        "ìŠ¬ë¦¼ì¡°ì´": "withpiano001",
        "ì‚´ê³°ë‹¬ê³°": "kbshb72",
    }
    return mapping.get((name or '').strip(), '')

# ë¸”ë¡œê·¸ ë„˜ë²„ ë§¤í•‘ (utm_sourceì— ë“¤ì–´ê°ˆ ë²ˆí˜¸)
BLOG_NO_MAP = {
    "ë·°í‹°ìµœê³ ": 1,
    "ì†Œì†Œí•œí–‰ë³µ": 2,
    "í•˜ë©´ëœë‹¤": 3,
    "ìŠ¬ë¦¼ì¼ê¸°": 4,
    "ê¸€ë¡œìš°í•": 5,
    "ìŠ¬ë¦¼ì¡°ì´": 6,
    "í•ëª¨ë¨¼íŠ¸": 7,
    "ê°ëŸ‰ë©ìŠ¤": 8,
    "ë·°í‹°ë…¸íŠ¸": 9,
    "ê±´ê°•ìš”ì •": 10,
}

def shifted_date_code(medium: str) -> str:
    """
    medium: 'yymmdd' í˜•íƒœ ë¬¸ìì—´ì—ì„œ
    (ë…„+15)(ì›”+15)(ì¼+15)ë¥¼ ê³„ì‚°í•´ì„œ ë‹¤ì‹œ ë¬¸ìì—´ë¡œ ë°˜í™˜.
    ì˜ˆ) '251121' -> '402636' (25+15, 11+15, 21+15)
    ì‹¤íŒ¨í•˜ë©´ ì›ë³¸ medium ê·¸ëŒ€ë¡œ ë°˜í™˜.
    """
    s = ''.join(ch for ch in str(medium) if ch.isdigit())
    if len(s) != 6:
        return str(medium)

    yy = int(s[0:2])
    mm = int(s[2:4])
    dd = int(s[4:6])

    yy2 = yy + 15
    mm2 = mm + 15
    dd2 = dd + 15

    return f"{yy2:02d}{mm2:02d}{dd2:02d}"


def ensure_folder(path: str):
    os.makedirs(path, exist_ok=True)

def write_text_utf8(full_path: str, content: str):
    ensure_folder(os.path.dirname(full_path))
    with io.open(full_path, 'w', encoding='utf-8') as f:
        f.write(content or '')

def to_date_folder_and_medium(v_date):
    import datetime as _dt
    try:
        if isinstance(v_date, _dt.datetime):
            d = v_date
        elif isinstance(v_date, _dt.date):
            d = _dt.datetime(v_date.year, v_date.month, v_date.day)
        else:
            s = str(v_date).strip()  # '10ì›” 16ì¼'
            d = _dt.datetime.strptime(s, "%mì›” %dì¼")
            d = d.replace(year=_dt.datetime.now().year)
        date_folder = d.strftime("%y.%m.%d")
        medium = d.strftime("%y%m%d")
        return date_folder, medium
    except Exception:
        s = clean_seg(str(v_date).strip())
        medium = s.replace('.', '').replace('-', '')
        return s, medium

def today_yymmdd() -> str:
    return datetime.datetime.now().strftime("%y%m%d")

# ===== ë¬´ê²°ì„± ê²€ì‚¬ + ì¬ì‹œë„ =====
def verify_image_integrity(path: str) -> bool:
    """
    ì €ì¥ëœ PNGê°€ ì†ìƒë˜ì§€ ì•Šì•˜ëŠ”ì§€ ê²€ì‚¬:
    1) êµ¬ì¡°/CRC í™•ì¸(Image.verify)
    2) ì „ì²´ ë””ì½”ë”©(Image.load)
    """
    try:
        from PIL import Image as _Image
        with _Image.open(path) as im:
            im.verify()
        with _Image.open(path) as im:
            im.load()
        return True
    except (OSError, UnidentifiedImageError):
        return False

def save_with_retry_and_integrity(img, target, logger, max_retries=10, delay=0.2):
    """
    PNGë¥¼ tmpì— ì €ì¥(í¬ë§· ëª…ì‹œ) â†’ os.replaceë¡œ ì›ìì  êµì²´ â†’ ë¬´ê²°ì„± ê²€ì‚¬
    ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„. ëª¨ë“  ì‹œë„/ê²°ê³¼ëŠ” loggerë¡œ ë‚¨ê¹€.
    """
    tmp = target + ".tmp"
    attempt = 1
    while attempt <= max_retries:
        try:
            # â˜… í•µì‹¬: í™•ì¥ì .tmpë¼ë„ Pillowê°€ í¬ë§·ì„ ì•Œ ìˆ˜ ìˆê²Œ format="PNG" ëª…ì‹œ
            img.save(tmp, format="PNG", optimize=False)
            os.replace(tmp, target)

            # ì €ì¥ í›„ ë¬´ê²°ì„± ê²€ì‚¬(verify + load)
            if verify_image_integrity(target):
                if attempt > 1:
                    logger(f"ğŸ©µ [ì •ìƒë³µêµ¬] ì¬ì‹œë„ {attempt-1}íšŒ í›„ ë¬´ê²°ì„± í†µê³¼ â†’ {target}")
                return True
            else:
                logger(f"âš ï¸ [ë¬´ê²°ì„± ì‹¤íŒ¨] {attempt}íšŒì°¨ â†’ {target}")
                attempt += 1
                time.sleep(delay)

        except Exception as e:
            logger(f"âŒ [ì €ì¥ ì‹¤íŒ¨] {attempt}íšŒì°¨ â†’ {target} | {e}")
            attempt += 1
            time.sleep(delay)
        finally:
            # ì‹¤íŒ¨ ì¼€ì´ìŠ¤ì—ì„œ tmp ì”ì¡´ ë°©ì§€
            try:
                if os.path.exists(tmp):
                    os.remove(tmp)
            except Exception:
                pass

    logger(f"âŒ [ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼] ì†ìƒëœ íŒŒì¼ ìœ ì§€ë¨ â†’ {target}")
    return False

# ===== ì—‘ì…€ ì½ê¸° (ì „ì²´í–‰) =====
def read_rows_from_excel(xlsx_path: str, logger):
    wb = load_workbook(xlsx_path, data_only=True)
    ws = wb.active
    rows = []
    for r in ws.iter_rows(min_row=1, values_only=True):
        if r is None or len(r) < 15:
            continue
        A = r[0]   # ë‚ ì§œ
        B = r[1]   # í‚¤ì›Œë“œ
        H = r[7]   # ë¸”ë¡œê·¸ëª…(ID)
        K = r[10] if len(r) > 10 else ''
        O = r[14] if len(r) > 14 else ''
        if (A is None) and (B is None) and (H is None):
            continue
        
        blog_name_raw, blog_id = parse_blog_cell(H)
        if not blog_id:
            blog_id = blog_id_by_name(blog_name_raw)  # í•„ìš” ì—†ìœ¼ë©´ ë‚˜ì¤‘ì— ë¹¼ë„ ë¨

        # í´ë”ì— ì“¸ ë¸”ë¡œê·¸ ì´ë¦„
        blog_name = "2. " + clean_seg(blog_name_raw)

        # ë¸”ë¡œê·¸ ë„˜ë²„ (ë·°í‹°ìµœê³ =1, ê³„ë‹¨íƒ€ê¸°=2, ...)
        blog_no = BLOG_NO_MAP.get(clean_seg(blog_name_raw), "")

        date_folder, medium = to_date_folder_and_medium(A)
        medium_utm = shifted_date_code(medium)

        # í‚¤ì›Œë“œ (ê¸°ì¡´ì²˜ëŸ¼ í´ë” ì´ë¦„ì— ì‚¬ìš©)
        keyword_raw = (B or '')
        keyword_folder = clean_seg(keyword_raw)

        # í‚¤ì›Œë“œ ë„˜ë²„ (ì—‘ì…€ Kì—´ ê·¸ëŒ€ë¡œ)
        keyword_no = str(K).strip() if K is not None else ""

        vname = (O or '').strip()
        nt_keyword = vname if len(vname) == 2 else "ì†Œí¬"

        base_path = r"Z:\ë¯¸ë“œë¸Œë¡œ\â¤ ë§ˆì¼€íŒ…\6.ì›ê³  ì´ë¯¸ì§€ êµì²´ ê±´"
        final_path = os.path.join(base_path, blog_name, date_folder, keyword_folder)

        # 1ìœ„ URL (ìƒˆ ì–‘ì‹)
        # http://innerium.co.kr/surl/p/18/?utm_source=ë¸”ë¡œê·¸NO/í‚¤ì›Œë“œNO/ë‚ ì§œ(ì˜ˆ: 251121)
        url = (
            "http://innerium.co.kr/surl/p/18/?"
            f"utm_source={blog_no}/{keyword_no}/{medium_utm}"
        )


        rows.append({
            "final_path": final_path,
            "url": url,               # 1ìœ„ URL
            "blog_name": blog_name,
            "date_folder": date_folder,
            "keyword_folder": keyword_folder,
            "medium": medium,
            "medium_utm": medium_utm, # utmìš© yymmdd(+15)
            "nt_keyword": nt_keyword,
            "blog_no": blog_no,
            "keyword_no": keyword_no,
        })

    logger(f"â„¹ï¸ [ì—‘ì…€] ì´ {len(rows)}í–‰ ë¡œë“œ ì™„ë£Œ")
    return rows

# ===== ì´ë¯¸ì§€ ìœ í‹¸ =====
def load_image_exif_oriented(path: str) -> Image.Image:
    """
    ì›ë³¸ì„ ì™„ì „íˆ ë©”ëª¨ë¦¬ë¡œ ë¡œë“œí•˜ê³  íŒŒì¼ í•¸ë“¤ì„ ë‹«ê¸° ìœ„í•´ copy ì‚¬ìš©.
    (ì§€ì—° ë¡œë“œ/íŒŒì¼ ë½ ì˜í–¥ ìµœì†Œí™”)
    """
    with Image.open(path) as im:
        im = ImageOps.exif_transpose(im)
        im = im.convert("RGB")
        return im.copy()

def is_row_white(arr_row, thresh=250):
    return np.all(arr_row >= thresh)

def detect_top_bottom_white_margins(img: Image.Image, thresh=250):
    img_rgb = img.convert("RGB")
    arr = np.array(img_rgb)
    H, W, _ = arr.shape

    top_margin = 0
    for y in range(H):
        if is_row_white(arr[y, :, :], thresh):
            top_margin += 1
        else:
            break

    bottom_margin = 0
    for y in range(H-1, -1, -1):
        if is_row_white(arr[y, :, :], thresh):
            bottom_margin += 1
        else:
            break

    return top_margin, bottom_margin

def pick_random_cuts(top_margin, bottom_margin):
    if top_margin < 1 or bottom_margin < 1:
        return None, None
    top_cut = random.randint(1, top_margin)
    bottom_cut = random.randint(1, bottom_margin)
    return top_cut, bottom_cut

def next_available_filename(dirpath: str, base_name_no_ext: str, ext: str) -> str:
    seq = 1
    while True:
        candidate = f"{base_name_no_ext}_{seq}{ext}"
        full = os.path.join(dirpath, candidate)
        if not os.path.exists(full):
            return full
        seq += 1

# ===== ì²˜ë¦¬ ë¡œì§ =====
def process_images_for_all_rows(excel_rows, slots, logger, progress_cb):
    valid = [(p, n) for (p, n) in slots if p and n in [1,2,3,4]]
    total_jobs = len(valid) * len(excel_rows)
    done = 0
    if total_jobs == 0:
        logger("â„¹ï¸ [ì‹¤í–‰] ì²˜ë¦¬í•  ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤(ì´ë¯¸ì§€/ì›ê³ ë²ˆí˜¸ í™•ì¸).")
        progress_cb(0)
        return

    today = today_yymmdd()

    for (img_path, wn) in valid:
        try:
            base_img = load_image_exif_oriented(img_path)
            W, H = base_img.size
            top_margin, bottom_margin = detect_top_bottom_white_margins(base_img, thresh=250)
            if top_margin < 1 or bottom_margin < 1:
                logger(f"â­ï¸ [ìŠ¤í‚µ] ì—¬ë°± ì—†ìŒ/ë¶€ì¡± â†’ {os.path.basename(img_path)} "
                       f"(top={top_margin}, bottom={bottom_margin})")
                done += len(excel_rows)
                progress_cb(int(done*100/total_jobs))
                continue

            top_cut, bottom_cut = pick_random_cuts(top_margin, bottom_margin)
            if top_cut is None:
                logger(f"â­ï¸ [ìŠ¤í‚µ] ëœë¤ ì»· ë¶ˆê°€(ì—¬ë°±<1px) â†’ {os.path.basename(img_path)}")
                done += len(excel_rows)
                progress_cb(int(done*100/total_jobs))
                continue

            L, T, R, B = 0, top_cut, W, H - bottom_cut
            if T >= B:
                logger(f"â­ï¸ [ìŠ¤í‚µ] í¬ë¡­ ë²”ìœ„ ë¹„ì •ìƒ(T>=B) â†’ {os.path.basename(img_path)}")
                done += len(excel_rows)
                progress_cb(int(done*100/total_jobs))
                continue

            # PNG ì €ì¥ ì „ ìƒ‰ëª¨ë“œ ì •ê·œí™”ëœ í¬ë¡­
            cropped = base_img.crop((L, T, R, B))

        except Exception as e:
            logger(f"âŒ [ì—ëŸ¬] ì´ë¯¸ì§€ ë¡œë“œ/ì—¬ë°±ê²€ì¶œ ì‹¤íŒ¨: {os.path.basename(img_path)} | {e}")
            done += len(excel_rows)
            progress_cb(int(done*100/total_jobs))
            continue

        for row in excel_rows:
            try:
                final_dir = row["final_path"]
                ensure_folder(final_dir)
                base_no_ext = f"{wn}_{today}"
                target = next_available_filename(final_dir, base_no_ext, ".png")

                # === ê°œì„ ëœ ì €ì¥: ë¬´ê²°ì„± ê²€ì‚¬ + ì¬ì‹œë„ + ìƒì„¸ ë¡œê·¸ ===
                ok = save_with_retry_and_integrity(cropped, target, logger, max_retries=10, delay=0.2)
                if ok:
                    logger(f"âœ… [ì„±ê³µ] ë¬´ê²°ì„± í†µê³¼: {target}")
                else:
                    logger(f"âŒ [ì‹¤íŒ¨] ëê¹Œì§€ ë¬´ê²°ì„± í™•ë³´ ì‹¤íŒ¨: {target}")

            except Exception as e:
                logger(f"âŒ [ì—ëŸ¬] ì €ì¥ ì¤‘ ì˜ˆì™¸: {row['final_path']} | {os.path.basename(img_path)} | {e}")
            finally:
                done += 1
                progress_cb(int(done*100/total_jobs))

def generate_urls_for_all_rows(excel_rows, logger):
    """
    ê° í–‰ í´ë”ì— URL.txt ìƒì„±

    ë‚´ìš© í˜•ì‹:

    1ìœ„ ë°°í•©ëŸ‰ ë™ì¼ 
    http://innerium.co.kr/surl/p/18/?utm_source=ë¸”ë¡œê·¸NO/í‚¤ì›Œë“œNO/ë‚ ì§œ

    2ìœ„
    https://www.coupang.com/vp/products/8882276703?itemId=25923218358&vendorItemId=87084400069?utm_source=ë¸”ë¡œê·¸NO/í‚¤ì›Œë“œNO/ë‚ ì§œ

    3ìœ„
    https://www.coupang.com/vp/products/9186687327?itemId=27101344279&vendorItemId=94069506923?utm_source=ë¸”ë¡œê·¸NO/í‚¤ì›Œë“œNO/ë‚ ì§œ
    """
    cnt = 0

    # 2Â·3ìœ„ ê³ ì • ë² ì´ìŠ¤ URL (ì§ˆë¬¸ì—ì„œ ì¤€ ì£¼ì†Œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    base2 = "https://www.coupang.com/vp/products/8882276703?itemId=25923218358&vendorItemId=87084400069"
    base3 = "https://www.coupang.com/vp/products/9186687327?itemId=27101344279&vendorItemId=94069506923"


    v_counter = 1  # í‚¤ì›Œë“œ(í–‰)ë³„ v ê°’ ì¹´ìš´í„°

    for row in excel_rows:
        try:
            dest_dir = row["final_path"]
            ensure_folder(dest_dir)

            # 1ìœ„ ë§í¬ (read_rows_from_excelì—ì„œ ì´ë¯¸ ìƒˆ í˜•ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ ë‘” ê°’)
            link1 = row["url"]

            # ë¸”ë¡œê·¸ ë„˜ë²„ / í‚¤ì›Œë“œ ë„˜ë²„ / ë‚ ì§œ
            blog_no = row.get("blog_no", "")
            keyword_no = row.get("keyword_no", "")
            medium_utm = str(row.get("medium_utm", "")).strip()   # ì˜ˆ: 251121

            # 2ìœ„ / 3ìœ„ ë§í¬
            # ì˜ˆì‹œ: ...?utm_source=1/í‚¤ì›Œë“œNO/251121
            link2 = f"{base2}?utm_source={blog_no}/{keyword_no}/{medium_utm}"
            link3 = f"{base3}?utm_source={blog_no}/{keyword_no}/{medium_utm}"


            # ğŸ‘‰ ì‹¤ì œë¡œ íŒŒì¼ì— ì“¸ ë‚´ìš© (ì—¬ê¸°ì„œ 3ê°œ ë§í¬ë¥¼ ë‹¤ ë„£ëŠ”ë‹¤)
            lines = [
                "1ìœ„ ë°°í•©ëŸ‰ ë™ì¼",
                "",
                "2ìœ„",
                "",
                "3ìœ„",
                "",
                link1,
                "",
                link2,
                "",
                link3,
                ""
            ]
            content = "\n".join(lines)

            full_path = os.path.join(dest_dir, "URL.txt")

            # URL.txt ë‚´ìš© ë’¤ì— ë¹ˆ ì¤„ 100ì¤„ ì¶”ê°€
            content += "\n" * 100

            write_text_utf8(full_path, content)

            cnt += 1
            v_counter += 1

        except Exception as e:
            logger(f"âŒ [ì—ëŸ¬] URL.txt ì €ì¥ ì‹¤íŒ¨: {row.get('final_path','?')} | {e}")

    logger(f"âœ… [URL] ìƒì„± ì™„ë£Œ: {cnt}ê°œ")


# ===== GUI =====
class App:
    def __init__(self, root):
        self.root = root
        root.title("í†µì´ë¯¸ì§€ 4ê°œ í¬ë¡­ & ìë™ í´ë”ë§")
        root.geometry("1080x780")            # ê¸°ì¡´ í¬ê¸° ê·¸ëŒ€ë¡œ
        root.configure(bg=UI_BG)

        # ttk ìŠ¤íƒ€ì¼
        style = ttk.Style()
        try:
            style.theme_use('clam')
        except Exception:
            pass
        style.configure("TLabel", background=UI_BG, foreground=UI_FG, font=UI_FONT)
        style.configure("TFrame", background=UI_BG)
        style.configure("TLabelframe", background=UI_BG, foreground=UI_FG)
        style.configure("TLabelframe.Label", background=UI_BG, foreground=UI_FG, font=UI_FONT)
        style.configure("TButton", font=UI_FONT, padding=6)
        style.configure("Card.TLabelframe", background=UI_CARD, relief="solid",
                        bordercolor=UI_BORDER, borderwidth=1)
        style.configure("Card.TLabelframe.Label", background=UI_CARD, foreground=UI_FG, font=UI_FONT)
        style.configure("Accent.Horizontal.TProgressbar", troughcolor="#EEF2FF", background=UI_ACCENT)

        # ìƒë‹¨ ì˜ì—­ (ì œëª© + ì„¤ëª…: í•­ìƒ ì™¼ìª½ ì •ë ¬)
        frm_top = ttk.Frame(root, style="TFrame")
        frm_top.pack(fill="x", padx=16, pady=12)
        tk.Label(frm_top, text="ì´ë¯¸ì§€ ìë™ í¬ë¡­ & í´ë”ë§", font=UI_FONT_TITLE, bg=UI_BG, fg=UI_FG)\
            .pack(anchor="w")
        tk.Label(frm_top, text=HELP_TEXT, font=UI_FONT, bg=UI_BG, fg=UI_FG,
                 justify="left", anchor="w")\
            .pack(fill="x", pady=(4,0), anchor="w")

        # ì—‘ì…€ ì„ íƒ (í•‘í¬ ë°°ì§€ labelwidget ì ìš©)
        frm_x_container = ttk.Frame(root, style="TFrame")
        frm_x_container.pack(fill="x", padx=16, pady=(6,12))

        xl_title = tk.Label(frm_x_container, text="ì—‘ì…€ íŒŒì¼(ì „ì²´í–‰ ì‚¬ìš©)",
                            bg=UI_PINK_BG, fg=UI_PINK_FG,
                            font=("ë§‘ì€ ê³ ë”•", 10, "bold"), padx=8, pady=2)
        frm_x = ttk.LabelFrame(frm_x_container, labelwidget=xl_title,
                               style="Card.TLabelframe", padding=0)
        frm_x.pack(fill="x")

        inner_x = ttk.Frame(frm_x, padding=8, style="TFrame")
        inner_x.pack(fill="x")
        self.xlsx_var = tk.StringVar()
        ent = ttk.Entry(inner_x, textvariable=self.xlsx_var)
        ent.pack(side="left", fill="x", expand=True, padx=(0,6))
        ttk.Button(inner_x, text="ì°¾ê¸°", command=self.pick_excel).pack(side="left")
        self.load_stat = tk.StringVar(value="ì—‘ì…€ ë¯¸ì„ íƒ")
        ttk.Label(inner_x, textvariable=self.load_stat).pack(side="left", padx=10)

        # ì›ê³  ìŠ¬ë¡¯ 4ê°œ (2x2) â€” í•‘í¬ ë°°ì§€ labelwidget ì‚¬ìš©
        frm_slots = ttk.Frame(root, style="TFrame")
        frm_slots.pack(fill="both", expand=True, padx=16, pady=6)
        for r in range(2): frm_slots.rowconfigure(r, weight=1)
        for c in range(2): frm_slots.columnconfigure(c, weight=1)

        self.slot_img_vars = []
        self.slot_no_vars = []
        slot_frames = []
        for i in range(1, 5):
            title = tk.Label(frm_slots, text=f"ì›ê³  ìŠ¬ë¡¯ {i}",
                             bg=UI_PINK_BG, fg=UI_PINK_FG,
                             font=("ë§‘ì€ ê³ ë”•", 10, "bold"), padx=8, pady=2)
            f = ttk.LabelFrame(frm_slots, labelwidget=title, style="Card.TLabelframe", padding=0)
            slot_frames.append(f)

        slot_frames[0].grid(row=0, column=0, sticky="nsew", padx=6, pady=6)
        slot_frames[1].grid(row=0, column=1, sticky="nsew", padx=6, pady=6)
        slot_frames[2].grid(row=1, column=0, sticky="nsew", padx=6, pady=6)
        slot_frames[3].grid(row=1, column=1, sticky="nsew", padx=6, pady=6)

        for i in range(1, 5):
            frame = slot_frames[i-1]
            inner = ttk.Frame(frame, padding=8, style="TFrame")
            inner.pack(fill="both", expand=True)

            row1 = ttk.Frame(inner, style="TFrame"); row1.pack(fill="x", pady=(2,4))
            ttk.Label(row1, text="ì´ë¯¸ì§€ íŒŒì¼:").pack(side="left")
            ivar = tk.StringVar(); self.slot_img_vars.append(ivar)
            e = ttk.Entry(row1, textvariable=ivar); e.pack(side="left", fill="x", expand=True, padx=6)
            ttk.Button(row1, text="ì„ íƒ", command=lambda v=ivar: self.pick_image(v)).pack(side="left")

            row2 = ttk.Frame(inner, style="TFrame"); row2.pack(fill="x")
            ttk.Label(row2, text="ì›ê³ ë²ˆí˜¸(1~4):").pack(side="left")
            nvar = tk.StringVar(value=str(i)); self.slot_no_vars.append(nvar)
            ttk.Spinbox(row2, from_=1, to=4, textvariable=nvar, width=5)\
                .pack(side="left", padx=(6, 0))

        # ì•¡ì…˜ ë²„íŠ¼ (ê°€ìš´ë° ì •ë ¬)
        frm_act_outer = ttk.Frame(root, style="TFrame")
        frm_act_outer.pack(fill="x", padx=16, pady=8)
        frm_act_inner = ttk.Frame(frm_act_outer, style="TFrame")
        frm_act_inner.pack()
        btn_run = ttk.Button(frm_act_inner, text="ì´ë¯¸ì§€ í¬ë¡­Â·ì €ì¥ ì‹¤í–‰", command=self.run_crop)
        btn_url = ttk.Button(frm_act_inner, text="URL ìƒì„±", command=self.run_url)
        btn_run.pack(side="left", padx=8, pady=2)
        btn_url.pack(side="left", padx=8, pady=2)

        # ì§„í–‰ë¥ ë°”: ë¼ë²¨ + % í‘œì‹œ
        frm_prog = ttk.Frame(root, style="TFrame")
        frm_prog.pack(fill="x", padx=16, pady=(0,6))
        ttk.Label(frm_prog, text="ì§„í–‰ë¥ ").pack(anchor="w")
        self.prog = ttk.Progressbar(frm_prog, style="Accent.Horizontal.TProgressbar",
                                    maximum=100, mode="determinate")
        self.prog.pack(fill="x")
        self.prog_pct = tk.StringVar(value="0%")
        tk.Label(frm_prog, textvariable=self.prog_pct, font=("ë§‘ì€ ê³ ë”•", 9),
                 bg=UI_BG, fg="#374151").pack(anchor="e", pady=(2,0))

        # ë¡œê·¸
        self.log = scrolledtext.ScrolledText(root, height=16)
        self.log.configure(bg="#FFFFFF", fg="#111827", font=("Consolas", 10))
        self.log.pack(fill="both", expand=True, padx=16, pady=6)

        # ìƒíƒœ
        self.excel_rows = []
        self.logs_dir = os.path.join(os.getcwd(), "logs")
        os.makedirs(self.logs_dir, exist_ok=True)
        self.log_file = os.path.join(self.logs_dir, datetime.datetime.now().strftime("%Y%m%d_%H%M%S") + ".txt")

    def pick_excel(self):
        path = filedialog.askopenfilename(
            title="ì—‘ì…€ íŒŒì¼ ì„ íƒ",
            filetypes=[("Excel", "*.xlsx *.xlsm *.xltx *.xltm")]
        )
        if not path:
            return
        self.xlsx_var.set(path)
        self.log_clear()
        self.prog_set(0)
        try:
            self.excel_rows = read_rows_from_excel(path, self.logger)
            self.load_stat.set(f"ë¡œë“œë¨: {len(self.excel_rows)}í–‰")
        except Exception as e:
            self.excel_rows = []
            self.load_stat.set("ë¡œë“œ ì‹¤íŒ¨")
            self.logger(f"âŒ [ì—ëŸ¬] ì—‘ì…€ ë¡œë“œ ì‹¤íŒ¨: {e}")

    def pick_image(self, var: tk.StringVar):
        path = filedialog.askopenfilename(
            title="ì´ë¯¸ì§€ ì„ íƒ",
            filetypes=[("ì´ë¯¸ì§€", "*.jpg *.jpeg *.png *.bmp *.tif *.tiff *.webp")]
        )
        if path:
            var.set(path)

    def run_crop(self):
        if not self.excel_rows:
            self.logger("â„¹ï¸ [ì‹¤í–‰ì¤‘ë‹¨] ì—‘ì…€ì„ ë¨¼ì € ì„ íƒ/ë¡œë“œí•˜ì„¸ìš”.")
            return
        slots = []
        for i in range(4):
            imgp = self.slot_img_vars[i].get().strip() or None
            try:
                wno = int((self.slot_no_vars[i].get() or "").strip())
            except:
                wno = None
            if wno not in [1,2,3,4]:
                if imgp:
                    self.logger(f"â„¹ï¸ [ì•Œë¦¼] ìŠ¬ë¡¯{i+1}: ì›ê³ ë²ˆí˜¸ 1~4 ì•„ë‹˜ â†’ ì œì™¸")
                slots.append((None, None))
            else:
                slots.append((imgp, wno))

        try:
            self.prog_set(0)
            self.logger("â–¶ï¸ [ì‹¤í–‰] ì´ë¯¸ì§€ í¬ë¡­Â·ì €ì¥ ì‹œì‘")
            process_images_for_all_rows(self.excel_rows, slots, self.logger, self.prog_set)
            self.logger("âœ… [ì™„ë£Œ] ì´ë¯¸ì§€ í¬ë¡­Â·ì €ì¥ ë")
        except Exception as e:
            self.logger(f"âŒ [ì—ëŸ¬] ì‹¤í–‰ ì¤‘ ì˜ˆì™¸: {e}\n{traceback.format_exc()}")
        finally:
            self.flush_log_to_file()

    def run_url(self):
        if not self.excel_rows:
            self.logger("â„¹ï¸ [ì‹¤í–‰ì¤‘ë‹¨] ì—‘ì…€ì„ ë¨¼ì € ì„ íƒ/ë¡œë“œí•˜ì„¸ìš”.")
            return
        try:
            self.logger("â–¶ï¸ [URL] ìƒì„± ì‹œì‘")
            generate_urls_for_all_rows(self.excel_rows, self.logger)
            self.logger("âœ… [URL] ìƒì„± ë")
        except Exception as e:
            self.logger(f"âŒ [ì—ëŸ¬] URL ìƒì„± ì¤‘ ì˜ˆì™¸: {e}")
        finally:
            self.flush_log_to_file()

    # ---- ë¡œê·¸/ì§„í–‰ ----
    def logger(self, msg: str):
        ts = datetime.datetime.now().strftime("%H:%M:%S")
        self.log.config(state="normal")
        self.log.insert("end", f"[{ts}] {msg}\n")
        self.log.see("end")
        self.log.config(state="disabled")
        self.root.update_idletasks()

    def log_clear(self):
        self.log.config(state="normal")
        self.log.delete("1.0", "end")
        self.log.config(state="disabled")

    def prog_set(self, percent: int):
        percent = max(0, min(100, int(percent)))
        self.prog['value'] = percent
        self.prog_pct.set(f"{percent}%")
        self.root.update_idletasks()

    def flush_log_to_file(self):
        try:
            content = self.log.get("1.0", "end")
            with io.open(self.log_file, "w", encoding="utf-8") as f:
                f.write(content)
        except Exception:
            pass

def main():
    root = tk.Tk()
    App(root)
    root.mainloop()

if __name__ == "__main__":
    main()
import time
import random
import pandas as pd
import os
import time
import tkinter as tk
import threading
from tkinter import ttk,messagebox
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from datetime import datetime
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from urllib.parse import urljoin  
from urllib.parse import urlparse  
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException
from selenium import webdriver
from selenium.webdriver.common.by import By
from openai import OpenAI
from selenium.common.exceptions import WebDriverException
from tkinter import filedialog


# ì´ë¯¸ BESTë¥¼ ìˆ˜ì§‘í•´ì„œ ë°©ë¬¸í•œ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´/ë¸Œëœë“œìŠ¤í† ì–´ í‚¤
VISITED_STORE_KEYS = set()
FORBIDDEN_KEYWORDS = set()
START_URL = "https://search.shopping.naver.com/search/category/100000005"
SCROLL_COUNT = 5                    # ê° í˜ì´ì§€ë§ˆë‹¤ ìŠ¤í¬ë¡¤ 5ë²ˆ
SCROLL_DELAY_RANGE = (1.0, 2.0)     # ìŠ¤í¬ë¡¤ ì‚¬ì´ ëœë¤ ëŒ€ê¸° (ì´ˆ)

# ğŸ‘‡ í´ë¦­ í›„ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„ ë²”ìœ„(ì´ˆ) â€“ í•„ìš”í•˜ë©´ ìˆ«ìë§Œ ë°”ê¿”ì„œ íŠœë‹
CLICK_DELAY_RANGE = (1.5, 3.0)

SKIP_MALL_ALTS = {
    "Gë§ˆì¼“", "ì˜¥ì…˜", "ì¿ íŒ¡", "CJì˜¨ìŠ¤íƒ€ì¼", "SSGë‹·ì»´", "ë¡¯ë°í™ˆì‡¼í•‘",
    "11ë²ˆê°€", "í˜„ëŒ€Hmall", "GSSHOP", "ì‹ ì„¸ê³„ëª°", "ì»¬ë¦¬", "í™ˆì•¤ì‡¼í•‘","ë¡¯ë°ON","ì˜¤ëŠ˜ì˜ì§‘","ì‚¼ì„±ë‹·ì»´","ì§€ê·¸ì¬ê·¸",
    "ì‚¼ì„±ë‹·ì»´", "AKëª°", "LFëª°", "íƒ‘í…ëª°", "ë¬´ì‹ ì‚¬", "ìŠ¤íƒ€ì¼ë‚œë‹¤", "Wì»¨ì…‰", "29CM", "ë¸Œëœë””",
    "SKìŠ¤í† ì•„","í•˜ì´ë§ˆíŠ¸ì‡¼í•‘ëª°","ë¡¯ë°ON"

}

client = None
MAX_RETRY = 10  # ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜

API_KEY_FILE = "openai_api_key.txt"  # ê°™ì€ í´ë”ì— ì €ì¥ë  íŒŒì¼ ì´ë¦„


# ---- í¬ë¡¤ëŸ¬/GUI ê³µìœ  ìƒíƒœ ----
driver = None          # í¬ë¡¬ ë“œë¼ì´ë²„ ì¸ìŠ¤í„´ìŠ¤
crawl_thread = None    # ë°±ê·¸ë¼ìš´ë“œ ìˆ˜ì§‘ ì“°ë ˆë“œ
STOP_REQUESTED = False # ì¤‘ë‹¨ ìš”ì²­ í”Œë˜ê·¸
forbidden_path_var = None  # ê¸ˆì¹™ì–´ íŒŒì¼ ê²½ë¡œ (ë‚˜ì¤‘ì— ì´ˆê¸°í™”)
client = None   # â† ì—¬ê¸°ê¹Œì§€ë§Œ



def start_collect():
    global STOP_REQUESTED, crawl_thread, CLICK_DELAY_RANGE

    if driver is None:
        messagebox.showerror("ì—ëŸ¬", "ë¨¼ì € [ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ]ìœ¼ë¡œ í¬ë¡¬ì„ ì—´ì–´ì£¼ì„¸ìš”.")
        return

    # âœ… 0) API Key ì½ì–´ì„œ client ìƒì„±
    api_key = key_entry.get().strip()
    if not api_key:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ë¨¼ì € API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return

    try:
        client = OpenAI(api_key=api_key)
        gui_log("[INFO] OpenAI API Key ì„¤ì • ì™„ë£Œ")
    except Exception as e:
        messagebox.showerror("API ì—ëŸ¬", f"API Key ì„¤ì • ì¤‘ ì˜¤ë¥˜: {e}")
        return
    # 1) í˜ì´ì§€ ë²”ìœ„
    try:
        start_page = int(start_page_var.get())
        end_page   = int(end_page_var.get())
    except Exception:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ì‹œì‘/ë í˜ì´ì§€ëŠ” ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return

    if start_page <= 0 or end_page < start_page:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "í˜ì´ì§€ ë²”ìœ„ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return

    # 2) ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ í¬í•¨ ì—¬ë¶€
    include_brand_catalog = (link_option_var.get() == "include")
     # â­ 2-1) ê´‘ê³  í¬í•¨ ì—¬ë¶€ 
    include_ads = (ad_option_var.get() == "include")

    # 3) í´ë¦­ ê°„ê²©
    try:
        min_click = float(min_click_sec_var.get())
        max_click = float(max_click_sec_var.get())
        if min_click < 0 or max_click < min_click:
            raise ValueError
    except Exception:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "í´ë¦­ ê°„ê²©(ìµœì†Œ/ìµœëŒ€)ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return

    CLICK_DELAY_RANGE = (min_click, max_click)

    # 4) ê¸ˆì¹™ì–´ íŒŒì¼ ê²½ë¡œ
    forbidden_file_path = forbidden_path_var.get().strip() or None

    # 5) ì´ë¯¸ ëŒê³  ìˆëŠ”ì§€ ì²´í¬
    if crawl_thread is not None and crawl_thread.is_alive():
        messagebox.showwarning("ì•Œë¦¼", "ì´ë¯¸ ìˆ˜ì§‘ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.")
        return

    STOP_REQUESTED = False
    start_button.config(state="disabled")
    stop_button.config(state="normal")

    gui_log(f"[INFO] ìˆ˜ì§‘ ì‹œì‘: {start_page}~{end_page}í˜ì´ì§€ / ë¸Œëœë“œì¹´íƒˆë¡œê·¸={'í¬í•¨' if include_brand_catalog else 'ì œì™¸'}")

    def worker():
        try:
            run_crawler(start_page, end_page, include_brand_catalog, forbidden_file_path,include_ads=include_ads)
        finally:
            root.after(0, lambda: start_button.config(state="normal"))
            root.after(0, lambda: stop_button.config(state="disabled"))

    crawl_thread = threading.Thread(target=worker, daemon=True)
    crawl_thread.start()

def stop_collect():
    global STOP_REQUESTED, crawl_thread

    if crawl_thread is None or not crawl_thread.is_alive():
        messagebox.showinfo("ì¤‘ë‹¨", "í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ìˆ˜ì§‘ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    STOP_REQUESTED = True
    gui_log("[INFO] ì¤‘ë‹¨ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. í˜„ì¬ í˜ì´ì§€ ì‘ì—…ì´ ëë‚˜ë©´ ë©ˆì¶œ ê±°ì˜ˆìš”.")


def get_mall_name_for_link(link_element):
    """
    ìƒí’ˆ ì œëª©/ì´ë¯¸ì§€ <a> ìš”ì†Œì—ì„œ ê°™ì€ ì¹´ë“œ ì•ˆì˜
    ëŒ€í‘œ ëª° ì´ë¦„(ì´ë¯¸ì§€ alt ë˜ëŠ” í…ìŠ¤íŠ¸)ì„ ì¶”ì¶œ.
    ëª» ì°¾ìœ¼ë©´ "" ë°˜í™˜.
    """
    try:
        # ìƒí’ˆ ì¹´ë“œ(div.product_item__... í˜¹ì€ ê´‘ê³  ì¹´ë“œ)ê¹Œì§€ ì˜¬ë¼ê°€ê¸°
        card = link_element.find_element(
            By.XPATH,
            './ancestor::div[contains(@class, "product_item__") or contains(@class, "adProduct_item__")][1]'
        )
    except Exception:
        return ""

    try:
        # ì¹´ë“œ ì•ˆì—ì„œ ëª° ì˜ì—­ ì°¾ê¸°
        mall_title_div = card.find_element(
            By.CSS_SELECTOR,
            'div[class^="product_mall_title__"]'
        )
    except Exception:
        return ""

    # 1ìˆœìœ„: ì´ë¯¸ì§€ alt (ì¿ íŒ¡, Gë§ˆì¼“ ë“±)
    try:
        img = mall_title_div.find_element(By.TAG_NAME, "img")
        mall_name = (img.get_attribute("alt") or "").strip()
        if mall_name:
            return mall_name
    except Exception:
        pass

    # 2ìˆœìœ„: í…ìŠ¤íŠ¸
    try:
        text = mall_title_div.text.strip()
        return text
    except Exception:
        return ""

def is_preorder_product_link(link_element):
    """
    ì¹´í…Œê³ ë¦¬(ê²€ìƒ‰) í˜ì´ì§€ì—ì„œ:
    - ìƒí’ˆ ì œëª© ì˜ì—­(div.product_title__ ë˜ëŠ” div.adProduct_title__) ì•ˆì—
    - 'ì˜ˆì•½êµ¬ë§¤'ë¼ê³  ì íŒ buttonì´ ìˆìœ¼ë©´ True ë°˜í™˜ (ìˆ˜ì§‘ì—ì„œ ì œì™¸)

    link_element: ê²€ìƒ‰ê²°ê³¼ì˜ <a> íƒœê·¸ (product_link__*, adProduct_link__* ë“±)
    """
    try:
        # ì´ ë§í¬ê°€ ì†í•œ ì œëª© ì˜ì—­ div (ìƒí’ˆ/ê´‘ê³  ë‘˜ ë‹¤ ëŒ€ì‘)
        title_div = link_element.find_element(
            By.XPATH,
            './ancestor::div[contains(@class, "product_title__") or contains(@class, "adProduct_title__")][1]'
        )
    except Exception:
        # ì œëª© ì˜ì—­ì„ ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ ì˜ˆì•½êµ¬ë§¤ë¡œ ë³´ì§€ ì•ŠìŒ
        return False

    try:
        # ì œëª© ì˜ì—­ ì•ˆì˜ ëª¨ë“  ë²„íŠ¼ í…ìŠ¤íŠ¸ í™•ì¸
        buttons = title_div.find_elements(By.TAG_NAME, "button")
        for btn in buttons:
            text = (btn.text or "").strip()
            if "ì˜ˆì•½êµ¬ë§¤" in text:
                try:
                    name = (link_element.get_attribute("title") or link_element.text or "").strip()
                except Exception:
                    name = ""
                print(f"[SKIP] ì˜ˆì•½êµ¬ë§¤ ìƒí’ˆì´ë¼ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŒ: {name}")
                return True
    except Exception:
        pass

    return False

def is_skip_mall_for_link(link_element):
    """
    ë§í¬ê°€ ì†í•œ ìƒí’ˆ ì¹´ë“œì˜ ëª° ì´ë¦„ì´ SKIP_MALL_ALTSì— í•´ë‹¹í•˜ë©´ True.
    (Gë§ˆì¼“, ì¿ íŒ¡, 11ë²ˆê°€, ë¬´ì‹ ì‚¬ ë“± ì˜¤í”ˆë§ˆì¼“/ì œì™¸ëª° ìŠ¤í‚µìš©)
    """
    mall_name = get_mall_name_for_link(link_element)
    if not mall_name:
        return False

    for skip in SKIP_MALL_ALTS:
        if skip and skip in mall_name:
            print(f"[SKIP] ì œì™¸ ëª°({mall_name}) ìƒí’ˆì´ë¼ í´ë¦­í•˜ì§€ ì•ŠìŒ")
            return True

    return False


def gui_log(msg: str):
    print(msg)
    try:
        log_text.insert("end", msg + "\n")
        log_text.see("end")
    except Exception:
        pass




def get_store_key(url: str) -> str:
    """
    smartstore / brandstore URLì—ì„œ
    'ë„ë©”ì¸/ì²«ë²ˆì§¸ path ì¡°ê°'ë§Œ ë–¼ì–´ì„œ ìŠ¤í† ì–´ë¥¼ ëŒ€í‘œí•˜ëŠ” í‚¤ë¡œ ì‚¬ìš©
    """
    try:
        parsed = urlparse(url)
        path = (parsed.path or "").strip("/")
        first = path.split("/", 1)[0] if path else ""
        return f"{parsed.netloc}/{first}"
    except Exception:
        return url


def append_to_csv_incremental(records, filename):
    """
    í”„ë¡œê·¸ë¨ ë„ì¤‘ êº¼ì ¸ë„ ë‚¨ë„ë¡,
    ìƒˆë¡œ ìˆ˜ì§‘ëœ ë ˆì½”ë“œë¥¼ ë°”ë¡œë°”ë¡œ CSVì— ì¶”ê°€ ì €ì¥í•˜ëŠ” í•¨ìˆ˜.
    - records: [{...}, {...}] í˜•íƒœ
    - filename: ì €ì¥í•  CSV íŒŒì¼ ì´ë¦„
    """
    if not records:
        return

    df = pd.DataFrame(records)

    # íŒŒì¼ì´ ì—†ìœ¼ë©´ header í¬í•¨, ìˆìœ¼ë©´ header ì—†ì´ ì´ì–´ì“°ê¸°
    header = not os.path.exists(filename)

    df.to_csv(
        filename,
        mode="a",              # ì´ì–´ì“°ê¸°
        header=header,
        index=False,
        encoding="utf-8-sig"
    )

###############################################################
# 3. ìº¡ì±  ì´ë¯¸ì§€ Base64 ì•ˆì •ì ìœ¼ë¡œ ë¡œë”©
###############################################################
def get_captcha_image_base64(driver):
    """
    rcpt_imgê°€ ë¡œë”©ë  ë•Œê¹Œì§€ ë°˜ë³µ í™•ì¸í•˜ë©° base64 ì¶”ì¶œ.
    """
    for _ in range(30):  # ìµœëŒ€ 30íšŒ(ì•½ 6ì´ˆ)
        try:
            img_tag = driver.find_element(By.ID, "rcpt_img")
            src = img_tag.get_attribute("src")

            if src and "base64," in src:
                return src.split("base64,")[1]
        except:
            pass

        time.sleep(random.uniform(*CLICK_DELAY_RANGE))

    raise Exception("ERROR: ìº¡ì±  ì´ë¯¸ì§€ base64 ë¡œë”© ì‹¤íŒ¨")


###############################################################
# 4. Visionìœ¼ë¡œ ìº¡ì±  í’€ê¸° (ì˜¤ì§ ì •ë‹µë§Œ)
###############################################################
def solve_captcha(question_text, img_base64):

    global client  # ğŸ”¹ ì „ì—­ client ì‚¬ìš© ì„ ì–¸

    # âœ… ì•„ì§ client ì•ˆ ë§Œë“¤ì–´ì¡Œìœ¼ë©´, GUIì—ì„œ API Key ì½ì–´ì„œ ìƒì„±
    if client is None:
        api_key = key_entry.get().strip()
        if not api_key:
            raise RuntimeError(
                "API Keyê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.\n"
                "GUIì˜ [API Key ì…ë ¥] ì¹¸ì— í‚¤ë¥¼ ë„£ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
            )
        client = OpenAI(api_key=api_key)
        save_api_key_to_file(api_key)
    prompt = (
        "ì´ë¯¸ì§€ì™€ ë¬¸ì œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •ë‹µë§Œ ì¶œë ¥í•˜ë¼.\n"
        "ë¬¸ì¥ì€ ê¸ˆì§€.\n"
        "ì„¤ëª… ê¸ˆì§€.\n"
        "-ì…ë‹ˆë‹¤ -ë‹¤ -í•©ë‹ˆë‹¤ ê¸ˆì§€.\n"
        "ì •ë‹µë§Œ ì¶œë ¥.\n"
        "ìˆ«ì ë˜ëŠ” ë‹¨ì–´ë§Œ ì¶œë ¥.\n"
        f"ë¬¸ì œ: {question_text}"
    )

    response = client.chat.completions.create(
        model="gpt-5",
        messages=[
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                    {"type": "image_url", "image_url": {"url": f"data:image/png;base64,{img_base64}"}}
                ]
            }
        ]
    )

    answer = response.choices[0].message.content.strip()

    # ë¶ˆí•„ìš”í•œ ë¬¸ì¥, ê³µë°± ì œê±°
    answer = answer.replace("\n", "").strip()

    # ë§Œì•½ ê³µë°±ì´ í¬í•¨ë˜ì–´ ìˆê³  ë¬¸ì¥ì´ë©´ â†’ ì²« ë‹¨ì–´ë§Œ ì‚¬ìš©
    if (" " in answer) and (not answer.isdigit()):
        answer = answer.split()[0]

    print("[INFO] Vision ì •ë‹µ =", answer)
    return answer


###############################################################
# 5. ì‹¤íŒ¨ ê²€ì¶œ (ì˜¤ë¥˜ë¬¸êµ¬ + ì´ë¯¸ì§€ ë³€ê²½)
###############################################################
###############################################################
# 5. ì‹¤íŒ¨ ê²€ì¶œ (ë¡œì§ ê°•í™”)
###############################################################
def check_fail(before_img,driver):
    """
    [True ë°˜í™˜] -> ì‹¤íŒ¨ (ì¬ì‹œë„ í•„ìš”)
    [False ë°˜í™˜] -> ì„±ê³µ (ë‹¤ìŒ ë‹¨ê³„ë¡œ)
    """
    time.sleep(2.5)  # <--- ì¤‘ìš”: ì„œë²„ ì‘ë‹µ ë° DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì‹œê°„ì„ 2.5ì´ˆë¡œ ëŠ˜ë¦¼

    # 1) [Alert ì°½ ê°ì§€] ë¸Œë¼ìš°ì € ê²½ê³ ì°½ì´ ë–´ë‹¤ë©´ ì‹¤íŒ¨
    try:
        from selenium.webdriver.common.alert import Alert
        alert = driver.switch_to.alert
        print(f"[DEBUG] Alert ê°ì§€ë¨: {alert.text}")
        alert.accept()  # í™•ì¸ ë²„íŠ¼ ëˆ„ë¦„
        return True     # ì‹¤íŒ¨ ì²˜ë¦¬
    except:
        pass

    # 2) [ì…ë ¥ì°½ ì´ˆê¸°í™” ê°ì§€] ê°€ì¥ ê°•ë ¥í•œ íŒíŠ¸
    # ë°©ê¸ˆ ê°’ì„ ì…ë ¥í–ˆëŠ”ë°, í˜„ì¬ valueê°€ ë¹„ì–´ìˆë‹¤ë©´ ì‹¤íŒ¨í•´ì„œ ë¦¬ì…‹ëœ ê²ƒì„.
    try:
        input_box = driver.find_element(By.ID, "rcpt_answer")
        current_val = input_box.get_attribute("value")
        
        # ì…ë ¥ì°½ì´ ì—¬ì „íˆ í™”ë©´ì— ë³´ì´ê³  + ê°’ì´ ë¹„ì–´ìˆë‹¤ë©´ -> ì‹¤íŒ¨
        if input_box.is_displayed() and current_val == "":
            print("[DEBUG] ì…ë ¥ì°½ì´ ë¹„ì›Œì§(Reset) â†’ ì‹¤íŒ¨")
            return True
    except:
        # ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ -> ìº¡ì± ê°€ ì‚¬ë¼ì§ -> ì„±ê³µì¼ ê°€ëŠ¥ì„± ë†’ìŒ
        pass

    # 3) [ì´ë¯¸ì§€ ë³€ê²½ ê°ì§€]
    try:
        after_element = driver.find_element(By.ID, "rcpt_img")
        after_src = after_element.get_attribute("src")
        after_img = after_src.split("base64,")[1] if "base64," in after_src else ""

        if after_img != before_img:
            print("[DEBUG] ìº¡ì±  ì´ë¯¸ì§€ê°€ ë³€ê²½ë¨ â†’ ì‹¤íŒ¨")
            return True
    except:
        pass

    # 4) [ì—ëŸ¬ ë¬¸êµ¬ ê°ì§€]
    try:
        msg_el = driver.find_element(By.ID, "rcpt_info")
        msg = msg_el.text.strip()
        # ë¬¸êµ¬ê°€ ë¹„ì–´ìˆì§€ ì•Šê³ , ì´ˆê¸° ì•ˆë‚´ ë¬¸êµ¬ì™€ ë‹¤ë¥´ê±°ë‚˜ ë¶€ì •ì ì¸ ë‹¨ì–´ í¬í•¨ ì‹œ
        if msg and any(k in msg for k in ["í‹€ë ¸", "ë‹¤ì‹œ", "ì¼ì¹˜", "ì˜¤ë¥˜", "í™•ì¸"]):
            print(f"[DEBUG] ì‹¤íŒ¨ ë¬¸êµ¬ ê°ì§€: {msg}")
            return True
    except:
        pass

    # ìœ„ ì‹¤íŒ¨ ì¡°ê±´ë“¤ì— ê±¸ë¦¬ì§€ ì•Šì•˜ë‹¤ë©´ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
    return False



###############################################################
# 6. ì „ì²´ ì‹œë„ ë£¨í”„ (ì„±ê³µ/ì‹¤íŒ¨ íŒë³„ ë¡œì§ ê°œì„ )
###############################################################
def try_captcha(driver):

    for attempt in range(1, MAX_RETRY + 1):
        print(f"\n[TRY] {attempt}ë²ˆì§¸ ì‹œë„")

        # 1. ìº¡ì±  ì˜ì—­ ì¡´ì¬ í™•ì¸ (ì´ë¯¸ ì„±ê³µí•´ì„œ ì—†ìœ¼ë©´ ì¢…ë£Œ)
        try:
            driver.find_element(By.ID, "rcpt_img")
        except:
            print("[SUCCESS] ìº¡ì± ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!")
            return True

        # 2. ë¬¸ì œ í…ìŠ¤íŠ¸ ë° ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
        try:
            question_text = driver.find_element(By.ID, "rcpt_info").text.strip()
        except:
            question_text = ""
        
        before_img = get_captcha_image_base64(driver)

        # 3. Vision ì •ë‹µ ì¶”ì¶œ
        answer = solve_captcha(question_text, before_img)
        if not answer:
            print("[WARN] ì •ë‹µ ì¶”ì¶œ ì‹¤íŒ¨, ìƒˆë¡œê³ ì¹¨ í›„ ì¬ì‹œë„")
            try: driver.find_element(By.ID, "cpt_refresh").click()
            except: pass
            time.sleep(7)
            continue

        # 4. ì…ë ¥ ë° ì œì¶œ
        try:
            input_box = driver.find_element(By.ID, "rcpt_answer")
            input_box.clear()
            input_box.send_keys(answer)
            
            confirm_btn = driver.find_element(By.ID, "cpt_confirm") # í™•ì¸ ë²„íŠ¼ ID
            confirm_btn.click()
        except Exception as e:
            print(f"[ERROR] ì…ë ¥/ì œì¶œ ì¤‘ ì˜¤ë¥˜: {e}")
            continue

        # 5. [í•µì‹¬ ìˆ˜ì •] ê²°ê³¼ íŒë³„ (3ì´ˆ ëŒ€ê¸°)
        time.sleep(7) 

        # (A) Alert(ê²½ê³ ì°½)ì´ ë–´ëŠ”ì§€ ë¨¼ì € í™•ì¸ (í‹€ë ¸ì„ ë•Œ ì£¼ë¡œ ëœ¸)
        try:
            from selenium.webdriver.common.alert import Alert
            alert = driver.switch_to.alert
            print(f"[FAIL] ê²½ê³ ì°½ ëœ¸: {alert.text}")
            alert.accept()
            # ê²½ê³ ì°½ì´ ë–´ë‹¤ëŠ” ê±´ 100% ì‹¤íŒ¨ -> ë‹¤ìŒ ë£¨í”„ë¡œ
            continue 
        except:
            pass

        # (B) ìº¡ì±  ì…ë ¥ì°½ì´ "ì—¬ì „íˆ ì¡´ì¬í•˜ëŠ”ê°€?" í™•ì¸
        try:
            # 3ì´ˆê°€ ì§€ë‚¬ëŠ”ë°ë„ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ìˆë‹¤? -> ì•„ì§ í˜ì´ì§€ê°€ ì•ˆ ë„˜ì–´ê° -> ì‹¤íŒ¨!
            remain_input = driver.find_element(By.ID, "rcpt_answer")
            
            # ê°’ì„ í™•ì¸í•´ë´…ë‹ˆë‹¤ (í‹€ë¦¬ë©´ ë³´í†µ ì§€ì›Œì§)
            if remain_input.get_attribute("value") == "":
                print("[FAIL] ì…ë ¥ì°½ì´ ë¹„ì›Œì§ (ì˜¤ë‹µ)")
            else:
                print("[FAIL] í˜ì´ì§€ê°€ ë„˜ì–´ê°€ì§€ ì•ŠìŒ (ì˜¤ë‹µ ê°€ëŠ¥ì„± ë†’ìŒ)")
                
            # ì‹¤íŒ¨í–ˆìœ¼ë‹ˆ ì´ë¯¸ì§€ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ëˆ„ë¥´ê³  ì¬ì‹œë„
            try: driver.find_element(By.ID, "cpt_refresh").click()
            except: pass
            time.sleep(3)
            continue # ë‹¤ìŒ forë¬¸(attempt)ìœ¼ë¡œ ì´ë™

        except:
            # (C) ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ (ì—ëŸ¬ ë°œìƒ) -> ìš”ì†Œê°€ ì‚¬ë¼ì§ -> ì„±ê³µ!
            print("[SUCCESS] ì…ë ¥ì°½ì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤. (ì„±ê³µ!)")
            return True

    print("[ERROR] ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨")
    return False
# =======================================================
def is_captcha_page(driver):
    """
    í˜„ì¬ í˜ì´ì§€ê°€ ìº¡ì± (ë³´ì•ˆë¬¸ì) í˜ì´ì§€ì¸ì§€ ëŒ€ëµ íŒë³„.
    - title ì— 'captcha', 'capcha' ê°™ì€ ë‹¨ì–´ê°€ ìˆëŠ”ì§€
    - rcpt_img / rcpt_answer ê°™ì€ ìš”ì†Œê°€ ìˆëŠ”ì§€
    """
    # 1) í˜ì´ì§€ title ì²´í¬
    try:
        title = (driver.title or "").lower()
        if "captcha" in title or "capcha" in title:
            return True
    except Exception:
        pass

    # 2) ëŒ€í‘œì ì¸ ìº¡ì±  ìš”ì†Œ(id)ë“¤ ì²´í¬
    for elem_id in ("rcpt_img", "rcpt_answer", "cpt_confirm"):
        try:
            driver.find_element(By.ID, elem_id)
            return True
        except NoSuchElementException:
            continue
        except Exception:
            continue

    return False

def handle_captcha_if_needed(driver):
    """
    ìº¡ì±  í˜ì´ì§€ê°€ ëœ¬ ê²½ìš°:
    - í•œ ë²ˆ ê°ì§€ë˜ë©´, ì‚¬ìš©ìì—ê²Œ ì§ì ‘ í’€ë¼ê³  ì•ˆë‚´
    - ì‚¬ìš©ìê°€ í•´ê²°í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ì‹œ í™•ì¸
    - ì—¬ì „íˆ ìº¡ì± ë©´ False ë°˜í™˜ (ì´ ë§í¬/ìŠ¤í† ì–´ëŠ” ìŠ¤í‚µ)
    - ìº¡ì± ê°€ ì‚¬ë¼ì¡Œìœ¼ë©´ True ë°˜í™˜ (ê³„ì† ì§„í–‰)
    """
    if not is_captcha_page(driver):
        return True  # í‰ìƒì‹œ í˜ì´ì§€

    print("\n[ì£¼ì˜] ìº¡ì± (ë³´ì•ˆë¬¸ì) í˜ì´ì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.")
    try_captcha(driver)

    # ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸
    if is_captcha_page(driver):
        print("[WARN] ì—¬ì „íˆ ìº¡ì±  í˜ì´ì§€ì…ë‹ˆë‹¤. ì´ ë§í¬/ìŠ¤í† ì–´ëŠ” ê±´ë„ˆëœë‹ˆë‹¤.")
        return False

    print("[INFO] ìº¡ì± ê°€ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.")
    return True


def is_adult_product_element(link_element):
    """
    ê²€ìƒ‰ê²°ê³¼ì˜ ì œëª©/ì´ë¯¸ì§€ <a> ìš”ì†Œì—ì„œ
    ê°™ì€ ìƒí’ˆ ì¹´ë“œ ì•ˆì— 'ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ' ë°°ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì„œ
    19ê¸ˆì´ë©´ True, ì•„ë‹ˆë©´ False ë¦¬í„´
    """
    try:
        # ì´ a íƒœê·¸ê°€ ì†í•œ ìƒí’ˆ ì¹´ë“œ(div.product_item__...)ê¹Œì§€ ìœ„ë¡œ ì˜¬ë¼ê°€ê¸°
        card = link_element.find_element(
            By.XPATH,
            './ancestor::div[contains(@class, "product_item__")][1]'
        )
    except Exception:
        # ìƒí’ˆ ì¹´ë“œ êµ¬ì¡° ì•„ë‹ˆë©´ ê·¸ëƒ¥ ì„±ì¸ìƒí’ˆ ì•„ë‹˜ ì²˜ë¦¬
        return False

    # 1) class ì´ë¦„ìœ¼ë¡œ ì„±ì¸ ë°°ì§€ ì°¾ê¸°
    try:
        card.find_element(By.CSS_SELECTOR, 'span[class^="adultBlock_teenager__"]')
        return True
    except Exception:
        pass

    # 2) ì‹œê°ì¥ì• ì¸ìš© í…ìŠ¤íŠ¸ 'ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ' ì°¾ê¸° (ì•ˆì „ë§)
    try:
        blind_spans = card.find_elements(By.CSS_SELECTOR, 'span.blind')
        for sp in blind_spans:
            if "ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ" in (sp.text or ""):
                return True
    except Exception:
        pass

    return False

def load_forbidden_keywords_from_path(path: str):
    """
    GUIì—ì„œ ì „ë‹¬ë°›ì€ ê¸ˆì¹™ì–´ íŒŒì¼ ê²½ë¡œë¥¼ ì´ìš©í•´
    FORBIDDEN_KEYWORDS ì„¸íŠ¸ë¥¼ ê°±ì‹ í•œë‹¤.
    (pathê°€ None/ë¹ˆë¬¸ìì—´ì´ë©´ ê¸ˆì¹™ì–´ ê¸°ëŠ¥ ë¯¸ì‚¬ìš©)
    """
    global FORBIDDEN_KEYWORDS

    if not path:
        gui_log("[INFO] ê¸ˆì§€ì–´ íŒŒì¼ ë¯¸ì‚¬ìš©")
        FORBIDDEN_KEYWORDS = set()
        return

    try:
        with open(path, "r", encoding="utf-8") as f:
            text = f.read()
    except Exception as e:
        gui_log(f"[WARN] ê¸ˆì§€ì–´ íŒŒì¼ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: {e}")
        FORBIDDEN_KEYWORDS = set()
        return

    raw_parts = []
    for line in text.splitlines():
        raw_parts.extend(line.split(";"))

    words = {p.strip() for p in raw_parts if p.strip()}
    FORBIDDEN_KEYWORDS = words
    gui_log(f"[INFO] ê¸ˆì§€ì–´ {len(words)}ê°œ ë¡œë“œ ì™„ë£Œ")

def load_forbidden_keywords():
    """
    ê¸ˆì§€ì–´ íŒŒì¼ì—ì„œ 'ê¸ˆì§€ì–´1;ê¸ˆì§€ì–´2;ê¸ˆì§€ì–´3;' í˜•ì‹ìœ¼ë¡œ ë‹¨ì–´ë¥¼ ì½ì–´ì„œ
    FORBIDDEN_KEYWORDS ì„¸íŠ¸ë¡œ ì €ì¥.
    - ì¤„ë°”ê¿ˆ ìƒê´€ ì—†ìŒ
    - ê³µë°±/ë¹ˆ í•­ëª©ì€ ìë™ ì œê±°
    """
    path = input("ê¸ˆì§€ì–´ íŒŒì¼ ê²½ë¡œ (ì—”í„° ì‹œ ì‚¬ìš© ì•ˆ í•¨) â†’ ").strip().strip('"')

    if not path:
        print("ê¸ˆì§€ì–´ íŒŒì¼ì´ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸ˆì§€ì–´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return set()

    try:
        with open(path, "r", encoding="utf-8") as f:
            text = f.read()
    except Exception as e:
        print(f"[ê²½ê³ ] ê¸ˆì§€ì–´ íŒŒì¼ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: {e}")
        return set()

    raw_parts = []
    for line in text.splitlines():
        raw_parts.extend(line.split(";"))

    words = {p.strip() for p in raw_parts if p.strip()}
    print(f"[INFO] ê¸ˆì§€ì–´ {len(words)}ê°œ ë¡œë“œ ì™„ë£Œ: {', '.join(list(words)[:10])} ...")
    return words


def is_forbidden_name(name: str) -> bool:
    """
    ìƒí’ˆëª…ì— ê¸ˆì§€ì–´ê°€ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ True.
    (ë¶€ë¶„ ë¬¸ìì—´ ê¸°ì¤€, ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ â€“ í•œê¸€ì€ ê·¸ëŒ€ë¡œ ë¹„êµ)
    """
    if not FORBIDDEN_KEYWORDS:
        return False
    if not name:
        return False

    name_norm = name.lower()
    for kw in FORBIDDEN_KEYWORDS:
        if not kw:
            continue
        if kw.lower() in name_norm:
            return True
    return False

def collect_best_products_on_all_products_page(driver):
    """
    í˜„ì¬ í˜ì´ì§€(ì „ì²´ìƒí’ˆ í˜ì´ì§€)ì—ì„œ BEST ë±ƒì§€ê°€ ë¶™ì€ ìƒí’ˆë“¤ì„ ìˆ˜ì§‘.
    ë¸Œëœë“œìŠ¤í† ì–´/ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ì˜ ë¦¬ìŠ¤íŠ¸í˜•, ê·¸ë¦¬ë“œí˜• êµ¬ì¡°ë¥¼ ëª¨ë‘ ëŒ€ì‘í•˜ë„ë¡ ê°œì„ í•¨.
    """
    best_items = []
    seen_hrefs = set()
    
    # 1. BEST ë±ƒì§€ê°€ í¬í•¨ëœ ëª¨ë“  'ìƒí’ˆ ì¹´ë“œ(li)'ë¥¼ ë¨¼ì € ì°¾ìŠµë‹ˆë‹¤.
    # (BEST ë±ƒì§€ê°€ ìˆëŠ” emì˜ ì¡°ìƒ ì¤‘ li íƒœê·¸ë¥¼ ì°¾ìŒ)
    product_cards = driver.find_elements(
        By.XPATH,
        '//li[descendant::em[contains(normalize-space(.), "BEST")]]'
    )

    print(f"[DEBUG] BEST ë±ƒì§€ê°€ ìˆëŠ” ìƒí’ˆ ì¹´ë“œ {len(product_cards)}ê°œ ë°œê²¬")

    for card in product_cards:
        # --- 0. ğŸ” ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ ë§ˆí¬ í™•ì¸ ë° ê±´ë„ˆë›°ê¸° ---
        try:
            # 'adultBlock_teenager__iVi6S' í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            # ìš”ì†Œê°€ ë°œê²¬ë˜ë©´ 19ê¸ˆ ìƒí’ˆì…ë‹ˆë‹¤.
            card.find_element(By.CLASS_NAME, "adultBlock_teenager__iVi6S")
            
            # 19ê¸ˆ ë§ˆí¬ê°€ ë°œê²¬ëœ ê²½ìš°, ìƒí’ˆëª…ì„ ì¶”ì¶œí•˜ì—¬ ì¶œë ¥í•˜ê³  ê±´ë„ˆëœë‹ˆë‹¤.
            try:
                # ìƒí’ˆëª…ì€ ì¶œë ¥ìš©ìœ¼ë¡œë§Œ ì‚¬ìš© (ì¶”ì¶œ ì‹¤íŒ¨í•´ë„ ìƒê´€ì—†ìŒ)
                product_name = card.find_element(By.XPATH, './/a[contains(@href, "/products/")]').get_attribute("title")
            except NoSuchElementException:
                product_name = "ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ìƒí’ˆ"
                
            print(f"[SKIP] ëª©ë¡ì—ì„œ 19ê¸ˆ ìƒí’ˆ ë§ˆí¬ í™•ì¸: {product_name}")
            continue # 19ê¸ˆ ìƒí’ˆì´ë¯€ë¡œ ë‹¤ìŒ ìƒí’ˆìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
            
        except NoSuchElementException:
            # 'adultBlock_teenager__iVi6S' ìš”ì†Œê°€ ì—†ìœ¼ë©´, 19ê¸ˆ ìƒí’ˆì´ ì•„ë‹ˆë¯€ë¡œ í†µê³¼
            pass
        # -------------------------------------------------------------------

        try:
            # 2. ë§í¬(href) ì¶”ì¶œ
            # ì¹´ë“œ ë‚´ë¶€ì—ì„œ /products/ê°€ í¬í•¨ëœ a íƒœê·¸ë¥¼ ì°¾ìŒ
            try:
                link_element = card.find_element(By.XPATH, './/a[contains(@href, "/products/")]')
                raw_href = link_element.get_attribute("href")
            except Exception:
                continue # ë§í¬ ì—†ìœ¼ë©´ ìŠ¤í‚µ

            if not raw_href:
                continue
                
            # ìƒëŒ€ ê²½ë¡œì¼ ê²½ìš° ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
            href = urljoin(driver.current_url, raw_href)

            if href in seen_hrefs:
                continue
            seen_hrefs.add(href)

            # 3. ìƒí’ˆëª…(Title) ì¶”ì¶œ
            title = ""
            try:
                # strong íƒœê·¸ ìš°ì„  ê²€ìƒ‰
                title_el = card.find_element(By.TAG_NAME, "strong")
                title = title_el.text.strip()
            except Exception:
                # ì‹¤íŒ¨ ì‹œ ì´ë¯¸ì§€ì˜ alt ì†ì„± ì‹œë„
                try:
                    img = card.find_element(By.TAG_NAME, "img")
                    title = img.get_attribute("alt").strip()
                except:
                    title = "ì œëª© ì—†ìŒ"

            # ê¸ˆì§€ì–´ ì²´í¬ (ê¸°ì¡´ ë¡œì§)
            if is_forbidden_name(title):
                print(f"[SKIP] ê¸ˆì§€ì–´ í¬í•¨ ìƒí’ˆ ìŠ¤í‚µ: {title}")
                continue

            best_items.append({
                "href": href,
                "text": title,
            })
            
        except Exception as e:
            # BEST ë±ƒì§€ ì™¸ì— ë‹¤ë¥¸ ì´ìœ ë¡œ íŒŒì‹± ì‹¤íŒ¨ ì‹œ
            print(f"[ERROR] ìƒí’ˆ íŒŒì‹± ì¤‘ ì˜¤ë¥˜: {e}")
            continue

    print(f"[INFO] ì „ì²´ìƒí’ˆ í˜ì´ì§€ì—ì„œ BEST {len(best_items)}ê°œ ìˆ˜ì§‘ ì™„ë£Œ")
    return best_items

def collect_best_from_current_store(driver, base_kind: str, is_brand_catalog: bool):
    """
    í˜„ì¬ íƒ­ì´ smartstore / brandstore ìƒí’ˆ(ë˜ëŠ” ìŠ¤í† ì–´) í˜ì´ì§€ë¼ê³  ê°€ì •í•˜ê³ ,
    - ìŠ¤í† ì–´ í‚¤ë¥¼ ë§Œë“  ë’¤, ì´ë¯¸ ë°©ë¬¸í•œ ìŠ¤í† ì–´ë©´ ìŠ¤í‚µ
    - ì²˜ìŒ ë°©ë¬¸í•˜ëŠ” ìŠ¤í† ì–´ë©´
        1) ì „ì²´ìƒí’ˆìœ¼ë¡œ ì´ë™(go_to_all_products_if_exists)
        2) BEST ìƒí’ˆë“¤ ìˆ˜ì§‘(collect_best_products_on_all_products_page)
    ë°˜í™˜: collect_naver_linksì—ì„œ ê·¸ëŒ€ë¡œ extend í•  ìˆ˜ ìˆëŠ” record ë¦¬ìŠ¤íŠ¸
    """
    final_url = driver.current_url
    store_key = get_store_key(final_url)

    if store_key in VISITED_STORE_KEYS:
        print(f"[SKIP] ì´ë¯¸ BESTë¥¼ ìˆ˜ì§‘í•œ ìŠ¤í† ì–´ì…ë‹ˆë‹¤: {store_key}")
        return []

    VISITED_STORE_KEYS.add(store_key)
    print(f"[STORE] ìƒˆ ìŠ¤í† ì–´ ì§„ì… â†’ {store_key}")

    # ì „ì²´ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¦¬í„´)
    go_to_all_products_if_exists(driver)

    best_items = collect_best_products_on_all_products_page(driver)

    records = []
    for item in best_items:
        records.append({
            "kind": base_kind,            # "ad" ë˜ëŠ” "product"
            "text": item["text"],         # BEST ìƒí’ˆ ì´ë¦„
            "href": item["href"],         # BEST ìƒí’ˆ ë§í¬
            "brand_catalog": is_brand_catalog,
            "store": store_key,           # ì–´ëŠ ìŠ¤í† ì–´ì—ì„œ ë‚˜ì˜¨ BESTì¸ì§€
        })
    return records


def create_driver():
    """í¬ë¡¬ ë“œë¼ì´ë²„ ìƒì„±"""
    options = webdriver.ChromeOptions()
    options.add_argument("--start-maximized")  # ì°½ ìµœëŒ€í™”
    driver = webdriver.Chrome(
        service=Service(ChromeDriverManager().install()),
        options=options
    )
    return driver


def wait_for_ok():
    """
    ë„ˆê°€ í¬ë¡¬ì—ì„œ ì¹´í…Œê³ ë¦¬/í•„í„° ë‹¤ ê³ ë¥¸ ë’¤
    CMDì—ì„œ ok ì¹˜ë©´ ì‹œì‘
    """
    user_input = input("ì¹´í…Œê³ ë¦¬/í•„í„° ì„ íƒ ëë‚˜ë©´ 'ok' ì…ë ¥ í›„ ì—”í„° â†’ ")
    if user_input.strip().lower() != "ok":
        print("okê°€ ì•„ë‹ˆë¼ì„œ ë§í¬ ìˆ˜ì§‘ ì—†ì´ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        return False
    return True


def ask_brand_catalog_option():
    """
    'ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸'ê°€ ë¶™ì€ ìƒí’ˆë„ ì €ì¥í• ì§€ ì—¬ë¶€ë¥¼ y/nìœ¼ë¡œ ì…ë ¥ë°›ê¸°
    """
    while True:
        s = input("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ í‘œì‹œëœ ìƒí’ˆ ë§í¬ë„ ì €ì¥í• ê¹Œìš”? (y/n) â†’ ")
        s = s.strip().lower()

        if s in ("y", "yes", "ë„¤", "ã…‡", "ì‘"):
            print("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ìƒí’ˆë„ í¬í•¨í•´ì„œ ì €ì¥í•©ë‹ˆë‹¤.")
            return True
        if s in ("n", "no", "ì•„ë‹ˆ", "ã„´", "ì•„ë‹ˆì˜¤"):
            print("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ìƒí’ˆì€ ì œì™¸í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.")
            return False

        print("y ë˜ëŠ” nìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.")


def ask_page_range():
    """
    ìˆ˜ì§‘í•  í˜ì´ì§€ ë²”ìœ„ ì…ë ¥ë°›ê¸° (ì˜ˆ: 1 5, 11 15)
    """
    while True:
        s = input("ìˆ˜ì§‘í•  í˜ì´ì§€ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1 5) â†’ ")
        parts = s.strip().split()
        if len(parts) != 2:
            print("ë‘ ê°œì˜ ìˆ«ìë¥¼ ë„ì–´ì“°ê¸°ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. ì˜ˆ: 1 5")
            continue
        try:
            start_page = int(parts[0])
            end_page = int(parts[1])
        except ValueError:
            print("ìˆ«ìë¡œ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”. ì˜ˆ: 1 5")
            continue

        if start_page <= 0 or end_page <= 0:
            print("í˜ì´ì§€ ë²ˆí˜¸ëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.")
            continue
        if end_page < start_page:
            print("ë í˜ì´ì§€ëŠ” ì‹œì‘ í˜ì´ì§€ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.")
            continue

        return start_page, end_page


def scroll_page(driver, scroll_count=10, delay_range=(1.0, 2.0)):
    """í˜ì´ì§€ ì•„ë˜ë¡œ ì—¬ëŸ¬ ë²ˆ ìŠ¤í¬ë¡¤í•´ì„œ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë” ë¶ˆëŸ¬ì˜¤ê¸°"""
    body = driver.find_element(By.TAG_NAME, "body")

    for i in range(scroll_count):
        body.send_keys(Keys.END)
        time.sleep(random.uniform(*delay_range))


# ===================== ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„: smartstore ìµœì¢… URL ì–»ê¸° =====================
def resolve_smartstore_urls_by_click(driver, link_element, base_kind, is_brand_catalog):
    """
    ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ì—ì„œ ìƒí’ˆ <a>ë¥¼ í´ë¦­í•´ì„œ ìƒˆ íƒ­/ì°½ìœ¼ë¡œ ì—° ë‹¤ìŒ,
    - smartstore / brandstore ìƒí’ˆìœ¼ë¡œ ë°”ë¡œ ê°€ëŠ” ê²½ìš°:
        â†’ í•´ë‹¹ ìŠ¤í† ì–´ì˜ 'ì „ì²´ìƒí’ˆ' í˜ì´ì§€ì—ì„œ BEST ìƒí’ˆë“¤ì„ ìˆ˜ì§‘
    - catalog í˜ì´ì§€ë¡œ ê°€ëŠ” ê²½ìš°:
        â†’ catalog ì•ˆì˜ smartstore/brandstore ë“¤ì„ ëŒë©° ë™ì¼í•˜ê²Œ BEST ìˆ˜ì§‘
    ë°˜í™˜: BEST ìƒí’ˆ record ë¦¬ìŠ¤íŠ¸
    """
    # ğŸ”’ 0) 19ê¸ˆ(ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ) ìƒí’ˆì´ë©´ ì•„ì˜ˆ í´ë¦­ ì•ˆ í•¨
    if is_adult_product_element(link_element):
        try:
            title = (link_element.get_attribute("title") or link_element.text or "").strip()
        except Exception:
            title = ""
        print(f"[SKIP] ì²­ì†Œë…„ ìœ í•´ìƒí’ˆ(19ê¸ˆ)ì´ë¼ í´ë¦­í•˜ì§€ ì•ŠìŒ: {title}")
        return []
    
        # ğŸ”’ 0-1) ì œì™¸ ëª°(Gë§ˆì¼“, ì¿ íŒ¡, 11ë²ˆê°€ ë“±)ì´ë©´ ì•„ì˜ˆ í´ë¦­ ì•ˆ í•¨
    if is_skip_mall_for_link(link_element):
        # ë¡œê·¸ëŠ” is_skip_mall_for_link ì•ˆì—ì„œ ì¶œë ¥ë¨
        return []
    
    main_handle = driver.current_window_handle
    handles_before = driver.window_handles

    # ì‹¤ì œ í´ë¦­ìœ¼ë¡œ ìƒˆ íƒ­/ì°½ ì—´ê¸°
    driver.execute_script("arguments[0].click();", link_element)
    time.sleep(random.uniform(*CLICK_DELAY_RANGE))

    handles_after = driver.window_handles
    new_handles = [h for h in handles_after if h not in handles_before]
    if new_handles:
        product_handle = new_handles[0]
    else:
        # ìƒˆ íƒ­ì´ ì•ˆ ëœ¨ê³  í˜„ì¬ íƒ­ì´ ë°”ë€Œì—ˆì„ ê°€ëŠ¥ì„± ë°©ì–´
        product_handle = main_handle

    driver.switch_to.window(product_handle)

        # 2) ğŸ” íƒ­ ì „í™˜ ì§í›„, ìº¡ì±  í˜ì´ì§€ì¸ì§€ ë¨¼ì € í™•ì¸
    if not handle_captcha_if_needed(driver):
        # ìº¡ì± ë¥¼ í•´ê²° ëª» í–ˆê±°ë‚˜ ê³„ì† ë‚¨ì•„ ìˆìœ¼ë©´ ì´ ë§í¬ëŠ” ìŠ¤í‚µ
        if product_handle != main_handle:
            driver.close()
            driver.switch_to.window(main_handle)
        return []

    best_records = []

    try:
        final_url = wait_until_redirect_done(driver)


        # 1) smartstore ë¡œ ë°”ë¡œ ê°„ ê²½ìš° â†’ ê¸°ì¡´ ë¡œì§ (ì „ì²´ìƒí’ˆ + BEST)
        if final_url.startswith("https://smartstore.naver.com"):
            best_records.extend(
                collect_best_from_current_store(driver, base_kind, is_brand_catalog)
            )

        # 2) brandstore ë¡œ ë°”ë¡œ ê°„ ê²½ìš° â†’ ë°©ê¸ˆ ë§Œë“  brandstore ì „ìš© í•¨ìˆ˜ ì‚¬ìš©
        elif final_url.startswith("https://brand.naver.com"):
            best_records.extend(
                collect_best_from_current_store(driver, base_kind, is_brand_catalog)
            )

        # 3) catalog í˜ì´ì§€ì— ë„ì°©í•œ ê²½ìš° â†’ ê¸°ì¡´ ë¡œì§ ìœ ì§€
        elif "search.shopping.naver.com/catalog" in final_url:
            best_records.extend(
                find_smartstores_in_catalog_page(driver, base_kind, is_brand_catalog)
            )

        # 4) ê·¸ ì™¸ ë„ë©”ì¸ì€ ëŒ€ìƒ ì•„ë‹˜
        else:
            print("[INFO] smartstore/brandstore/catalogê°€ ì•„ë‹Œ ë§í¬ë¼ ê±´ë„ˆëœë‹ˆë‹¤.")

    finally:
        if product_handle != main_handle:
            driver.close()
            driver.switch_to.window(main_handle)

    return best_records



# =============================================================================


def go_to_all_products_if_exists(driver):
    """
    í˜„ì¬ íƒ­ì´ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ í˜ì´ì§€ë¼ê³  ê°€ì •í•˜ê³ :
    1) 'ë”ë³´ê¸°' ë²„íŠ¼ì´ ë³´ì´ë©´ ë¨¼ì € í´ë¦­
    2) 'ì „ì²´ìƒí’ˆ' ë©”ë‰´ë¥¼ ì°¾ìœ¼ë©´ í´ë¦­
    3) ì „ì²´ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™í•œ ë’¤, ì‚¬ìš©ìê°€ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´
       BESTê°€ ë¶™ì€ ìƒí’ˆë“¤ì˜ ìƒí’ˆí˜ì´ì§€ URL ëª©ë¡ì„ ë¦¬í„´
    - 'ì „ì²´ìƒí’ˆ'ì´ ì•„ì˜ˆ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë¦¬í„´
    """
    best_urls = []
    try:
        wait = WebDriverWait(driver, 5)

        # 1) 'ë”ë³´ê¸°' ë²„íŠ¼ ìˆìœ¼ë©´ í´ë¦­ (ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë„˜ì–´ê°)
        try:
            more_btn = wait.until(
                EC.visibility_of_element_located(
                    (By.XPATH, '//button[contains(normalize-space(.), "ë”ë³´ê¸°")]')
                )
            )
            try:
                driver.execute_script("arguments[0].click();", more_btn)
            except Exception:
                more_btn.click()
            time.sleep(random.uniform(*CLICK_DELAY_RANGE))
        except Exception:
            # ë”ë³´ê¸°ê°€ ì—†ëŠ” ê²½ìš° / ì•ˆ ë³´ì´ëŠ” ê²½ìš°
            pass

        # 2) 'ì „ì²´ìƒí’ˆ' ë§í¬ ì°¾ê¸° (data-name ë˜ëŠ” í…ìŠ¤íŠ¸ë¡œ ê²€ìƒ‰)
        try:
            all_link = driver.find_element(
                By.XPATH,
                '//a[@data-name="ì „ì²´ìƒí’ˆ" or contains(normalize-space(.), "ì „ì²´ìƒí’ˆ")]'
            )
        except Exception:
            print("[INFO] 'ì „ì²´ìƒí’ˆ' ë©”ë‰´ê°€ ì—†ëŠ” ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ì…ë‹ˆë‹¤. ê·¸ëƒ¥ ë„˜ì–´ê°‘ë‹ˆë‹¤.")
            return []

        # 3) 'ì „ì²´ìƒí’ˆ' í´ë¦­
        try:
            driver.execute_script("arguments[0].click();", all_link)
        except Exception:
            all_link.click()

        print("[INFO] 'ì „ì²´ìƒí’ˆ' ë©”ë‰´ í´ë¦­ ì™„ë£Œ. í˜ì´ì§€ í™•ì¸ í›„ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ BEST ìƒí’ˆì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.")
        time.sleep(random.uniform(*CLICK_DELAY_RANGE))  # í•„ìš”í•˜ë©´ 2~5ì´ˆ ì‚¬ì´ë¡œ ì¡°ì ˆ



    except Exception as e:
        print(f"[ê²½ê³ ] ì „ì²´ìƒí’ˆ / BEST ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return []

    return best_urls

def wait_until_redirect_done(driver, max_wait=10):
    """
    cr.shopping.naver.com/adcr ê°™ì€ ì¤‘ê°„ URLì—ì„œ
    ì‹¤ì œ ëª©ì ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê³  ìµœì¢… URL ë°˜í™˜
    """
    last_url = None
    for _ in range(max_wait * 2):  # 0.5ì´ˆ * 20 = ìµœëŒ€ 10ì´ˆ
        cur = driver.current_url
        # ì•„ì§ adcr / cr.shopping ë‹¨ê³„ë©´ ê³„ì† ëŒ€ê¸°
        if "cr.shopping.naver.com" in cur:
            last_url = cur
        else:
            return cur
        time.sleep(random.uniform(*CLICK_DELAY_RANGE))
    # íƒ€ì„ì•„ì›ƒì´ë©´ í˜„ì¬ ì£¼ì†Œ ë°˜í™˜
    return driver.current_url
def find_smartstores_in_catalog_page(driver, base_kind, is_brand_catalog, max_malls=50):
    """
    ì¹´íƒˆë¡œê·¸ í˜ì´ì§€ì˜ íŒë§¤ì²˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ì²˜ìŒë¶€í„° ëê¹Œì§€ ìˆœíšŒí•˜ë©°,
    ì˜¤í”ˆë§ˆì¼“(Gë§ˆì¼“, ì˜¥ì…˜ ë“±)ì„ ì œì™¸í•œ ëª¨ë“  'ë„¤ì´ë²„ ë§í¬(ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´/ë¸Œëœë“œìŠ¤í† ì–´)'ë¥¼ ë°©ë¬¸í•©ë‹ˆë‹¤.
    StaleElement ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ë§¤ë²ˆ ìš”ì†Œë¥¼ ë‹¤ì‹œ ì°¾ìŠµë‹ˆë‹¤.
    """
    catalog_handle = driver.current_window_handle
    results = []

    # 1. ì „ì²´ í–‰(Row) ê°œìˆ˜ë¥¼ ë¨¼ì € íŒŒì•…
    try:
        initial_rows = driver.find_elements(By.CSS_SELECTOR, 'tbody tr')
        total_count = len(initial_rows)
    except Exception:
        print("[INFO] íŒë§¤ì²˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return []
    
    print(f"[INFO] íŒë§¤ì²˜ ë¦¬ìŠ¤íŠ¸ ì´ {total_count}ê°œ ë°œê²¬. ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.")

    # 2. ì¸ë±ìŠ¤(i)ë¡œ ì ‘ê·¼í•˜ì—¬ í•˜ë‚˜ì”© ì²˜ë¦¬ (ì¤‘ê°„ì— ëŠê¹€ ë°©ì§€)
    for i in range(total_count):
        # ë„ˆë¬´ ë§ì´ ìˆ˜ì§‘í•˜ë©´ ì˜¤ë˜ ê±¸ë¦¬ë¯€ë¡œ ì œí•œ (í•„ìš”ì‹œ max_malls ìˆ«ì ì¡°ì ˆ)
        if i >= max_malls:
            print(f"[INFO] ìµœëŒ€ ë°©ë¬¸ ìˆ˜({max_malls}) ë„ë‹¬ë¡œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
            break

        try:
            # â˜… ì¤‘ìš”: íƒ­ì„ ê°”ë‹¤ì˜¤ë©´ DOMì´ ë¶ˆì•ˆì •í•´ì§€ë¯€ë¡œ ë§¤ë²ˆ ë‹¤ì‹œ ì°¾ìŠµë‹ˆë‹¤.
            current_rows = driver.find_elements(By.CSS_SELECTOR, 'tbody tr')
            if i >= len(current_rows):
                break # ë¦¬ìŠ¤íŠ¸ê°€ ì¤„ì–´ë“¤ì—ˆê±°ë‚˜ ë³€ê²½ëœ ê²½ìš° ì¤‘ë‹¨
            
            row = current_rows[i]

            # --- ì—¬ê¸°ì„œë¶€í„° ê¸°ì¡´ í•„í„°ë§ ë¡œì§ ---
            try:
                # ëª° ë§í¬ ì°¾ê¸°
                mall_link = row.find_element(By.CSS_SELECTOR, 'a[class^="productByMall_mall__"]')
                
                # ëª° ì´ë¦„ í™•ì¸ (ì´ë¯¸ì§€ alt ë˜ëŠ” í…ìŠ¤íŠ¸)
                mall_name = ""
                try:
                    img = mall_link.find_element(By.TAG_NAME, "img")
                    mall_name = img.get_attribute("alt").strip()
                except Exception:
                    mall_name = mall_link.text.strip()

                # ì˜¤í”ˆë§ˆì¼“ í•„í„°ë§ (Gë§ˆì¼“, ì˜¥ì…˜, ì¿ íŒ¡ ë“± ìŠ¤í‚µ)
                if any(skip_mall in mall_name for skip_mall in SKIP_MALL_ALTS):
                    # print(f"   Pass: {mall_name}") # ë„ˆë¬´ ì‹œë„ëŸ¬ìš°ë©´ ì£¼ì„ ì²˜ë¦¬
                    continue
                
                print(f"[{i+1}/{total_count}] ë°©ë¬¸ ì‹œë„: {mall_name}")

                # í´ë¦­í•˜ì—¬ ìƒˆ íƒ­ ì—´ê¸°
                driver.execute_script("arguments[0].click();", mall_link)
                time.sleep(random.uniform(*CLICK_DELAY_RANGE))

                # íƒ­ ì „í™˜
                handles_after = driver.window_handles
                new_handles = [h for h in handles_after if h != catalog_handle]

                if new_handles:
                    mall_handle = new_handles[-1]
                    driver.switch_to.window(mall_handle)

                    try:
                        # URL í™•ì¸
                        final_url = wait_until_redirect_done(driver)
                        
                        if final_url.startswith("https://smartstore.naver.com") or final_url.startswith("https://brand.naver.com"):
                            # print(f"   â†’ ìˆ˜ì§‘ ì‹œì‘ ({mall_name})")
                            store_records = collect_best_from_current_store(driver, base_kind, is_brand_catalog)
                            results.extend(store_records)
                        else:
                            # print(f"   â†’ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì•„ë‹˜ ({final_url})")
                            pass
                    
                    except Exception as e:
                        print(f"[ERROR] íƒ­ ë‚´ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

                    finally:
                        # íƒ­ ë‹«ê³  ì¹´íƒˆë¡œê·¸ í˜ì´ì§€ë¡œ ë³µê·€ (í•„ìˆ˜)
                        if driver.current_window_handle != catalog_handle:
                            driver.close()
                        driver.switch_to.window(catalog_handle)
                        # ë³µê·€ í›„ ì ì‹œ ëŒ€ê¸° (í˜ì´ì§€ ì•ˆì •í™”)
                        time.sleep(random.uniform(*CLICK_DELAY_RANGE))

            except Exception as inner_e:
                # ë§í¬ë¥¼ ëª» ì°¾ê±°ë‚˜ í•˜ëŠ” ì†Œì†Œí•œ ì—ëŸ¬ëŠ” ë¬´ì‹œí•˜ê³  ë‹¤ìŒ ë£¨í”„ë¡œ
                continue

        except Exception as e:
            print(f"[ERROR] íŒë§¤ì²˜ ìˆœíšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            continue

    return results

def collect_naver_links(driver, include_brand_catalog=True,include_ads=True, csv_filename_for_realtime=None):
    records = []

    # 0) ì´ í˜ì´ì§€ì—ì„œ "ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸"ë¼ê³  ì°íŒ ëª¨ë“  ë§í¬ href ë¨¼ì € ëª¨ìœ¼ê¸°
    brand_hrefs = set()
    try:
        # em ì•ˆì— "ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸" í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ëª¨ë“  em ì°¾ê¸°
        em_elems = driver.find_elements(
            By.XPATH,
            '//em[contains(normalize-space(.), "ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸")]'
        )
        for em in em_elems:
            try:
                # ê·¸ emì´ ë“¤ì–´ìˆëŠ” ê°€ì¥ ê°€ê¹Œìš´ a íƒœê·¸ë¡œ ì˜¬ë¼ê°€ê¸°
                a_tag = em.find_element(By.XPATH, './ancestor::a[1]')
                href_bc = a_tag.get_attribute("href")
                if href_bc:
                    brand_hrefs.add(href_bc)
            except Exception:
                continue
    except Exception:
        # ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ì˜ì—­ì„ ëª» ì°¾ë”ë¼ë„ ì „ì²´ í¬ë¡¤ë§ì€ ê³„ì†
        pass

     # 1) ê´‘ê³  ì˜ì—­
    if include_ads:
        ad_elements = driver.find_elements(
            By.CSS_SELECTOR,
            'div[class^="adProduct_title__"] a[class^="adProduct_link__"]'
        )
        for el in ad_elements:
            if is_preorder_product_link(el):
                continue
            href = el.get_attribute("href")
            text = el.text.strip()

            if not href:
                continue
            if "javascript:" in href.lower():
                continue

            # ë¸Œëœë“œ ì—¬ë¶€ íŒì •
            is_brand = ("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸" in text) or (href in brand_hrefs)

            if is_brand and not include_brand_catalog:
                continue

            best_records = resolve_smartstore_urls_by_click(
                driver,
                el,
                base_kind="ad",          # â† ì´ê²Œ ì—‘ì…€ì— 'ad'ë¡œ ì €ì¥ë˜ëŠ” ê´‘ê³  êµ¬ë¶„ì
                is_brand_catalog=is_brand,
            )
            records.extend(best_records)

            if csv_filename_for_realtime and best_records:
                append_to_csv_incremental(best_records, csv_filename_for_realtime)


    # 2) ì¼ë°˜ ìƒí’ˆ ì˜ì—­
    product_elements = driver.find_elements(
        By.CSS_SELECTOR,
        'div[class^="product_title__"] a[class^="product_link__"]'
    )
    for el in product_elements:
        if is_preorder_product_link(el):
            continue
        
        href = el.get_attribute("href")
        text = el.text.strip()

        if not href:
            continue
        if "javascript:" in href.lower():
            continue

        is_brand = ("ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸" in text) or (href in brand_hrefs)

        if is_brand and not include_brand_catalog:
            continue

        best_records = resolve_smartstore_urls_by_click(
            driver,
            el,
            base_kind="product",
            is_brand_catalog=is_brand,
        )
        records.extend(best_records)

        # â˜… ì¼ë°˜ ìƒí’ˆë„ ì‹¤ì‹œê°„ CSV ì €ì¥
        if csv_filename_for_realtime and best_records:
            append_to_csv_incremental(best_records, csv_filename_for_realtime)

    # (href + kind) ê¸°ì¤€ ì¤‘ë³µ ì œê±°
    unique = {}
    for r in records:
        key = (r["href"], r["kind"])
        unique[key] = r

    return list(unique.values())

def save_to_excel(records, filename):
    """ìˆ˜ì§‘í•œ ë§í¬ë¥¼ ì—‘ì…€ íŒŒì¼ë¡œ ì €ì¥"""
    if not records:
        print("ìˆ˜ì§‘ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ì„ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    df = pd.DataFrame(records)
    df.to_excel(filename, index=False)
    print(f"ì—‘ì…€ ì €ì¥ ì™„ë£Œ â†’ {filename}")
    print(f"ì´ ë§í¬ ê°œìˆ˜: {len(df)}")


def save_to_csv(records, filename):
    """ìˆ˜ì§‘í•œ ë§í¬ë¥¼ CSV íŒŒì¼ë¡œ ì €ì¥"""
    if not records:
        print("ìˆ˜ì§‘ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. CSVë¥¼ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    df = pd.DataFrame(records)
    df.to_csv(filename, index=False, encoding="utf-8-sig")
    print(f"CSV ì €ì¥ ì™„ë£Œ â†’ {filename}")
    print(f"ì´ ë§í¬ ê°œìˆ˜: {len(df)}")


def wait_for_pagination(driver, timeout=10):
    """í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ì´ DOMì— ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ ëŒ€ê¸°"""
    try:
        WebDriverWait(driver, timeout).until(
            EC.presence_of_element_located(
                (By.CSS_SELECTOR, 'div[class^="pagination_num__"]')
            )
        )
    except Exception:
        print("[ê²½ê³ ] í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")


def go_to_page_smart_from_first(driver, target_page, wait_sec=1.0):
    """
    1í˜ì´ì§€ì—ì„œ ì‹œì‘í•œë‹¤ê³  ê°€ì •í•˜ê³ ,
    ë³´ì´ëŠ” í˜ì´ì§€ ë²ˆí˜¸ë“¤ ì¤‘ 'ê°€ì¥ í° ìˆ«ì' ë²„íŠ¼ì„ ê³„ì† ëˆŒëŸ¬ê°€ë©°
    target_pageì— ë„ë‹¬í•  ë•Œê¹Œì§€ ì í”„í•˜ëŠ” í•¨ìˆ˜.
    ì˜ˆ) 1 -> 10 -> 15 -> 20 -> ... -> 60
    """
    if target_page <= 1:
        return  # ì´ë¯¸ 1í˜ì´ì§€ë©´ ê°ˆ í•„ìš” ì—†ìŒ

    # í˜ì´ì§€ë„¤ì´ì…˜ì´ ë¡œë“œë  ë•Œê¹Œì§€ í•œ ë²ˆ ê¸°ë‹¤ë ¤ì¤Œ
    wait_for_pagination(driver)

    while True:
        cur = get_current_page(driver)
        if cur is None:
            print("[ê²½ê³ ] í˜„ì¬ í˜ì´ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return

        if cur == target_page:
            print(f"{target_page} í˜ì´ì§€ ë„ë‹¬")
            return

        if cur > target_page:
            print(f"[ê²½ê³ ] í˜„ì¬ í˜ì´ì§€({cur})ê°€ íƒ€ê²Ÿ({target_page})ë³´ë‹¤ í½ë‹ˆë‹¤. ì¤‘ë‹¨.")
            return

        # í˜„ì¬ ë³´ì´ëŠ” ìˆ«ì ë²„íŠ¼ë“¤ (pagination_num__ ì•ˆì—ì„œë§Œ ì°¾ê¸°)
        buttons = driver.find_elements(
            By.CSS_SELECTOR,
            'div[class^="pagination_num__"] a[class^="pagination_btn_page__"]'
        )
        nums = []
        for btn in buttons:
            txt = btn.text.strip()
            if txt.isdigit():
                nums.append(int(txt))

        if not nums:
            print("[ê²½ê³ ] í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return

        max_visible = max(nums)

        # 1) target_pageê°€ í˜„ì¬ ë³´ì´ëŠ” ë²ˆí˜¸ë“¤ ì•ˆì— ìˆìœ¼ë©´ â†’ ê·¸ ë²ˆí˜¸ë¥¼ í´ë¦­í•˜ê³  ì¢…ë£Œ
        if target_page in nums:
            target_str = str(target_page)
            for btn in buttons:
                if btn.text.strip() == target_str:
                    print(f"{target_page} í˜ì´ì§€ ë²„íŠ¼ í´ë¦­")
                    driver.execute_script("arguments[0].click();", btn)
                    time.sleep(random.uniform(*CLICK_DELAY_RANGE))
                    return

        # 2) ì•„ì§ í™”ë©´ì— ì•ˆ ë³´ì´ëŠ” ê²½ìš° â†’ ê°€ì¥ í° ë²ˆí˜¸(max_visible)ë¥¼ ëˆŒëŸ¬ì„œ ì•ìœ¼ë¡œ í¬ê²Œ ì í”„
        if max_visible < target_page:
            max_str = str(max_visible)
            print(f"íƒ€ê²Ÿ {target_page}ê°€ ì•„ì§ ì•ˆ ë³´ì„ â†’ {max_visible} í˜ì´ì§€ë¡œ ì í”„")
            for btn in buttons:
                if btn.text.strip() == max_str:
                    driver.execute_script("arguments[0].click();", btn)
                    time.sleep(random.uniform(*CLICK_DELAY_RANGE))
                    break
        else:
            # ì•ˆì „ ëª¨ë“œ (ë…¼ë¦¬ì ìœ¼ë¡œ ê±°ì˜ ì•ˆ ì˜¤ê² ì§€ë§Œ ë°©ì–´ìš©)
            bigger_or_equal = [n for n in nums if n >= target_page]
            if bigger_or_equal:
                click_page = min(bigger_or_equal)
            else:
                click_page = max_visible

            click_str = str(click_page)
            print(f"ì•ˆì „ ëª¨ë“œ: {click_page} í˜ì´ì§€ë¡œ ì´ë™")
            for btn in buttons:
                if btn.text.strip() == click_str:
                    driver.execute_script("arguments[0].click();", btn)
                    time.sleep(random.uniform(*CLICK_DELAY_RANGE))
                    break


def go_to_next_page(driver, wait_sec=1.0):
    """
    í˜„ì¬ í˜ì´ì§€ì—ì„œ 'ë‹¤ìŒ í˜ì´ì§€(ìˆ«ì+1)'ë¡œ ì´ë™.
    ìŠ¬ë¼ì´ë”© í˜ì´ì§€ë„¤ì´ì…˜ì—ì„œë„,
    pagination_num__ ì•ˆì—ì„œ active ê¸°ì¤€ìœ¼ë¡œ +1 ë²„íŠ¼ì„ ì°¾ì•„ì„œ í´ë¦­.
    """
    cur = get_current_page(driver)
    if cur is None:
        print("[ê²½ê³ ] í˜„ì¬ í˜ì´ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
        return

    target = cur + 1
    target_str = str(target)

    buttons = driver.find_elements(
        By.CSS_SELECTOR,
        'div[class^="pagination_num__"] a[class^="pagination_btn_page__"]'
    )
    for btn in buttons:
        if btn.text.strip() == target_str:
            print(f"{cur} -> {target} í˜ì´ì§€ ì´ë™")
            driver.execute_script("arguments[0].click();", btn)
            time.sleep(random.uniform(*CLICK_DELAY_RANGE))
            return

    print(f"[ê²½ê³ ] {target} í˜ì´ì§€ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ë§ˆì§€ë§‰ í˜ì´ì§€ì¼ ìˆ˜ ìˆìŒ)")


def get_current_page(driver):
    """
    í˜„ì¬ í™œì„± í˜ì´ì§€ ë²ˆí˜¸ ì½ê¸°
    - div.pagination_num__ ì•ˆì—ì„œ .active ìš”ì†Œë¥¼ ì°¾ê³ 
    - ê·¸ ì•ˆì˜ í…ìŠ¤íŠ¸ì—ì„œ ìˆ«ìë§Œ ë½‘ì•„ì„œ intë¡œ ë³€í™˜
    """
    try:
        active = driver.find_element(
            By.CSS_SELECTOR,
            'div[class^="pagination_num__"] .active'
        )
        text = active.text.strip()
        # ì˜ˆ: "í˜„ì¬ í˜ì´ì§€\n1" / "í˜„ì¬ í˜ì´ì§€1" â†’ ìˆ«ìë§Œ ì¶”ì¶œ
        digits = ''.join(ch for ch in text if ch.isdigit())
        if digits:
            return int(digits)
        return None
    except Exception:
        return None

def open_category_selector():
    global driver

    # driver ì—†ê±°ë‚˜ ì£½ì—ˆìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    if driver is None:
        driver = create_driver()
    else:
        try:
            _ = driver.current_url
        except WebDriverException:
            driver = create_driver()

    driver.get(START_URL)
    gui_log("[INFO] ë„¤ì´ë²„ ì‡¼í•‘ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤.")

    # í˜¹ì‹œ ìº¡ì±  ëœ¨ë©´ ì²˜ë¦¬
    try:
        handle_captcha_if_needed(driver)
    except Exception as e:
        gui_log(f"[WARN] ìº¡ì±  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    messagebox.showinfo(
        "ì¹´í…Œê³ ë¦¬ ì„ íƒ",
        "í¬ë¡¬ ì°½ì—ì„œ ì›í•˜ëŠ” ì¹´í…Œê³ ë¦¬/í•„í„°ë¥¼ ëª¨ë‘ ê³ ë¥¸ ë’¤,\n"
        "[ìˆ˜ì§‘í•˜ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”."
    )

def run_crawler(start_page, end_page, include_brand_catalog, forbidden_file_path,include_ads=True):
    """
    GUIì—ì„œ ë°›ì€ ì„¤ì •ê°’ìœ¼ë¡œ í¬ë¡¤ë§ ì‹¤í–‰.
    - driver: ì´ë¯¸ open_category_selector ì—ì„œ ì—´ë¦° ìƒíƒœë¼ê³  ê°€ì •.
    """
    global FORBIDDEN_KEYWORDS, VISITED_STORE_KEYS

    if driver is None:
        gui_log("[ERROR] driver ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € [ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")
        return

    # ê¸ˆì¹™ì–´ ë¡œë”©
    load_forbidden_keywords_from_path(forbidden_file_path)

    VISITED_STORE_KEYS = set()

    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    excel_filename = f"naver_links_{timestamp}.xlsx"
    csv_filename   = f"naver_links_{timestamp}.csv"
    all_records = []

    handle_captcha_if_needed(driver)

    gui_log(f">>> {start_page} í˜ì´ì§€ë¶€í„° {end_page} í˜ì´ì§€ê¹Œì§€ ìˆ˜ì§‘ ì‹œì‘")

    for page in range(start_page, end_page + 1):
        if STOP_REQUESTED:
            gui_log(f"[STOP] {page} í˜ì´ì§€ë¶€í„°ëŠ” ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
            break

        gui_log("=" * 60)
        gui_log(f"[{page} í˜ì´ì§€] ìˆ˜ì§‘ ì‹œì‘")

        if page == start_page:
            if page == 1:
                gui_log("1í˜ì´ì§€ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.")
            else:
                gui_log(f"1í˜ì´ì§€ì—ì„œ {page}í˜ì´ì§€ë¡œ ì í”„í•©ë‹ˆë‹¤.")
                go_to_page_smart_from_first(driver, page)
        else:
            go_to_next_page(driver)

        scroll_page(driver, SCROLL_COUNT, SCROLL_DELAY_RANGE)

        new_links = collect_naver_links(
            driver,
            include_brand_catalog,
            include_ads=include_ads,
            csv_filename_for_realtime=csv_filename
        )
        gui_log(f"[{page} í˜ì´ì§€] ìƒˆë¡œ ìˆ˜ì§‘ëœ raw ë§í¬ ê°œìˆ˜: {len(new_links)}")

        merged = {}
        for r in all_records + new_links:
            key = (r["href"], r["kind"])
            merged[key] = r
        all_records = list(merged.values())

        save_to_excel(all_records, excel_filename)
        save_to_csv(all_records, csv_filename)
        gui_log(f"[{page} í˜ì´ì§€]ê¹Œì§€ ëˆ„ì  ë§í¬ ê°œìˆ˜: {len(all_records)}")

    gui_log("=== ìˆ˜ì§‘ ì¢…ë£Œ ===")

def apply_api_key():
    global client
    key = key_entry.get().strip()
    if not key:
        messagebox.showerror("ì—ëŸ¬", "API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return
    client = OpenAI(api_key=key)
    gui_log("[INFO] API Key ì„¤ì • ì™„ë£Œ")

def save_api_key_to_file(api_key: str):
    """API Keyë¥¼ í…ìŠ¤íŠ¸ íŒŒì¼ì— ì €ì¥ (ë‹¤ìŒ ì‹¤í–‰ ë•Œ ìë™ ì‚¬ìš©)"""
    try:
        with open(API_KEY_FILE, "w", encoding="utf-8") as f:
            f.write(api_key.strip())
        gui_log("[INFO] API Key ë¥¼ íŒŒì¼ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤. (ë‹¤ìŒ ì‹¤í–‰ ë•Œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.)")
    except Exception as e:
        gui_log(f"[WARN] API Key ì €ì¥ ì‹¤íŒ¨: {e}")


################################################################
# gui
################################################################


root = tk.Tk()
root.title("ë„¤ì´ë²„ ë² ìŠ¤íŠ¸ ìƒí’ˆ ë§í¬ ìˆ˜ì§‘ í”„ë¡œê·¸ë¨")

forbidden_path_var = tk.StringVar(value="")

# ì „ì²´ íŒ¨ë”©ìš© í”„ë ˆì„
main_frame = ttk.Frame(root, padding=10)
main_frame.pack(fill="both", expand=True)

# 1. ì‚¬ìš©ë²• ì„¤ëª…
usage_frame = ttk.LabelFrame(main_frame, text="ì‚¬ìš©ë²•")
usage_frame.pack(fill="x", pady=(0, 10))

usage_text = (
    "1. [ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ í¬ë¡¬ì—ì„œ ì›í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì§ì ‘ ê³ ë¦…ë‹ˆë‹¤.\n"
    "2. ìˆ˜ì§‘í•  í˜ì´ì§€ ë²ˆí˜¸ë¥¼ 'ëª‡ í˜ì´ì§€ë¶€í„° ~ ëª‡ í˜ì´ì§€ê¹Œì§€' ìˆ«ìë¡œ ì ìŠµë‹ˆë‹¤.\n"
    "3. í¬í•¨ ì—¬ë¶€ì™€ ì‹œê°„(í´ë¦­ ì†ë„)ì„ ì •í•©ë‹ˆë‹¤.\n"
    "4. ê¸ˆì¹™ì–´ íŒŒì¼ì„ ì„ íƒí•©ë‹ˆë‹¤.\n"
    "5. [ìˆ˜ì§‘í•˜ê¸°] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í”„ë¡œê·¸ë¨ì´ ìë™ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ëª¨ìë‹ˆë‹¤."
)
usage_label = ttk.Label(usage_frame, text=usage_text, justify="left")
usage_label.pack(anchor="w")

# --- â­ 7. API Key ì„¤ì • ì„¹ì…˜ ì¶”ê°€ ---
api_key_frame = ttk.LabelFrame(main_frame, text="API Key ì…ë ¥")
api_key_frame.pack(fill="x", pady=(0, 10))

# Key ì…ë ¥
key_label = ttk.Label(api_key_frame, text="Key ì…ë ¥:")
key_label.grid(row=1, column=0, padx=5, pady=5, sticky="e")

key_entry = ttk.Entry(api_key_frame, width=50)
key_entry.grid(row=1, column=1, padx=5, pady=5, sticky="ew")

# 2. ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ
category_frame = ttk.LabelFrame(main_frame, text="ì¹´í…Œê³ ë¦¬ í•„í„° ì§ì ‘ ì„ íƒ")
category_frame.pack(fill="x", pady=(0, 10))

def select_forbidden_file():
    global forbidden_path_var
    path = filedialog.askopenfilename(
        title="ê¸ˆì¹™ì–´ í…ìŠ¤íŠ¸ íŒŒì¼ ì„ íƒ",
        filetypes=[("Text files", "*.txt"), ("All files", "*.*")]
    )
    if path:
        forbidden_path_var.set(path)
        path_label.config(text=path)
        gui_log(f"[INFO] ê¸ˆì¹™ì–´ íŒŒì¼ ì„ íƒ: {path}")
    else:
        forbidden_path_var.set("")
        path_label.config(text="")
        gui_log("[INFO] ê¸ˆì¹™ì–´ íŒŒì¼ ì„ íƒ ì·¨ì†Œ")

category_button = ttk.Button(
    category_frame,
    text="ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ (í¬ë¡¬ ì—´ê¸°)",
    command=open_category_selector
)
category_button.pack(anchor="w", pady=5)

# 3. ìˆ˜ì§‘í•  í˜ì´ì§€ ë²”ìœ„
page_frame = ttk.LabelFrame(main_frame, text="ìˆ˜ì§‘í•  í˜ì´ì§€ ì„ íƒ")
page_frame.pack(fill="x", pady=(0, 10))

start_page_var = tk.IntVar(value=1)
end_page_var = tk.IntVar(value=5)

start_label = ttk.Label(page_frame, text="ì‹œì‘ í˜ì´ì§€:")
start_label.grid(row=0, column=0, padx=(5, 2), pady=5, sticky="e")
start_entry = ttk.Entry(page_frame, textvariable=start_page_var, width=10)
start_entry.grid(row=0, column=1, padx=(0, 10), pady=5, sticky="w")
start_suffix = ttk.Label(page_frame, text="í˜ì´ì§€ë¶€í„°")
start_suffix.grid(row=0, column=2, padx=(0, 5), pady=5, sticky="w")

end_label = ttk.Label(page_frame, text="ë í˜ì´ì§€:")
end_label.grid(row=1, column=0, padx=(5, 2), pady=5, sticky="e")
end_entry = ttk.Entry(page_frame, textvariable=end_page_var, width=10)
end_entry.grid(row=1, column=1, padx=(0, 10), pady=5, sticky="w")
end_suffix = ttk.Label(page_frame, text="í˜ì´ì§€ê¹Œì§€")
end_suffix.grid(row=1, column=2, padx=(0, 5), pady=5, sticky="w")

# 4. ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ë§í¬ ì˜µì…˜ (ë¼ë””ì˜¤ ë²„íŠ¼)
link_frame = ttk.LabelFrame(main_frame, text="ë¸Œëœë“œ ì¹´íƒˆë¡œê·¸ ë§í¬ ì˜µì…˜")
link_frame.pack(fill="x", pady=(0, 10))

link_option_var = tk.StringVar(value="include")

include_radio = ttk.Radiobutton(
    link_frame, text="ë§í¬ í¬í•¨",
    variable=link_option_var, value="include"
)
include_radio.pack(anchor="w", padx=5, pady=2)

exclude_radio = ttk.Radiobutton(
    link_frame, text="ë§í¬ ë¶ˆí¬í•¨",
    variable=link_option_var, value="exclude"
)
exclude_radio.pack(anchor="w", padx=5, pady=2)


# 4-1. ê´‘ê³  ë§í¬ ì˜µì…˜ (ë¼ë””ì˜¤ ë²„íŠ¼)
ad_frame = ttk.LabelFrame(main_frame, text="ê´‘ê³  ë§í¬ ì˜µì…˜")
ad_frame.pack(fill="x", pady=(0, 10))

ad_option_var = tk.StringVar(value="include")  # ê¸°ë³¸ê°’: í¬í•¨

ad_include_radio = ttk.Radiobutton(
    ad_frame, text="ê´‘ê³  í¬í•¨",
    variable=ad_option_var, value="include"
)
ad_include_radio.pack(anchor="w", padx=5, pady=2)

ad_exclude_radio = ttk.Radiobutton(
    ad_frame, text="ê´‘ê³  ë¶ˆí¬í•¨",
    variable=ad_option_var, value="exclude"
)
ad_exclude_radio.pack(anchor="w", padx=5, pady=2)
# 5. ì‹œê°„ 
time_frame = ttk.LabelFrame(main_frame, text="í´ë¦­ ì‹œê°„ ì„¤ì •")
time_frame.pack(fill="x", pady=(0, 10))

min_click_sec_var = tk.IntVar(value=2)
max_click_sec_var = tk.IntVar(value=5)
work_min_var = tk.IntVar(value=30)
rest_min_var = tk.IntVar(value=10)

# í´ë¦­ ê°„ê²©
click_label1 = ttk.Label(time_frame, text="í´ë¦­ ê°„ê²©:")
click_label1.grid(row=0, column=0, padx=(5, 2), pady=5, sticky="e")

min_click_entry = ttk.Entry(time_frame, textvariable=min_click_sec_var, width=5)
min_click_entry.grid(row=0, column=1, padx=(0, 2), pady=5, sticky="w")

click_mid_label = ttk.Label(time_frame, text="ì´ˆ ì™€")
click_mid_label.grid(row=0, column=2, padx=(0, 2), pady=5, sticky="w")

max_click_entry = ttk.Entry(time_frame, textvariable=max_click_sec_var, width=5)
max_click_entry.grid(row=0, column=3, padx=(0, 2), pady=5, sticky="w")

click_suffix = ttk.Label(time_frame, text="ì´ˆ ì‚¬ì´ì— í•œ ë²ˆ í´ë¦­")
click_suffix.grid(row=0, column=4, padx=(0, 5), pady=5, sticky="w")

# 6. ê¸ˆì¹™ì–´ íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜
forbidden_frame = ttk.LabelFrame(main_frame, text="ê¸ˆì¹™ì–´ íŒŒì¼ ì„ íƒ (ì„ íƒ ì‚¬í•­, ; ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.)")
forbidden_frame.pack(fill="x", pady=(0, 10))

command=select_forbidden_file 

file_button = ttk.Button(
    forbidden_frame,
    text="ê¸ˆì¹™ì–´ íŒŒì¼ ì„ íƒ (*.txt)",
    command=select_forbidden_file 
)
file_button.pack(anchor="w", padx=5, pady=5)

path_label = ttk.Label(
    forbidden_frame,

    wraplength=400,
    foreground="blue"
)
path_label.pack(anchor="w", padx=5, pady=(0, 5))



def load_saved_api_key():
    """ì´ì „ì— ì €ì¥í•œ API Keyê°€ ìˆìœ¼ë©´ ì½ì–´ì„œ ë¬¸ìì—´ë¡œ ë°˜í™˜"""
    if os.path.exists(API_KEY_FILE):
        try:
            with open(API_KEY_FILE, "r", encoding="utf-8") as f:
                return f.read().strip()
        except Exception:
            return ""
    return ""


# ğŸ”¹ key_entry ë§Œë“  ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€
saved_key = load_saved_api_key()
if saved_key:
    key_entry.insert(0, saved_key)  # ì €ì¥ëœ í‚¤ë¥¼ ìë™ìœ¼ë¡œ ì…ë ¥ì¹¸ì— ë„£ì–´ì¤Œ



# 7. ì‹¤í–‰ / ì¤‘ë‹¨ ë²„íŠ¼
button_frame = ttk.Frame(main_frame)
button_frame.pack(fill="x", pady=(10, 0))

# â­ 'Pink.TButton' ìŠ¤íƒ€ì¼ ì ìš©!
start_button = tk.Button(button_frame, 
                          text="ìˆ˜ì§‘í•˜ê¸°", 
                          command=start_collect,
                          bg='blue',  
                          fg='white')
start_button.pack(side="left", padx=(0, 10))

stop_button = ttk.Button(button_frame, text="ì¤‘ë‹¨í•˜ê¸°", command=stop_collect)
stop_button.pack(side="left")




# --- â­ 8. ë¡œê·¸ ì°½ ì„¹ì…˜ ì¶”ê°€ ---
log_frame = ttk.LabelFrame(main_frame, text="â‘¥ ë¡œê·¸ ì°½")
log_frame.pack(fill="both", expand=True, pady=(10, 0)) # fill="both"ì™€ expand=Trueë¡œ ê³µê°„ì„ ì±„ì›ë‹ˆë‹¤.

# ë¡œê·¸ ì¶œë ¥ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ìœ„ì ¯
log_text = tk.Text(log_frame, wrap=tk.WORD, height=10, state='normal')
log_text.pack(side="left", fill="both", expand=True, padx=5, pady=5)

# ìŠ¤í¬ë¡¤ë°” ì¶”ê°€
log_scrollbar = ttk.Scrollbar(log_frame, command=log_text.yview)
log_scrollbar.pack(side="right", fill="y")
log_text.config(yscrollcommand=log_scrollbar.set)

# --- ë¡œê·¸ ì°½ ì„¹ì…˜ ë ---


if __name__ == "__main__":
    root.mainloop()
